<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Roteiro de Viagem ‚Äî GPS, Rota & POIs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            travel: {50:'#f0f9ff',100:'#e0f2fe',200:'#bae6fd',300:'#7dd3fc',400:'#38bdf8',500:'#0ea5e9',600:'#0284c7',700:'#0369a1',800:'#075985',900:'#0c4a6e'}
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Roboto', sans-serif; }
    #map { height: 440px; width: 100%; border-radius: 16px; }
    .toast{position:fixed;bottom:20px;right:20px;padding:12px 24px;border-radius:8px;color:#fff;background:#0ea5e9;box-shadow:0 6px 20px rgba(0,0,0,.15);z-index:10000;transition:opacity .3s}
    .toast.error{background:#dc2626}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:9999px;background:#e0f2fe;color:#075985;font-weight:700}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem .9rem;border-radius:.75rem;font-weight:700}
    .btn-primary{background:#0284c7;color:#fff}
    .btn-ghost{background:#e2e8f0;color:#0f172a}
    .btn-danger{background:#ef4444;color:#fff}
    #start-trip.tracking{animation:pulse 2s infinite}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    .category-badge{display:inline-block;padding:.25rem .5rem;border-radius:9999px;font-size:.75rem;font-weight:500}
    .place-item{transition:all .2s}
    .place-item:hover{transform:translateY(-2px);box-shadow:0 10px 15px -3px rgba(0,0,0,.1)}
    /* HUD */
    .gps-hud{position:absolute;left:12px;bottom:12px;z-index:1002;background:rgba(255,255,255,.96);backdrop-filter:saturate(160%) blur(8px);border:1px solid rgba(2,132,199,.15);border-radius:12px;padding:12px 14px;min-width:280px;box-shadow:0 8px 24px rgba(2,132,199,.15)}
    .hud-title{font-weight:800;color:#0369a1;margin-bottom:6px;display:flex;align-items:center;gap:8px}
    .hud-row{font-size:14px;color:#0c4a6e}
    .hud-actions{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    /* Toolbar FS */
    .fs-toolbar{position:absolute;top:12px;left:12px;z-index:1003;display:flex;gap:8px;flex-wrap:wrap}
    .fs-container:fullscreen #map{border-radius:0;height:100dvh}
    /* Filtro POIs */
    .poi-toolbar{position:absolute;top:12px;right:12px;z-index:1003;display:flex;flex-wrap:wrap;gap:6px;background:rgba(255,255,255,.96);border:1px solid rgba(2,132,199,.15);border-radius:12px;padding:8px}
    .poi-chip{padding:6px 10px;border-radius:9999px;background:#f1f5f9;color:#0f172a;font-weight:700;cursor:pointer}
    .poi-chip.active{background:#0284c7;color:#fff}
    .iw-btn{display:inline-block;background:#0ea5e9;color:#fff;padding:6px 10px;border-radius:8px;font-weight:700;text-decoration:none}
    .iw-btn.alt{background:#10b981}
    .iw-btn.gray{background:#64748b}
  </style>
</head>
<body class="bg-travel-50">
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-travel-700">Roteiro de Viagem</h1>
      <nav class="flex gap-4">
        <a href="fotos.html" class="text-travel-600 font-medium">Fotos</a>
        <a href="index.html" class="text-gray-500">Sair</a>
      </nav>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6 max-w-4xl">
    <!-- Config ve√≠culo -->
    <div class="bg-white p-4 mb-6 shadow-md rounded-xl">
      <h2 class="text-lg font-semibold text-travel-800 mb-3">Configura√ß√µes do Ve√≠culo</h2>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Consumo (km/l)</label>
          <input id="fuel-efficiency" type="number" min="1" value="10" class="w-full p-3 border border-gray-200 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Pre√ßo do Combust√≠vel (R$/l)</label>
          <input id="fuel-price" type="number" min="0.1" step="0.01" value="5.50" class="w-full p-3 border border-gray-200 rounded-lg">
        </div>
      </div>
    </div>

    <!-- Mapa -->
    <div id="map-card" class="bg-white p-4 mb-6 shadow-md rounded-xl relative fs-container">
      <h2 class="text-lg font-semibold text-travel-800 mb-3">Mapa da Viagem</h2>
      <div id="map"></div>

      <!-- Toolbar Fullscreen & GPS -->
      <div id="fs-toolbar" class="fs-toolbar" style="display:none">
        <button id="btn-exit-fs" class="btn btn-ghost">Sair Tela Cheia</button>
        <button id="btn-follow" class="btn btn-ghost">Seguir: Ligado</button>
        <button id="btn-center" class="btn btn-ghost">Centralizar</button>
        <button id="btn-stop" class="btn btn-danger">Parar viagem</button>
      </div>

      <!-- Filtros POIs (ao longo da rota) -->
      <div id="poi-toolbar" class="poi-toolbar" style="display:none">
        <span class="poi-chip" data-type="restaurant">Restaurantes</span>
        <span class="poi-chip" data-type="buffet">Buffet</span>
        <span class="poi-chip" data-type="lodging">Hotel</span>
        <span class="poi-chip" data-type="motel">Motel</span>
        <span class="poi-chip" data-type="tourist_attraction">Tur√≠stico</span>
        <span class="poi-chip" data-type="supermarket">Mercado</span>
        <span class="poi-chip" data-type="gas_station">Posto</span>
      </div>

      <!-- HUD -->
      <div id="gps-hud" class="gps-hud" style="display:none">
        <div class="hud-title">Navega√ß√£o <span class="chip" id="hud-chip">GPS</span></div>
        <div class="hud-row"><strong>Pr√≥xima parada:</strong> <span id="hud-next-name">‚Äî</span></div>
        <div class="hud-row"><strong>Dist√¢ncia:</strong> <span id="hud-next-dist">‚Äî</span> ‚Ä¢ <strong>ETA:</strong> <span id="hud-next-eta">‚Äî</span></div>
        <div class="hud-actions">
          <button id="btn-next-go" class="btn btn-primary">Ir para pr√≥xima</button>
          <button id="btn-skip-stop" class="btn btn-ghost">Pular parada</button>
          <button id="abort-temp" class="btn btn-danger" style="display:none">Desistir rota verde</button>
        </div>
      </div>

      <div class="flex justify-between mt-3 items-center">
        <div class="flex gap-2 items-center">
          <button id="start-trip" type="button" class="btn btn-primary">Iniciar viagem</button>
          <button id="optimize-route" type="button" class="btn btn-ghost">Atualizar rota</button>
        </div>
        <div>
          <button id="clear-route" type="button" class="btn btn-ghost">Limpar tudo</button>
        </div>
      </div>
    </div>

    <!-- Adicionar Local -->
    <div class="bg-white p-5 mb-6 shadow-md rounded-xl">
      <h2 class="text-lg font-semibold text-travel-800 mb-4">Adicionar Local</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Pesquisar local...</label>
          <div class="relative">
            <input id="search" type="text" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-travel-300" placeholder="Digite o nome de um local">
            <button id="btn-search" type="button" class="absolute right-2 top-2 btn btn-primary">Buscar</button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Local</label>
            <input id="place-name" class="w-full p-3 border border-gray-200 rounded-lg">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Custo (R$)</label>
            <input id="place-value" type="number" min="0" step="0.01" class="w-full p-3 border border-gray-200 rounded-lg">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
          <select id="place-category" class="w-full p-3 border border-gray-200 rounded-lg">
            <option value="attraction">Atra√ß√£o Tur√≠stica</option>
            <option value="park">Parque/Natureza</option>
            <option value="hotel">Hotel/Hospedagem</option>
            <option value="restaurant">Restaurante</option>
            <option value="museum">Museu/Cultural</option>
            <option value="shopping">Compras</option>
            <option value="other">Outro</option>
          </select>
        </div>
        <button id="add-place" type="button" class="w-full btn btn-primary">Adicionar Local</button>
        <div class="text-xs text-gray-500">Use a busca e arraste o marcador azul claro para refinar a posi√ß√£o antes de salvar.</div>
      </div>
    </div>

    <!-- Locais Salvos -->
    <div class="bg-white p-5 mb-6 shadow-md rounded-xl">
      <h2 class="text-lg font-semibold text-travel-800 mb-4">Locais Salvos</h2>
      <div id="places-list" class="space-y-3"></div>
    </div>

    <!-- Resumo -->
    <div class="bg-white p-5 shadow-md rounded-xl">
      <h2 class="text-lg font-semibold text-travel-800 mb-4">Resumo da Viagem</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div class="bg-travel-50 p-3 rounded-lg"><p class="text-sm text-gray-600">Dist√¢ncia Total</p><p id="total-distance" class="text-xl font-bold text-travel-700">0 km</p></div>
        <div class="bg-travel-50 p-3 rounded-lg"><p class="text-sm text-gray-600">Tempo Total</p><p id="total-time" class="text-xl font-bold text-travel-700">0 min</p></div>
        <div class="bg-travel-50 p-3 rounded-lg"><p class="text-sm text-gray-600">Custo de Combust√≠vel</p><p id="fuel-cost" class="text-xl font-bold text-travel-700">R$ 0,00</p></div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div class="bg-travel-50 p-3 rounded-lg"><p class="text-sm text-gray-600">Custo dos Locais</p><p id="places-cost" class="text-xl font-bold text-travel-700">R$ 0,00</p></div>
        <div class="bg-travel-50 p-3 rounded-lg"><p class="text-sm text-gray-600">Gastos Gerais</p><p id="expenses-cost" class="text-xl font-bold text-travel-700">R$ 0,00</p></div>
        <div class="bg-travel-50 p-3 rounded-lg"><p class="text-sm text-gray-600">Custo Total</p><p id="total-cost" class="text-xl font-bold text-travel-700">R$ 0,00</p></div>
      </div>
      <div id="route-details" class="space-y-2"></div>
    </div>
  </main>

  <script>
    // ====================== CONFIG ======================
    const GM_API_KEY = 'AIzaSyDwbThPtdCFKguYQggrrdJsiyJbPyDeKZc'; // ou localStorage['gm_api_key'] / ?gm_key=
    const categoryStyles = {
      attraction:{ color:'#ef4444', icon:'https://maps.google.com/mapfiles/ms/icons/red-dot.png', name:'Atra√ß√£o' },
      park:{ color:'#10b981', icon:'https://maps.google.com/mapfiles/ms/icons/green-dot.png', name:'Parque' },
      hotel:{ color:'#14b8a6', icon:'https://maps.google.com/mapfiles/ms/icons/cyan-dot.png', name:'Hotel' },
      motel:{ color:'#8b5cf6', icon:'https://maps.google.com/mapfiles/ms/icons/purple-dot.png', name:'Motel' },
      restaurant:{ color:'#f97316', icon:'https://maps.google.com/mapfiles/ms/icons/orange-dot.png', name:'Restaurante' },
      gas_station:{ color:'#f59e0b', icon:'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png', name:'Posto' },
      supermarket:{ color:'#a3e635', icon:'https://maps.google.com/mapfiles/ms/icons/lightgreen-dot.png', name:'Mercado' },
      museum:{ color:'#f59e0b', icon:'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png', name:'Museu' },
      shopping:{ color:'#8b5cf6', icon:'https://maps.google.com/mapfiles/ms/icons/purple-dot.png', name:'Compras' },
      other:{ color:'#6b7280', icon:'https://maps.google.com/mapfiles/ms/icons/pink-dot.png', name:'Outro' },
      buffet:{ color:'#0ea5e9', icon:'https://maps.google.com/mapfiles/ms/icons/ltblue-dot.png', name:'Buffet' }
    };

    // ====================== UTILS ======================
    const toast=(t,err=false)=>{const d=document.createElement('div');d.className='toast'+(err?' error':'');d.textContent=t;document.body.appendChild(d);setTimeout(()=>{d.style.opacity='0';setTimeout(()=>d.remove(),300)},3000)};
    const money=v=>(Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    const hav=(a,b)=>{const R=6371000,to=d=>d*Math.PI/180,dLat=to(b.lat-a.lat),dLng=to(b.lng-a.lng),s1=Math.sin(dLat/2),s2=Math.sin(dLng/2);const A=s1*s1+Math.cos(to(a.lat))*Math.cos(to(b.lat))*s2*s2;return 2*R*Math.asin(Math.sqrt(A));};
    const esc=s=>!s?'':String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const head=(a,b)=>{const toR=d=>d*Math.PI/180,toD=r=>r*180/Math.PI,lat1=toR(a.lat),lat2=toR(b.lat),dLon=toR(b.lng-a.lng);const y=Math.sin(dLon)*Math.cos(lat2),x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);return (toD(Math.atan2(y,x))+360)%360;};

    // ====================== ESTADO ======================
    let map, directionsService, directionsRendererMain, directionsRendererTemp, placesService, infoWindow;
    let markers=[], poiMarkers=[];
    let places=[], generalExpenses=[];
    let lastRouteResult=null, lastRouteResultSaved=null;

    let watchId=null, isTracking=false, isFollowing=true;
    let currentPositionMarker=null, pathPolyline=null, path=[];
    let tempDestination=null;
    let currentStopIndex=0, nextDistText='‚Äî', nextEtaText='‚Äî';
    const NEAR_STOP=120; // m

    // POIs ao longo da rota
    let activePOIType=null;
    const ALONG_SAMPLE_EVERY_KM = 4; // amostra a cada ~4km
    const ALONG_RADIUS_M = 1600; // 1.6km de raio

    // ====================== MAPA ======================
    function carIcon(deg=0){const size=36;const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
      <g transform="translate(${size/2},${size/2}) rotate(${deg}) translate(${-size/2},${-size/2})">
        <circle cx="${size/2}" cy="${size/2}" r="${size/2-1}" fill="#0b74de" opacity=".95"/>
        <path d="M ${size/2} ${6} L ${size/2 + 6} ${size/2 + 6} L ${size/2} ${size/2 + 2} L ${size/2 - 6} ${size/2 + 6} Z" fill="#fff"/>
      </g></svg>`;
      return {url:'data:image/svg+xml;utf-8,'+encodeURIComponent(svg),scaledSize:new google.maps.Size(size,size),anchor:new google.maps.Point(size/2,size/2)};
    }

    function initMap(){
      const initial={lat:-15.795,lng:-47.891};
      map=new google.maps.Map(document.getElementById('map'),{center:initial,zoom:13,gestureHandling:'greedy',mapTypeControl:true,streetViewControl:false,styles:[{featureType:'poi',elementType:'labels',stylers:[{visibility:'off'}]}]});
      infoWindow=new google.maps.InfoWindow();
      directionsService=new google.maps.DirectionsService();
      directionsRendererMain=new google.maps.DirectionsRenderer({map,suppressMarkers:true,polylineOptions:{strokeColor:'#0ea5e9',strokeOpacity:.95,strokeWeight:6}});
      directionsRendererTemp=new google.maps.DirectionsRenderer({map,suppressMarkers:true,polylineOptions:{strokeColor:'#16a34a',strokeOpacity:.95,strokeWeight:6}});
      placesService=new google.maps.places.PlacesService(map);
      pathPolyline=new google.maps.Polyline({path,geodesic:true,strokeColor:'#0b74de',strokeOpacity:1,strokeWeight:4,map});

      map.addListener('dragstart',()=>{ if(isTracking) setFollow(false); });
      loadData();
      setupListeners();
      updateRoute(); // inicial
    }

    // ====================== GPS ======================
    function startGPS(){
      if(!navigator.geolocation){ toast('Geolocaliza√ß√£o n√£o suportada',true); return; }
      if(isTracking) return;
      isTracking=true; setFollow(true);
      document.getElementById('gps-hud').style.display='block';
      document.getElementById('fs-toolbar').style.display='flex';
      document.getElementById('poi-toolbar').style.display='flex';
      enterFullscreen();

      watchId=navigator.geolocation.watchPosition(pos=>{
        if(!isTracking) return;
        const p={lat:pos.coords.latitude,lng:pos.coords.longitude};

        if(!currentPositionMarker){ currentPositionMarker=new google.maps.Marker({position:p,map,icon:carIcon(0),title:'Voc√™',zIndex:1000}); }
        else{
          const prev=path[path.length-1]||p;
          currentPositionMarker.setPosition(p);
          currentPositionMarker.setIcon(carIcon(head(prev,p)));
        }

        if(path.length===0 || Math.abs(path[path.length-1].lat-p.lat)>1e-5 || Math.abs(path[path.length-1].lng-p.lng)>1e-5){
          path.push(p); pathPolyline.setPath(path);
        }

        if(isFollowing){ map.panTo(p); if(map.getZoom()<15) map.setZoom(15); }

        // Navega√ß√£o
        if(tempDestination){ computeTempRoute(p,tempDestination); }
        else {
          updateNextStop(p);
          updateMainRouteFromCurrentPosition(p);
        }

      },err=>{
        const msg={1:'Permiss√£o negada.',2:'Localiza√ß√£o indispon√≠vel.',3:'Tempo expirou.'}[err?.code]||'Erro no GPS';
        toast(msg,true); stopGPS();
      },{enableHighAccuracy:true,maximumAge:3000,timeout:27000});

      const b=document.getElementById('start-trip');
      b.textContent='Parar viagem';
      b.classList.remove('btn-primary'); b.classList.add('btn-danger','tracking');
    }

    function stopGPS(){
      try{ if(watchId) navigator.geolocation.clearWatch(watchId);}catch(e){}
      watchId=null; isTracking=false;
      document.getElementById('gps-hud').style.display='none';
      document.getElementById('fs-toolbar').style.display='none';
      document.getElementById('poi-toolbar').style.display='none';
      exitFullscreen();

      const b=document.getElementById('start-trip');
      b.textContent='Iniciar viagem';
      b.classList.add('btn-primary'); b.classList.remove('btn-danger','tracking');
    }

    function setFollow(on){
      isFollowing=on;
      document.getElementById('btn-follow').textContent='Seguir: '+(on?'Ligado':'Desligado');
    }

    // ====================== ROTA PRINCIPAL ======================
    function updateRoute(){
      markers.forEach(m=>m.setMap(null)); markers=[];
      if(!places||places.length===0){
        directionsRendererMain.setMap(null);
        directionsRendererMain.setDirections({routes:[]});
        lastRouteResult=lastRouteResultSaved=null;
        document.getElementById('route-details').innerHTML='';
        updateStats(); return;
      }
      // marcadores dos lugares
      places.forEach(p=>{
        const cs=categoryStyles[p.category]||categoryStyles.other;
        const mk=new google.maps.Marker({position:{lat:p.lat,lng:p.lng},map,title:p.name,icon:{url:cs.icon,scaledSize:new google.maps.Size(36,36)}});
        mk.addListener('click',()=>{
          infoWindow.setContent(`<div style="max-width:260px">
            <h3 style="margin:0 0 4px 0;font-weight:800">${esc(p.name)}</h3>
            <div style="font-size:12px;color:#0369a1;margin-bottom:6px">${esc(p.address||'')}</div>
            <a href="#" class="iw-btn gray" data-action="next">Definir como pr√≥xima parada</a>
          </div>`);
          infoWindow.open(map,mk);
          google.maps.event.addListenerOnce(infoWindow,'domready',()=>{
            const a=document.querySelector('[data-action="next"]');
            if(a){ a.addEventListener('click',ev=>{ev.preventDefault(); const idx=places.findIndex(pp=>pp.lat===p.lat&&pp.lng===p.lng); if(idx>=1){currentStopIndex=idx; toast('Pr√≥xima parada: '+p.name);} infoWindow.close();});}
          });
        });
        markers.push(mk);
      });

      if(places.length>=2){
        const wps=places.slice(1,-1).map(p=>({location:{lat:p.lat,lng:p.lng},stopover:true}));
        directionsService.route({
          origin:{lat:places[0].lat,lng:places[0].lng},
          destination:{lat:places[places.length-1].lat,lng:places[places.length-1].lng},
          waypoints:wps, travelMode:google.maps.TravelMode.DRIVING, optimizeWaypoints:false
        },(res,status)=>{
          if(status==='OK'){
            directionsRendererMain.setMap(map);
            directionsRendererMain.setDirections(res);
            lastRouteResult=res; lastRouteResultSaved=JSON.parse(JSON.stringify(res));
            if(!isTracking){
              try{
                const b=new google.maps.LatLngBounds();
                res.routes[0].legs.forEach(l=>{ b.extend(l.start_location); b.extend(l.end_location); });
                map.fitBounds(b);
              }catch(e){}
            }
            renderRouteDetails(res);
            updateStats();
            // Atualiza POIs se houver tipo selecionado
            if(activePOIType) searchPOIsAlongRoute(activePOIType);
          } else {
            toast('Erro rota: '+status,true);
          }
        });
      }
    }

    function renderRouteDetails(res){
      const c=document.getElementById('route-details');
      c.innerHTML='<h3 class="font-semibold mb-2">Detalhes do Percurso:</h3>';
      if(!res?.routes?.[0]){ c.innerHTML+='<div class="text-gray-500">Sem detalhes.</div>'; return; }
      const legs=res.routes[0].legs||[];
      legs.forEach((leg,i)=>{
        const from=places[i]||{name:'Ponto'}, to=places[i+1]||{name:'Destino'};
        const div=document.createElement('div');
        div.className='bg-gray-50 p-3 rounded-lg mb-2';
        div.innerHTML=`<div class="flex justify-between items-center">
          <div><p class="font-medium">${esc(from.name)} ‚Üí ${esc(to.name)}</p><p class="text-sm text-gray-600">${leg.distance.text} ‚Ä¢ ${leg.duration.text}</p></div>
          <p class="text-travel-700 font-medium">${leg.duration.text}</p></div>`;
        c.appendChild(div);
      });
    }

    function updateMainRouteFromCurrentPosition(pos){
      if(!isTracking) return;
      if(!places||places.length<2) return;
      if(currentStopIndex<1) currentStopIndex=1;
      const remaining=places.slice(currentStopIndex, places.length-1);
      const waypoints=remaining.map(p=>({location:{lat:p.lat,lng:p.lng},stopover:true}));
      directionsService.route({
        origin:pos, destination:{lat:places[places.length-1].lat,lng:places[places.length-1].lng},
        waypoints, travelMode:google.maps.TravelMode.DRIVING, optimizeWaypoints:false
      },(res,status)=>{
        if(status==='OK'){
          directionsRendererMain.setMap(map);
          directionsRendererMain.setDirections(res);
          lastRouteResult=res;
          renderRouteDetails(res);
          updateStats();
        }
      });
    }

    // ====================== HUD / PR√ìXIMA PARADA ======================
    function updateHUD(){
      const next=places[currentStopIndex]||null;
      document.getElementById('hud-next-name').textContent=next?(next.name||'‚Äî'):'‚Äî';
      document.getElementById('hud-next-dist').textContent=nextDistText;
      document.getElementById('hud-next-eta').textContent=nextEtaText;
    }
    function updateNextStop(currentPos){
      if(!places||places.length<2){ nextDistText='‚Äî'; nextEtaText='‚Äî'; updateHUD(); return; }
      if(currentStopIndex<1) currentStopIndex=1;
      if(currentStopIndex>=places.length) currentStopIndex=places.length-1;

      const target=places[currentStopIndex];
      const d=hav(currentPos,{lat:target.lat,lng:target.lng});
      if(d<=NEAR_STOP && currentStopIndex<places.length-1){
        currentStopIndex++;
        toast(`Chegou em ${target.name}. Pr√≥xima: ${places[currentStopIndex].name}`);
      }
      const next=places[currentStopIndex];
      directionsService.route({origin:currentPos,destination:{lat:next.lat,lng:next.lng},travelMode:google.maps.TravelMode.DRIVING},(res,status)=>{
        if(status==='OK'){ try{ const leg=res.routes[0].legs[0]; nextDistText=leg.distance.text; nextEtaText=leg.duration.text; }catch(e){} }
        updateHUD();
      });
    }

    // ====================== POIs AO LONGO DA ROTA ======================
    function clearPOIMarkers(){ poiMarkers.forEach(m=>m.setMap(null)); poiMarkers=[]; }

    function searchPOIsAlongRoute(type){
      if(!lastRouteResult?.routes?.[0]){ toast('Calcule a rota primeiro.',true); return; }
      activePOIType=type;
      clearPOIMarkers();

      // amostras ao longo da polyline principal
      const path = lastRouteResult.routes[0].overview_path; // array de LatLng
      if(!path || path.length<2) return;

      const samples = [];
      let acc=0, step=ALONG_SAMPLE_EVERY_KM*1000;
      for(let i=1;i<path.length;i++){
        const a={lat:path[i-1].lat(),lng:path[i-1].lng()};
        const b={lat:path[i].lat(),lng:path[i].lng()};
        const seg=hav(a,b);
        acc+=seg;
        if(acc>=step){ samples.push(new google.maps.LatLng(b.lat,b.lng)); acc=0; }
      }
      if(samples.length===0) samples.push(path[Math.floor(path.length/2)]);

      const seen=new Set();
      const queries=samples.slice(0,15); // limite de chamadas
      queries.forEach((center,idx)=>{
        const req={ location:center, radius:ALONG_RADIUS_M, type: mapTypeFromChip(type) };
        placesService.nearbySearch(req,(results,status)=>{
          if(status===google.maps.places.PlacesServiceStatus.OK && results){
            results.slice(0,8).forEach(r=>{
              if(!r.place_id || seen.has(r.place_id)) return;
              seen.add(r.place_id);
              addPOIMarkerAlong(r, type);
            });
          }
        });
      });
    }

    function mapTypeFromChip(chipType){
      if(chipType==='buffet') return 'restaurant';
      if(chipType==='motel') return 'lodging';
      return chipType; // restaurant, lodging, tourist_attraction, supermarket, gas_station
    }

    function addPOIMarkerAlong(r, chipType){
      // normalizar categoria/estilo
      let cat = chipType;
      if(cat==='lodging'&&r.types?.includes('motel')) cat='motel';
      if(cat==='restaurant'&&r.types?.includes('meal_takeaway')) cat='restaurant';

      const style=categoryStyles[cat]||categoryStyles.other;
      const mk=new google.maps.Marker({
        position:r.geometry.location, map, zIndex:900,
        title:r.name, icon:{url:style.icon, scaledSize:new google.maps.Size(36,36)}
      });

      mk.addListener('click',()=>{
        // price_level (0‚Äì4) vira $-$$$$; rating; aberto agora (se tiver place details)
        const dollars = (r.price_level!=null) ? 'üí≤'.repeat(Math.max(1, r.price_level)) : '‚Äî';
        const rating = (r.rating!=null) ? `‚≠ê ${r.rating} (${r.user_ratings_total||0})` : '‚≠ê ‚Äî';
        const vicinity = r.vicinity || r.formatted_address || '';

        const content = `<div style="max-width:280px">
          <h3 style="margin:0 0 6px 0;font-weight:800">${esc(r.name)}</h3>
          <div style="color:${style.color};font-weight:700;margin-bottom:6px">${style.name}</div>
          <div style="font-size:13px;color:#0c4a6e;margin-bottom:6px">${esc(vicinity)}</div>
          <div style="font-size:13px;margin-bottom:8px">${rating} ‚Ä¢ ${dollars}</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <a href="#" class="iw-btn" data-action="go">Ir agora (tempor√°rio)</a>
            <a href="#" class="iw-btn alt" data-action="add">Adicionar √† rota (ap√≥s pr√≥xima)</a>
          </div>
        </div>`;
        infoWindow.setContent(content);
        infoWindow.open(map,mk);

        google.maps.event.addListenerOnce(infoWindow,'domready',()=>{
          const go=document.querySelector('[data-action="go"]');
          const add=document.querySelector('[data-action="add"]');
          if(go){ go.addEventListener('click',ev=>{
            ev.preventDefault();
            const poi={ name:r.name, lat:r.geometry.location.lat(), lng:r.geometry.location.lng(), address:r.vicinity||'', category:cat, place_id:r.place_id };
            setTemporaryDestination(poi);
            infoWindow.close();
          }); }
          if(add){ add.addEventListener('click',ev=>{
            ev.preventDefault();
            if(currentStopIndex<1) currentStopIndex=1;
            const newP={ name:r.name, value:0, category:(cat==='lodging'?'hotel':cat), lat:r.geometry.location.lat(), lng:r.geometry.location.lng(), address:r.vicinity||'', date:new Date().toISOString() };
            places.splice(Math.min(currentStopIndex+1, places.length-1), 0, newP);
            saveData(); updateRoute(); toast('Adicionado √† sua rota ap√≥s a pr√≥xima parada.');
            infoWindow.close();
          }); }
        });
      });

      poiMarkers.push(mk);
    }

    // ====================== ROTA TEMPOR√ÅRIA (VERDE) ======================
    function setTemporaryDestination(poi){
      tempDestination=poi;
      document.getElementById('abort-temp').style.display='inline-block';
      toast(`Rota tempor√°ria para ${poi.name}`);
      const start = currentPositionMarker ? currentPositionMarker.getPosition() : map.getCenter();
      if(!start){ toast('Posi√ß√£o inicial desconhecida.',true); return; }
      computeTempRoute({lat:start.lat(),lng:start.lng()}, poi);
    }

    function computeTempRoute(start, poi){
      directionsService.route({origin:start, destination:{lat:poi.lat,lng:poi.lng}, travelMode:google.maps.TravelMode.DRIVING}, (res,status)=>{
        if(status==='OK'){
          directionsRendererTemp.setMap(map);
          directionsRendererTemp.setDirections(res);
          renderTempDetails(res, poi);
        } else toast('Erro na rota tempor√°ria: '+status, true);
      });
    }

    function renderTempDetails(res, poi){
      const c=document.getElementById('route-details'); let html='<h3 class="font-semibold mb-2">Detalhes do Percurso:</h3>';
      if(lastRouteResult?.routes) html+='<div class="text-sm text-gray-600 mb-2">Rota principal (azul) mantida</div>';
      try{
        const leg=res.routes[0].legs[0];
        html+=`<div class="bg-green-50 p-3 rounded-lg mb-2">
          <div class="flex justify-between items-center">
            <div><p class="font-medium">Rota tempor√°ria (verde) ‚Üí ${esc(poi.name)}</p>
            <p class="text-sm text-gray-600">${leg.distance.text} ‚Ä¢ ${leg.duration.text}</p></div>
            <p class="text-travel-700 font-medium">${leg.duration.text}</p>
          </div>
          <div class="mt-2 text-xs text-gray-600">Chegando ao local, continue sua viagem normalmente ou clique em <strong>Desistir</strong> para ocultar a rota verde.</div>
        </div>`;
      }catch(e){}
      c.innerHTML=html;
    }

    function abortTemporaryRoute(){
      tempDestination=null;
      directionsRendererTemp.setMap(null);
      document.getElementById('abort-temp').style.display='none';
      toast('Rota tempor√°ria cancelada.');
      if(lastRouteResultSaved){
        lastRouteResult=JSON.parse(JSON.stringify(lastRouteResultSaved));
        directionsRendererMain.setMap(map);
        directionsRendererMain.setDirections(lastRouteResult);
        renderRouteDetails(lastRouteResult); updateStats();
      } else document.getElementById('route-details').innerHTML='';
    }

    // ====================== ESTAT√çSTICAS ======================
    function updateStats(){
      const placesCost=(places||[]).reduce((s,p)=>s+(parseFloat(p.value)||0),0);
      document.getElementById('places-cost').textContent=money(placesCost);
      const expensesCost=(generalExpenses||[]).reduce((s,e)=>s+(parseFloat(e.amount)||0),0);
      document.getElementById('expenses-cost').textContent=money(expensesCost);

      let totalDist=0,totalTime=0,fuelCost=0;
      if(lastRouteResult?.routes?.[0]){
        lastRouteResult.routes[0].legs.forEach(l=>{ totalDist+=(l.distance?.value)||0; totalTime+=(l.duration?.value)||0; });
        const eff=parseFloat(document.getElementById('fuel-efficiency').value)||10;
        const price=parseFloat(document.getElementById('fuel-price').value)||5.50;
        fuelCost=((totalDist/1000)/eff)*price;
      }
      document.getElementById('total-distance').textContent=(totalDist/1000).toFixed(1)+' km';
      const h=Math.floor(totalTime/3600), m=Math.round((totalTime%3600)/60);
      document.getElementById('total-time').textContent=(h>0?`${h} h `:'')+`${m} min`;
      document.getElementById('fuel-cost').textContent=money(fuelCost||0);
      document.getElementById('total-cost').textContent=money(placesCost+expensesCost+(fuelCost||0));
    }

    // ====================== PERSIST√äNCIA ======================
    function loadData(){
      try{
        const sp=localStorage.getItem('travel_places'); if(sp) places=JSON.parse(sp);
        const se=localStorage.getItem('travel_expenses'); if(se) generalExpenses=JSON.parse(se);
      }catch(e){ places=[]; generalExpenses=[]; }
      renderPlaces(); updateRoute();
    }
    function saveData(){
      try{
        localStorage.setItem('travel_places',JSON.stringify(places));
        localStorage.setItem('travel_expenses',JSON.stringify(generalExpenses));
      }catch(e){}
    }

    // ====================== UI LISTAS ======================
    function renderPlaces(){
      const c=document.getElementById('places-list'); c.innerHTML='';
      if(!places?.length){ c.innerHTML='<div class="text-center py-4 text-gray-500">Nenhum local adicionado</div>'; updateStats(); return; }
      places.forEach((p,i)=>{
        const cs=categoryStyles[p.category]||categoryStyles.other;
        const bg=`rgba(${parseInt(cs.color.substr(1,2),16)},${parseInt(cs.color.substr(3,2),16)},${parseInt(cs.color.substr(5,2),16)},.12)`;
        const div=document.createElement('div');
        div.className='place-item bg-white p-4 rounded-lg border border-gray-200';
        div.innerHTML=`<div class="flex justify-between items-start">
          <div>
            <div class="flex items-center gap-2">
              <h3 class="font-semibold text-travel-800">${esc(p.name)}</h3>
              <span class="category-badge" style="background:${bg};color:${cs.color}">${cs.name}</span>
              ${ (isTracking && i===currentStopIndex) ? '<span class="chip">Pr√≥xima parada</span>' : '' }
            </div>
            ${ p.value?`<p class="text-sm text-travel-600">${money(p.value)}</p>`:'' }
            ${ p.address?`<p class="text-xs text-gray-500 mt-1">${esc(p.address)}</p>`:'' }
          </div>
          <div class="flex gap-2 items-center">
            <button data-i="${i}" class="btn btn-ghost set-next" title="Pr√≥xima">Pr√≥xima</button>
            <button data-i="${i}" class="btn btn-ghost up" title="Subir">‚ñ≤</button>
            <button data-i="${i}" class="btn btn-ghost down" title="Descer">‚ñº</button>
            <button data-i="${i}" class="btn btn-danger del" title="Remover">‚úï</button>
          </div>
        </div>`;
        c.appendChild(div);
      });
      updateStats();
    }

    // ====================== BUSCA / ADI√á√ÉO ======================
    let searchMarker=null, mapClickMarker=null;

    function showSearchMarker(latLng, name, addr){
      const icon={url:'https://maps.google.com/mapfiles/ms/icons/lightblue-dot.png',scaledSize:new google.maps.Size(36,36)};
      if(searchMarker){ searchMarker.setPosition(latLng); searchMarker.setTitle(name||'Local'); }
      else{
        searchMarker=new google.maps.Marker({position:latLng,map,icon,title:name||'Local',draggable:true,animation:google.maps.Animation.BOUNCE,zIndex:1100});
        setTimeout(()=>{ if(searchMarker) searchMarker.setAnimation(null); },1000);
      }
      map.panTo(latLng); map.setZoom(15);
    }

    // ====================== LISTENERS ======================
    function setupListeners(){
      // Iniciar/parar viagem
      document.getElementById('start-trip').addEventListener('click',()=>{
        if(isTracking){ stopGPS(); toast('Viagem parada.'); }
        else{
          if(places.length<2){ toast('Adicione pelo menos origem e destino.',true); return; }
          currentStopIndex = Math.max(1, currentStopIndex||1);
          updateHUD();
          startGPS();
        }
      });
      // Toolbar FS
      document.getElementById('btn-exit-fs').addEventListener('click',()=>{ stopGPS(); });
      document.getElementById('btn-follow').addEventListener('click',()=>setFollow(!isFollowing));
      document.getElementById('btn-center').addEventListener('click',()=>{ if(currentPositionMarker){ const p=currentPositionMarker.getPosition(); map.panTo(p); if(map.getZoom()<15) map.setZoom(15); setFollow(true);} });
      document.getElementById('btn-stop').addEventListener('click',()=>{ stopGPS(); });

      // HUD
      document.getElementById('btn-next-go').addEventListener('click',()=>{
        if(!isTracking){ toast('Inicie a viagem para navegar.',true); return; }
        const pos=currentPositionMarker?{lat:currentPositionMarker.getPosition().lat(),lng:currentPositionMarker.getPosition().lng()}:null;
        if(!pos){ toast('Posi√ß√£o atual indispon√≠vel.',true); return; }
        if(currentStopIndex<1) currentStopIndex=1;
        const t=places[currentStopIndex]; setTemporaryDestination({name:t.name,lat:t.lat,lng:t.lng,category:t.category});
      });
      document.getElementById('btn-skip-stop').addEventListener('click',()=>{
        if(currentStopIndex<places.length-1){ currentStopIndex++; toast('Pr√≥xima: '+places[currentStopIndex].name); updateHUD(); }
      });
      document.getElementById('abort-temp').addEventListener('click',()=>abortTemporaryRoute());

      // Atualizar rota
      document.getElementById('optimize-route').addEventListener('click',()=>{ if(places.length<2){ toast('Adicione 2 locais.',true); return; } updateRoute(); toast('Rota atualizada.'); });

      // Limpar tudo
      document.getElementById('clear-route').addEventListener('click',()=>{
        if(places.length>0 && confirm('Limpar tudo?')){
          places=[]; generalExpenses=[]; saveData(); renderPlaces(); updateRoute();
          stopGPS();
          if(currentPositionMarker){ currentPositionMarker.setMap(null); currentPositionMarker=null; }
          if(pathPolyline){ pathPolyline.setMap(null); }
          path=[]; pathPolyline=new google.maps.Polyline({path,geodesic:true,strokeColor:'#0b74de',strokeOpacity:1,strokeWeight:4,map});
          directionsRendererTemp.setMap(null); tempDestination=null;
          document.getElementById('abort-temp').style.display='none';
          clearPOIMarkers();
          toast('Tudo limpo.');
        }
      });

      // Busca manual
      document.getElementById('btn-search').addEventListener('click',()=>{
        const q=document.getElementById('search').value.trim(); if(!q){ toast('Digite algo para pesquisar.',true); return; }
        const svc=new google.maps.places.PlacesService(map);
        svc.findPlaceFromQuery({query:q,fields:['name','geometry','formatted_address','types']},(res,status)=>{
          if(status===google.maps.places.PlacesServiceStatus.OK && res?.[0]){
            const p=res[0], loc=p.geometry.location;
            showSearchMarker(loc, p.name||'', p.formatted_address||'');
            document.getElementById('place-name').value=p.name||'';
            document.getElementById('search').value=p.formatted_address||p.name||'';
            let cat='other'; const t=p.types||[];
            if(t.includes('park')||t.includes('natural_feature')) cat='park';
            else if(t.includes('tourist_attraction')||t.includes('point_of_interest')) cat='attraction';
            else if(t.includes('lodging')||t.includes('hotel')) cat='hotel';
            else if(t.includes('restaurant')||t.includes('food')) cat='restaurant';
            else if(t.includes('museum')||t.includes('art_gallery')) cat='museum';
            else if(t.includes('shopping_mall')||t.includes('store')) cat='shopping';
            document.getElementById('place-category').value=cat;
            toast('Local encontrado! Ajuste o marcador e clique em Adicionar.');
          }else toast('Local n√£o encontrado.',true);
        });
      });

      // Adicionar local
      document.getElementById('add-place').addEventListener('click',()=>{
        const name=document.getElementById('place-name').value.trim();
        const value=parseFloat(document.getElementById('place-value').value)||0;
        const category=document.getElementById('place-category').value;
        if(!name){ toast('Informe o nome do local',true); return; }
        let lat,lng; if(searchMarker){ const p=searchMarker.getPosition(); lat=p.lat(); lng=p.lng(); } else { const c=map.getCenter(); lat=c.lat(); lng=c.lng(); }
        places.push({name,value,category,lat,lng,address:document.getElementById('search').value||'',date:new Date().toISOString()});
        saveData(); renderPlaces(); updateRoute(); toast('Local adicionado!');
        document.getElementById('place-name').value=''; document.getElementById('place-value').value=''; document.getElementById('search').value='';
        if(searchMarker){ searchMarker.setMap(null); searchMarker=null; }
      });

      // Lista de lugares
      document.getElementById('places-list').addEventListener('click',e=>{
        const b=e.target.closest('button'); if(!b) return; const i=parseInt(b.dataset.i);
        if(b.classList.contains('del')){ if(confirm('Remover?')){ places.splice(i,1); saveData(); renderPlaces(); updateRoute(); } }
        else if(b.classList.contains('up') && i>0){ [places[i-1],places[i]]=[places[i],places[i-1]]; saveData(); renderPlaces(); updateRoute(); }
        else if(b.classList.contains('down') && i<places.length-1){ [places[i+1],places[i]]=[places[i],places[i+1]]; saveData(); renderPlaces(); updateRoute(); }
        else if(b.classList.contains('set-next')){ if(i>=1){ currentStopIndex=i; toast('Pr√≥xima parada: '+places[i].name); renderPlaces(); } }
      });

      // POI filtros
      document.querySelectorAll('.poi-chip').forEach(ch=>{
        ch.addEventListener('click',()=>{
          const t=ch.dataset.type;
          document.querySelectorAll('.poi-chip').forEach(c=>c.classList.remove('active'));
          ch.classList.add('active');
          searchPOIsAlongRoute(t);
        });
      });

      // clique no mapa para criar ponto r√°pido
      map.addListener('click',(e)=>{
        if(mapClickMarker) mapClickMarker.setMap(null);
        mapClickMarker=new google.maps.Marker({position:e.latLng,map,icon:{url:'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',scaledSize:new google.maps.Size(36,36)},draggable:true});
        infoWindow.setContent(`<div style="max-width:220px"><h3 style="margin:0 0 6px 0;font-weight:700">Novo Local</h3>
          <div style="margin-top:8px"><a href="#" class="iw-btn" id="iw-save">Salvar este local</a></div></div>`);
        infoWindow.open(map,mapClickMarker);
        google.maps.event.addListenerOnce(infoWindow,'domready',()=>{
          document.getElementById('iw-save').addEventListener('click',ev=>{
            ev.preventDefault();
            document.getElementById('place-name').value='Novo Local';
            const p=mapClickMarker.getPosition();
            document.getElementById('search').value=`Lat: ${p.lat().toFixed(6)}, Lng: ${p.lng().toFixed(6)}`;
            infoWindow.close(); mapClickMarker.setMap(null); mapClickMarker=null;
          });
        });
      });

      // consumo/combust√≠vel
      document.getElementById('fuel-efficiency').addEventListener('change',updateStats);
      document.getElementById('fuel-price').addEventListener('change',updateStats);
    }

    // ====================== FULLSCREEN ======================
    async function enterFullscreen(){
      const el=document.getElementById('map-card');
      try{ if(el.requestFullscreen) await el.requestFullscreen(); else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen(); }catch(e){}
    }
    async function exitFullscreen(){
      try{ if(document.fullscreenElement && document.exitFullscreen) await document.exitFullscreen(); }catch(e){}
    }

    // ====================== GOOGLE MAPS LOADER ======================
    function getApiKey(){
      const url=new URLSearchParams(location.search);
      if(GM_API_KEY && GM_API_KEY!=='YOUR_API_KEY_HERE') return GM_API_KEY;
      const ls=localStorage.getItem('gm_api_key'); if(ls) return ls;
      const qp=url.get('gm_key'); if(qp) return qp;
      return null;
    }
    function loadMaps(){
      const key=getApiKey()||'YOUR_API_KEY_HERE';
      const s=document.createElement('script');
      s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&libraries=places,directions,geometry&callback=initMap`;
      s.async=true; s.defer=true; s.onerror=()=>toast('Erro ao carregar Google Maps. Verifique a chave.',true);
      document.head.appendChild(s);
    }
    window.addEventListener('DOMContentLoaded',loadMaps);
  </script>
</body>
</html>
