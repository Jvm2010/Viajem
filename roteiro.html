<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Roteiro — Viagem</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script type="module" src="app_mod.js" defer></script>
  <script type="module" src="db_api.js" defer></script>
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="firebase.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <script>
    // /* auth-check */
    (function(){
      try{
        const auth = sessionStorage.getItem('viagem:auth');
        if(auth !== '1' && auth !== '0'){
          window.location.href = 'index.html';
        }
        // if auth === '0' it's guest: allow but can restrict later
      }catch(e){
        console.error(e);
      }
    })();
  </script>

  <header class="bg-white shadow p-4 sticky top-0 z-10">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <h1 class="text-lg font-semibold">Roteiro — Viagem</h1>
      <nav class="text-sm space-x-4">
        <a href="index.html" class="text-sky-600">Início</a>
        <a href="fotos.html" class="text-sky-600">Fotos & Vídeos</a>
      </nav>
    </div>
  </header>

  <main class="max-w-4xl mx-auto p-4 space-y-4">
    <section class="card">
      <h2 class="font-semibold">Adicionar local</h2>
      <p class="small">Toque no mapa para adicionar um ponto ou use o campo para pesquisar.</p>

      <div class="mt-3 grid grid-cols-1 gap-3">
        <div class="flex gap-2">
          <input id="search" class="flex-1 input card p-2" placeholder="Pesquisar endereço ou nome do local" />
          <button id="btn-search" class="badge">Procurar</button>
        </div>

        <div class="input-grid">
          <input id="place-name" placeholder="Nome do local (ex: Praia do X)" class="p-2 card" />
          <input id="place-value" placeholder="Valor (opcional)" class="p-2 card" type="number" min="0" />
          <button id="add-current" class="badge">Adicionar</button>
        </div>

        <div class="flex gap-2 items-center">
          <label class="small">Gastos gerais separados</label>
          <button id="add-general" class="text-sm text-sky-600">Adicionar gasto geral</button>
        </div>
      </div>
    </section>

    <section class="grid md:grid-cols-2 gap-4">
      <div class="card">
        <h3 class="font-semibold">Mapa</h3>
        <div id="map" class="mt-3"></div>
        <div class="small mt-2">Clique nos marcadores para editar/remover. A ordem de lista define a rota.</div>
      </div>

      <div class="card">
        <h3 class="font-semibold">Locais salvos</h3>
        <div id="places-list" class="mt-3"></div>

        <h4 class="mt-4 font-semibold">Gastos gerais</h4>
        <div id="general-list" class="mt-2"></div>

        <div class="footer-summary mt-4">
          <div>
            <div class="small">Distância total</div>
            <div id="total-distance" class="text-xl font-bold">0 km</div>
          </div>
          <div>
            <div class="small">Custo total</div>
            <div id="total-cost" class="text-xl font-bold">R$ 0,00</div>
          </div>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="export-json" class="badge">Exportar JSON</button>
          <button id="clear-all" class="text-sm text-red-600">Limpar tudo</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal backdrop -->
  <div id="modal-backdrop" class="modal-backdrop" aria-hidden="true" style="display:flex">
    <div class="modal">
      <div class="flex items-center justify-between">
        <h3 id="modal-title" class="font-semibold text-lg">Título</h3>
        <button id="modal-cancel" class="text-sm text-gray-500">✕</button>
      </div>
      <div id="modal-body" class="mt-3 small"></div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="modal-confirm" class="badge">Confirmar</button>
        <button id="modal-cancel-2" onclick="document.getElementById('modal-backdrop').classList.remove('show')" class="text-sm text-gray-500">Cancelar</button>
      </div>
    </div>
  </div>


  <footer class="max-w-4xl mx-auto p-4 text-center small">
    Desenvolvido — Melhorias rápidas para usar no celular.
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script type="module">
  import * as core from './app_mod.js';
  import { subscribePlaces, savePlace, removePlace, subscribeGeneral, saveGeneral } from './db_api.js';

  const map = L.map('map').setView([-23.5489, -46.6388], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);

  let places = [];
  let general = [];
  let markers = [];

  function renderLists(){
    const placesDiv = document.getElementById('places-list');
    placesDiv.innerHTML='';
    places.forEach((p, idx)=>{
      const div = document.createElement('div'); div.className='list-item';
      const left = document.createElement('div');
      left.innerHTML = `<div class="font-semibold">${p.name}</div><div class="small">${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}</div>`;
      const right = document.createElement('div' );
      right.innerHTML = `<div class="text-right"><div class="small">${p.value?core.formatCurrency(p.value):''}</div><div class="mt-2"><button class="text-sm text-sky-600 btn-focus" data-id="${p.id}" data-action="zoom">Ir</button> <button class="text-sm text-red-600" data-id="${p.id}" data-action="del">Remover</button></div></div>`;
      div.appendChild(left); div.appendChild(right);
      placesDiv.appendChild(div);
    });

    const gen = document.getElementById('general-list');
    gen.innerHTML='';
    general.forEach((g, i)=>{
      const d = document.createElement('div'); d.className='list-item';
      d.innerHTML = `<div><div class="font-semibold">${g.title}</div><div class="small">${new Date(g.created).toLocaleString()}</div></div><div class="text-right">${core.formatCurrency(g.amount)} <div class="mt-2"><button class="text-sm text-red-600" data-gi="${g.id}">Remover</button></div></div>`;
      gen.appendChild(d);
    });

    // markers
    markers.forEach(m=>map.removeLayer(m)); markers = [];
    places.forEach((p, idx)=>{
      const m = L.marker([p.lat,p.lng]).addTo(map).bindPopup(`<strong>${p.name}</strong><br>${p.value?core.formatCurrency(p.value):''}`);
      m.on('click', ()=>{});
      markers.push(m);
    });

    updateTotals();
  }

  function updateTotals(){
    let totalKm = 0;
    for(let i=1;i<places.length;i++){
      totalKm += core.haversine(places[i-1], places[i]);
    }
    document.getElementById('total-distance').textContent = totalKm.toFixed(2) + ' km';
    let totalCost = places.reduce((s,p)=>s + (Number(p.value)||0), 0) + general.reduce((s,g)=>s + (Number(g.amount)||0),0);
    document.getElementById('total-cost').textContent = core.formatCurrency(totalCost);
  }

  map.on('click', function(e){
    const lat = e.latlng.lat, lng = e.latlng.lng;
    document.getElementById('place-name').value = '';
    document.getElementById('place-value').value = '';
    map._temp = {lat,lng};
    // improved UX: small toast instead of alert
    const toast = document.createElement('div'); toast.textContent = 'Local selecionado no mapa. Preencha nome e pressione "Adicionar".'; toast.className='card small'; toast.style.position='fixed'; toast.style.right='12px'; toast.style.bottom='12px'; document.body.appendChild(toast);
    setTimeout(()=>toast.remove(),4000);
  });

  document.getElementById('add-current').addEventListener('click', async ()=>{
    const name = document.getElementById('place-name').value.trim() || 'Ponto';
    const val = document.getElementById('place-value').value;
    const coords = map._temp || {lat: map.getCenter().lat, lng: map.getCenter().lng};
    const place = { name, lat: coords.lat, lng: coords.lng, value: val?Number(val):0 };
    try{
      await savePlace(place);
      document.getElementById('place-name').value='';
      document.getElementById('place-value').value='';
    }catch(e){
      // fallback: save to local pending queue
      console.error('Erro ao salvar no Firebase, gravando localmente', e);
      const pending = JSON.parse(localStorage.getItem('viagem:pending')||'[]');
      pending.push({type:'place', data:place});
      localStorage.setItem('viagem:pending', JSON.stringify(pending));
      alert('Sem conexão, local salvo localmente e será sincronizado quando online.');
    }
  });

  document.getElementById('places-list').addEventListener('click', (ev)=>{
    const btn = ev.target.closest('button');
    if(!btn) return;
    const id = btn.dataset.id;
    if(btn.dataset.action === 'zoom'){ const p = places.find(x=>x.id===id); if(p) map.setView([p.lat,p.lng],15); }
    else if(btn.dataset.action === 'del'){ if(confirm('Remover este local?')) removePlace(id); }
  });

  document.getElementById('add-general').addEventListener('click', async ()=>{
    const title = prompt('Título do gasto geral:');
    if(!title) return;
    const amt = prompt('Valor (R$):','0');
    const g = { title, amount: Number(amt)||0 };
    try{ await saveGeneral(g); } catch(e){
      const pending = JSON.parse(localStorage.getItem('viagem:pending')||'[]');
      pending.push({type:'general', data:g}); localStorage.setItem('viagem:pending', JSON.stringify(pending));
      alert('Sem conexão, gasto salvo localmente e será sincronizado quando online.');
    }
  });

  document.getElementById('export-json').addEventListener('click', ()=>{
    const a = document.createElement('a');
    const payload = { places, general };
    const blob = new Blob([JSON.stringify(payload, null, 2)],{type:'application/json'});
    a.href = URL.createObjectURL(blob); a.download = 'roteiro.json'; a.click();
  });

  document.getElementById('clear-all').addEventListener('click', ()=>{
    if(confirm('Confirma limpar todo o roteiro e gastos?')){
      // remove all places and gastos
      places.forEach(p=>{ if(p.id) removePlace(p.id); });
      general.forEach(g=>{ if(g.id) {/* no removeGeneral here but could be added */} });
    }
  });

  document.getElementById('btn-search').addEventListener('click', async ()=>{
    const q = document.getElementById('search').value.trim();
    if(!q) return alert('Digite algo para buscar');
    const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(q));
    const data = await res.json();
    if(!data || !data.length) return alert('Nenhum resultado');
    const top = data[0];
    const lat = parseFloat(top.lat), lon = parseFloat(top.lon);
    map.setView([lat,lon],15);
    map._temp = {lat: lat, lng: lon};
    document.getElementById('place-name').value = top.display_name;
  });

  // subscriptions
  subscribePlaces(ps=>{ places = ps; renderLists(); populatePlaceSelector(); });
  subscribeGeneral(gs=>{ general = gs; renderLists(); });

  // sync pending on online
  window.addEventListener('online', async ()=>{
    const pending = JSON.parse(localStorage.getItem('viagem:pending')||'[]');
    if(pending.length===0) return;
    for(const item of pending){
      try{
        if(item.type==='place') await savePlace(item.data);
        else if(item.type==='general') await saveGeneral(item.data);
      }catch(e){ console.error('sync failed', e); }
    }
    localStorage.removeItem('viagem:pending');
  });

  // helper to populate select in photos page via storage on window for reuse
  window.populatePlaceSelector = function(){ /* placeholder, photos page will call subscribePlaces directly */ };

</script>


</body>
</html>
