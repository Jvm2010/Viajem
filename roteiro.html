<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>Roteiro por Data — GPS & POIs</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          travel: {50:'#f0f9ff',100:'#e0f2fe',200:'#bae6fd',300:'#7dd3fc',400:'#38bdf8',500:'#0ea5e9',600:'#0284c7',700:'#0369a1',800:'#075985',900:'#0c4a6e'}
        }
      }
    }
  }
</script>
<style>
  :root { --hud-shadow: 0 12px 30px rgba(2,132,199,.18); }
  html,body{height:100%}
  body{font-family:'Roboto',sans-serif;background:#f8fafc}
  #map{height:420px;width:100%;border-radius:16px}
  .place-item{transition:.25s}
  .place-item:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.08)}
  .category-badge{display:inline-block;padding:.25rem .5rem;border-radius:9999px;font-size:.75rem;font-weight:500}
  .visit-badge{display:inline-block;padding:.2rem .5rem;border-radius:9999px;font-size:.7rem;background:#dcfce7;color:#166534}
  .chip{display:inline-block;padding:2px 8px;border-radius:9999px;font-size:12px;background:#e0f2fe;color:#075985;margin-left:6px}
  .toast{position:fixed;bottom:20px;right:20px;padding:12px 16px;border-radius:10px;color:#fff;background:#0ea5e9;box-shadow:0 10px 25px rgba(0,0,0,.12);z-index:10000;opacity:1;transition:opacity .3s}
  .toast.error{background:#ef4444}
  #start-trip.tracking{animation:pulse 2s infinite}
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}

  /* Fullscreen overlay */
  .fullscreen-overlay{position:fixed;inset:0;background:#fff;z-index:1000;display:none}
  .fullscreen-overlay.active{display:block}
  .fullscreen-map-wrap{position:absolute;inset:0;display:flex;flex-direction:column}
  .fullscreen-map{flex:1 1 auto}

  /* HUD */
  .gps-hud{position:absolute;left:12px;top:12px;z-index:1001;background:rgba(255,255,255,.96);backdrop-filter:saturate(160%) blur(8px);border:1px solid rgba(2,132,199,.15);border-radius:12px;padding:10px 12px;min-width:280px;box-shadow:var(--hud-shadow)}
  .hud-title{font-weight:700;color:#0369a1;margin-bottom:6px;display:flex;align-items:center;gap:8px}
  .hud-line{font-size:14px;color:#0c4a6e}
  .hud-actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
  .hud-btn{background:#0284c7;color:#fff;font-weight:600;padding:6px 10px;border-radius:8px}
  .hud-btn.secondary{background:#e2e8f0;color:#0f172a}
  .gps-hud.mini{top:unset;bottom:12px}

  /* FAB */
  .fab{position:absolute;z-index:1001;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px}
  .fab button{background:#fff;border:1px solid #e5e7eb;box-shadow:var(--hud-shadow);padding:8px 10px;border-radius:10px;font-weight:600;color:#0c4a6e}
  .fab button.danger{background:#ef4444;color:#fff;border-color:#ef4444}

  .btn{padding:8px 10px;border-radius:8px;font-weight:600}
  .divider{height:1px;background:#e5e7eb;margin:10px 0}
  .muted{opacity:.6}
</style>
<link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;Roteiro de Viagem&quot;,&quot;short_name&quot;:&quot;Roteiro&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#ffffff&quot;,&quot;theme_color&quot;:&quot;#0ea5e9&quot;}">
</head>
<body>

<!-- Fullscreen GPS -->
<div id="fs-overlay" class="fullscreen-overlay">
  <div class="fullscreen-map-wrap">
    <div id="fs-map" class="fullscreen-map"></div>

    <div id="fs-hud" class="gps-hud" style="display:none">
      <div class="hud-title">
        Navegação
        <span id="hud-mode" class="chip">GPS</span>
        <span id="hud-date" class="chip">—/—/—</span>
        <span id="hud-travel" class="chip">Dirigindo</span>
      </div>
      <div class="hud-line"><strong>Próxima parada:</strong> <span id="hud-next-name">—</span></div>
      <div class="hud-line"><strong>Distância:</strong> <span id="hud-next-dist">—</span> • <strong>ETA:</strong> <span id="hud-next-eta">—</span></div>
      <div class="hud-line" id="hud-next-step" style="margin-top:4px;font-size:13px;color:#334155">—</div>
      <div class="hud-actions">
        <button id="btn-next-go" class="hud-btn">Ir para próxima</button>
        <button id="btn-skip-stop" class="hud-btn secondary">Pular parada</button>
        <button id="btn-follow" class="hud-btn secondary">Seguir</button>
        <button id="btn-exit-fs" class="hud-btn secondary">Sair tela cheia</button>
      </div>
    </div>

    <div class="fab">
      <button id="btn-recenter">Recentrar</button>
      <button id="abort-temp" class="danger" style="display:none">Desistir (Rota Temp)</button>
    </div>
  </div>
</div>

<header class="bg-white shadow-sm sticky top-0 z-10">
  <div class="container mx-auto px-4 py-3 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-travel-700">Roteiro por Data</h1>
    <nav class="flex gap-4">
      <a href="#" class="text-travel-600 font-medium" onclick="alert('Página de fotos opcional');return false;">Fotos</a>
      <a href="#" class="text-gray-500" onclick="alert('Saída simbólica');return false;">Sair</a>
    </nav>
  </div>
</header>

<main class="container mx-auto px-4 py-6 max-w-6xl">

  <!-- Data & Modo -->
  <div class="bg-white p-4 mb-6 shadow-md rounded-xl">
    <h2 class="text-lg font-semibold text-travel-800 mb-3">Data e Modo de Locomoção</h2>
    <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
      <div class="col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-1">Data do roteiro</label>
        <input id="current-date" type="date" class="w-full p-3 border border-gray-200 rounded-lg">
        <p class="text-xs text-gray-500 mt-1">O mapa e a rota exibem apenas os locais desta data.</p>
      </div>
      <div class="col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-1">Modo</label>
        <select id="travel-mode" class="w-full p-3 border border-gray-200 rounded-lg">
          <option value="DRIVING" selected>Dirigindo</option>
          <option value="WALKING">A pé</option>
        </select>
        <p class="text-xs text-gray-500 mt-1">No modo a pé, o planejamento prioriza locais próximos.</p>
      </div>
      <div class="col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-1">Início do dia</label>
        <div class="flex gap-2">
          <input id="day-start" type="time" value="09:00" class="w-full p-3 border border-gray-200 rounded-lg">
          <input id="visit-duration" type="number" min="10" step="5" value="60" class="w-24 p-3 border border-gray-200 rounded-lg" title="Minutos por parada">
        </div>
        <p class="text-xs text-gray-500 mt-1">Usado para validar horários de abertura/fechamento.</p>
      </div>
    </div>
  </div>

  <!-- Planejamento -->
  <div class="bg-white p-4 mb-6 shadow-md rounded-xl">
    <h2 class="text-lg font-semibold text-travel-800 mb-3">Planejar Melhor Ordem</h2>
    <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
      <label class="flex items-center gap-2 col-span-2">
        <input id="plan-use-current" type="checkbox" class="h-4 w-4 text-travel-600">
        <span class="text-sm text-gray-700">Começar da <b>minha posição</b></span>
      </label>
      <label class="flex items-center gap-2 col-span-2">
        <input id="plan-roundtrip" type="checkbox" class="h-4 w-4 text-travel-600">
        <span class="text-sm text-gray-700">Voltar ao início (circuito)</span>
      </label>
      <label class="flex items-center gap-2 col-span-2">
        <input id="plan-skip-visited" type="checkbox" class="h-4 w-4 text-travel-600" checked>
        <span class="text-sm text-gray-700">Ignorar <b>visitados</b></span>
      </label>
      <button id="btn-plan-best" class="btn bg-travel-600 text-white hover:bg-travel-700 col-span-2">Planejar</button>

      <!-- (Exportações removidas conforme pedido) -->
    </div>
  </div>

  <!-- Filtros -->
  <div class="bg-white p-4 mb-6 shadow-md rounded-xl">
    <h2 class="text-lg font-semibold text-travel-800 mb-3">Filtros</h2>
    <div class="flex flex-wrap gap-3 items-center">
      <label class="flex items-center gap-2"><input type="checkbox" class="flt-cat" value="attraction" checked> Atração</label>
      <label class="flex items-center gap-2"><input type="checkbox" class="flt-cat" value="park" checked> Parque</label>
      <label class="flex items-center gap-2"><input type="checkbox" class="flt-cat" value="hotel" checked> Hotel</label>
      <label class="flex items-center gap-2"><input type="checkbox" class="flt-cat" value="restaurant" checked> Restaurante</label>
      <label class="flex items-center gap-2"><input type="checkbox" class="flt-cat" value="museum" checked> Museu</label>
      <label class="flex items-center gap-2"><input type="checkbox" class="flt-cat" value="shopping" checked> Compras</label>
      <label class="flex items-center gap-2"><input type="checkbox" id="flt-visited" checked> Mostrar visitados</label>
    </div>
  </div>

  <!-- Configuração e GPS -->
  <div class="bg-white p-4 mb-6 shadow-md rounded-xl">
    <h2 class="text-lg font-semibold text-travel-800 mb-3">Configurações & GPS</h2>
    <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Consumo (km/l)</label>
        <input id="fuel-efficiency" type="number" min="1" value="10" class="w-full p-3 border border-gray-200 rounded-lg">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Preço (R$/l)</label>
        <input id="fuel-price" type="number" min="0.1" step="0.01" value="5.50" class="w-full p-3 border border-gray-200 rounded-lg">
      </div>
      <div class="col-span-4 flex flex-wrap items-end gap-2">
        <button id="start-trip" class="btn bg-travel-600 text-white hover:bg-travel-700">Iniciar Viagem</button>
        <button id="btn-enter-fs" class="btn bg-travel-100 text-travel-700 hover:bg-travel-200">Tela Cheia</button>
        <button id="optimize-route" class="btn bg-travel-100 text-travel-700 hover:bg-travel-200">Recalcular</button>
        <button id="clear-route" class="btn border border-red-200 text-red-600 hover:bg-red-50">Limpar Tudo</button>
      </div>
    </div>
  </div>

  <!-- Mapa -->
  <div class="bg-white p-4 mb-6 shadow-md rounded-xl relative">
    <h2 class="text-lg font-semibold text-travel-800 mb-3">Mapa</h2>
    <div id="map"></div>
    <div id="hud-mini" class="gps-hud mini" style="display:none">
      <div class="hud-title">Navegação <span class="chip">GPS</span> <span id="mini-date" class="chip">—/—/—</span></div>
      <div class="hud-line"><strong>Próxima:</strong> <span id="mini-next-name">—</span></div>
      <div class="hud-line"><span id="mini-next-dist">—</span> • <span id="mini-next-eta">—</span></div>
    </div>
  </div>

  <!-- Adicionar Local -->
  <div class="bg-white p-5 mb-6 shadow-md rounded-xl">
    <h2 class="text-lg font-semibold text-travel-800 mb-4">Adicionar Local</h2>
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Pesquisar</label>
        <div class="relative">
          <input id="search" type="text" class="w-full p-3 border border-gray-200 rounded-lg" placeholder="Digite o nome de um local">
          <button id="btn-search" type="button" class="absolute right-2 top-2 bg-travel-500 text-white p-2 rounded-lg" title="Buscar">🔍</button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
          <input id="place-name" class="w-full p-3 border border-gray-200 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Custo (R$)</label>
          <input id="place-value" type="number" min="0" step="0.01" class="w-full p-3 border border-gray-200 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
          <select id="place-category" class="w-full p-3 border border-gray-200 rounded-lg">
            <option value="attraction">Atração Turística</option>
            <option value="park">Parque/Natureza</option>
            <option value="hotel">Hotel/Hospedagem</option>
            <option value="restaurant">Restaurante</option>
            <option value="museum">Museu/Cultural</option>
            <option value="shopping">Compras</option>
            <option value="other">Outro</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Data</label>
          <input id="place-date" type="date" class="w-full p-3 border border-gray-200 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Prioridade</label>
          <select id="place-priority" class="w-full p-3 border border-gray-200 rounded-lg">
            <option value="must">Quero muito</option>
            <option value="maybe" selected>Talvez</option>
            <option value="low">Baixa</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Abre</label>
          <input id="place-open" type="time" class="w-full p-3 border border-gray-200 rounded-lg" placeholder="09:00">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
          <input id="place-close" type="time" class="w-full p-3 border border-gray-200 rounded-lg" placeholder="18:00">
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
        <textarea id="place-notes" rows="2" class="w-full p-3 border border-gray-200 rounded-lg" placeholder="Dica, prato recomendado, ingresso, etc."></textarea>
      </div>

      <button id="add-place" type="button" class="w-full bg-travel-600 text-white py-3 rounded-lg font-medium hover:bg-travel-700 transition">
        Adicionar Local
      </button>
      <div class="text-xs text-gray-500">Após buscar, um pino <b>azul claro</b> aparece (arrastável). Ao salvar, vira pino persistente com ícone e nome.</div>
    </div>
  </div>

  <!-- Locais da Data -->
  <div class="bg-white p-5 mb-6 shadow-md rounded-xl">
    <h2 class="text-lg font-semibold text-travel-800 mb-4">Locais da Data</h2>
    <div id="places-list" class="space-y-3"></div>
    <p class="text-xs text-gray-500 mt-2">Mostrando apenas os locais da <b>data selecionada</b>. Use os botões para reordenar dentro da data.</p>
  </div>

  <!-- Resumo -->
  <div class="bg-white p-5 shadow-md rounded-xl">
    <h2 class="text-lg font-semibold text-travel-800 mb-4">Resumo (Data Selecionada)</h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
      <div class="bg-travel-50 p-3 rounded-lg"><p class="text-sm text-gray-600">Distância</p><p id="total-distance" class="text-xl font-bold text-travel-700">0 km</p></div>
      <div class="bg-travel-50 p-3 rounded-lg"><p class="text-sm text-gray-600">Tempo</p><p id="total-time" class="text-xl font-bold text-travel-700">0 min</p></div>
      <div class="bg-travel-50 p-3 rounded-lg"><p class="text-sm text-gray-600">Combustível</p><p id="fuel-cost" class="text-xl font-bold text-travel-700">R$ 0,00</p></div>
      <div class="bg-travel-50 p-3 rounded-lg"><p class="text-sm text-gray-600">Custo Total</p><p id="total-cost" class="text-xl font-bold text-travel-700">R$ 0,00</p></div>
    </div>
    <div id="route-details" class="space-y-2"></div>
  </div>

</main>

<!-- Cluster -->
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

<script>
/* ==================== CONFIG ==================== */
const GM_API_KEY = 'AIzaSyDwbThPtdCFKguYQggrrdJsiyJbPyDeKZc'; // ou localStorage['gm_api_key'] / ?gm_key=
const categoryStyles = {
  attraction:{ color:'#ef4444', name:'Atração', emoji:'📷' },
  park:{ color:'#10b981', name:'Parque', emoji:'🌳' },
  hotel:{ color:'#14b8a6', name:'Hotel', emoji:'🛏️' },
  restaurant:{ color:'#f97316', name:'Restaurante', emoji:'🍽️' },
  museum:{ color:'#f59e0b', name:'Museu', emoji:'🏛️' },
  shopping:{ color:'#8b5cf6', name:'Compras', emoji:'🛍️' },
  other:{ color:'#6b7280', name:'Outro', emoji:'📍' }
};

/* ==================== HELPERS ==================== */
const showToast=(m,err=false)=>{ const t=document.createElement('div'); t.className='toast'+(err?' error':''); t.textContent=m; document.body.appendChild(t); setTimeout(()=>{t.style.opacity='0'; setTimeout(()=>t.remove(),300)},2800) };
const formatCurrency=v=>(Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const escapeHtml=str=>!str?'':String(str).replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
const hav=(a,b)=>{const R=6371000,toRad=d=>d*Math.PI/180;const dLat=toRad(b.lat-a.lat),dLng=toRad(b.lng-a.lng);const s1=Math.sin(dLat/2),s2=Math.sin(dLng/2);const A=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;return 2*R*Math.asin(Math.sqrt(A))};
function computeHeading(a,b){const toRad=d=>d*Math.PI/180,toDeg=r=>r*180/Math.PI;const lat1=toRad(a.lat),lat2=toRad(b.lat),dLon=toRad(b.lng-a.lng);const y=Math.sin(dLon)*Math.cos(lat2);const x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);return (toDeg(Math.atan2(y,x))+360)%360;}
function hexToRgba(hex,a=1){ if(!hex) return`rgba(0,0,0,${a})`; const h=hex.replace('#',''); const n=parseInt(h,16); const r=(n>>16)&255, g=(n>>8)&255, b=n&255; return`rgba(${r},${g},${b},${a})` }
function markerSVG(name='Local', color='#0ea5e9', emoji='📍'){
  const label = escapeHtml(name.length>20?name.slice(0,18)+'…':name);
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="160" height="52" viewBox="0 0 160 52">
    <defs><filter id="s" x="-20%" y="-20%" width="140%" height="140%"><feDropShadow dx="0" dy="1" stdDeviation="1" flood-opacity="0.25"/></filter></defs>
    <g filter="url(#s)">
      <path d="M22 6 a10 10 0 0 1 10 10 c0 10 -10 16 -10 22 c-0 -6 -10 -12 -10 -22 a10 10 0 0 1 10 -10z" fill="${color}"/>
      <circle cx="22" cy="16" r="4" fill="#fff"/>
      <rect x="36" y="8" rx="10" ry="10" width="118" height="32" fill="#fff" stroke="${color}" stroke-width="1.6"/>
      <text x="52" y="28" font-size="14" font-family="Roboto, Arial" fill="#111827">${label}</text>
      <text x="40" y="28" font-size="15"> ${emoji}</text>
    </g>
  </svg>`;
  return 'data:image/svg+xml;charset=UTF-8,'+encodeURIComponent(svg);
}
function parseTimeToToday(timeStr){ if(!timeStr) return null; const [h,m]=timeStr.split(':').map(Number); const d=new Date(); d.setHours(h||0,m||0,0,0); return d; }
function minutesDiff(a,b){ return Math.round((a-b)/60000); }
function todayISO(){ const d=new Date(); const z=d.getTimezoneOffset(); const d2=new Date(d.getTime()-z*60000); return d2.toISOString().slice(0,10); }
function formatDateBR(iso){ if(!iso) return '—/—/—'; try{ return new Date(iso+'T00:00:00').toLocaleDateString('pt-BR'); }catch(e){ return '—/—/—'; } }

/* ==================== ESTADO ==================== */
let map, fsMap, infoWindow, placesService, directionsService, directionsRendererMain, directionsRendererTemp;
let places=[], generalExpenses=[];
let markers=[], markersFS=[], clusterMain=null;
let watchId=null, isTracking=false, followMode=true;
let currentPositionMarker=null, currentPositionMarkerFS=null;
let pathCoordinates=[], pathPolylineMain=null, pathPolylineFS=null;
let tempDestination=null, tempNavActive=false, lastTempRecalcAt=0;
let lastRouteResult=null, lastRouteResultSaved=null;
let searchTempMarker=null, searchTempMarkerFS=null, mapClickMarker=null;
let currentStopIndex=1; // dentro da data (0 = origem)
const NEAR_STOP_THRESHOLD=120;
let nextLegETA=null,nextLegDist=null,nextStepText='—';
let lastMainRecalcAt=0; const RECALC_MIN_MS=12000, RECALC_MIN_MOVE=60;

/* ==================== DATA SELECIONADA ==================== */
function getSelectedDate(){ const el=document.getElementById('current-date'); return el?.value || todayISO(); }
function setSelectedDate(v){ const el=document.getElementById('current-date'); if(el) el.value=v; document.getElementById('place-date')?.setAttribute('value', v); }

/* ==================== MAPAS ==================== */
function createCarIcon(headingDeg=0){
  const size=36;
  const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
    <g transform="translate(${size/2},${size/2}) rotate(${headingDeg}) translate(${-size/2},${-size/2})">
      <circle cx="${size/2}" cy="${size/2}" r="${size/2 - 1}" fill="#0b74de" opacity="0.95"/>
      <path d="M ${size/2} ${6} L ${size/2 + 6} ${size/2 + 6} L ${size/2} ${size/2 + 2} L ${size/2 - 6} ${size/2 + 6} Z" fill="white"/>
    </g>
  </svg>`;
  return { url:'data:image/svg+xml;charset=UTF-8,'+encodeURIComponent(svg), scaledSize:new google.maps.Size(size,size), anchor:new google.maps.Point(size/2,size/2) };
}

function initMap(){
  // define data inicial
  if(!document.getElementById('current-date').value) setSelectedDate(todayISO());
  document.getElementById('place-date').value = getSelectedDate();

  const initial={lat:-15.795,lng:-47.891};
  map=new google.maps.Map(document.getElementById('map'),{center:initial,zoom:13,mapTypeControl:true,streetViewControl:false,gestureHandling:'greedy',styles:[{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]}]});
  fsMap=new google.maps.Map(document.getElementById('fs-map'),{center:initial,zoom:15,mapTypeControl:false,streetViewControl:false,gestureHandling:'greedy',styles:[{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]}]});

  infoWindow=new google.maps.InfoWindow();
  placesService=new google.maps.places.PlacesService(map);
  directionsService=new google.maps.DirectionsService();
  directionsRendererMain=new google.maps.DirectionsRenderer({map, suppressMarkers:true, polylineOptions:{strokeColor:'#0ea5e9',strokeOpacity:.95,strokeWeight:6}});
  directionsRendererTemp=new google.maps.DirectionsRenderer({map, suppressMarkers:true, polylineOptions:{strokeColor:'#16a34a',strokeOpacity:.95,strokeWeight:6}});

  // Duas polylines (uma para cada mapa) para não "pular"
  pathPolylineMain=new google.maps.Polyline({path:pathCoordinates,geodesic:true,strokeColor:'#0b74de',strokeOpacity:1,strokeWeight:4});
  pathPolylineFS=new google.maps.Polyline({path:pathCoordinates,geodesic:true,strokeColor:'#0b74de',strokeOpacity:1,strokeWeight:4});
  pathPolylineMain.setMap(map);
  pathPolylineFS.setMap(fsMap);

  map.addListener('click', onMapClickAdd);
  [map,fsMap].forEach(m=>{
    m.addListener('dragstart', ()=>{ if(isTracking) pauseFollow(); });
    m.addListener('zoom_changed', ()=>{ if(isTracking) pauseFollow(); });
  });

  loadData(); // inclui migração day->date
  buildFiltersListeners();
  buildUIListeners();
  renderPlaces();
  updateRoute();

  updateHUDDateModeBadges();
}

/* ==================== FULLSCREEN ==================== */
function fsOverlay(){ return document.getElementById('fs-overlay'); }
async function enterFullscreen(){
  try{ if(fsOverlay().requestFullscreen) await fsOverlay().requestFullscreen(); }catch(e){}
  fsOverlay().classList.add('active');
  document.getElementById('fs-hud').style.display='block';
  // renderers passam a desenhar no fsMap
  directionsRendererMain.setMap(fsMap);
  directionsRendererTemp.setMap(fsMap);
  document.getElementById('hud-mini').style.display='none';
  mirrorSearchMarkerToFS(true);
  if(currentPositionMarker) recenter(true);
  updateHUDDateModeBadges();
}
async function exitFullscreen(){
  try{ if(document.fullscreenElement) await document.exitFullscreen(); }catch(e){}
  fsOverlay().classList.remove('active');
  document.getElementById('fs-hud').style.display='none';
  // renderers voltam ao mapa normal
  directionsRendererMain.setMap(map);
  directionsRendererTemp.setMap(map);
  document.getElementById('hud-mini').style.display=isTracking?'block':'none';
  mirrorSearchMarkerToFS(false);
  if(currentPositionMarker) recenter(false);
}
function activeMap(){ return (document.fullscreenElement || fsOverlay().classList.contains('active')) ? fsMap : map; }
function updateHUDDateModeBadges(){
  document.getElementById('hud-date').textContent = formatDateBR(getSelectedDate());
  document.getElementById('mini-date').textContent = formatDateBR(getSelectedDate());
  document.getElementById('hud-travel').textContent = (getTravelMode()===google.maps.TravelMode.WALKING?'A pé':'Dirigindo');
}

/* ==================== GPS ==================== */
function startGPSTracking({goFullscreen=true}={}){
  if(!navigator.geolocation){ showToast('Geolocalização não suportada',true); return; }
  if(isTracking) return;
  isTracking=true; followMode=true; tempNavActive=false; currentStopIndex=1;
  document.getElementById('hud-mini').style.display='block';
  if(goFullscreen) enterFullscreen();
  showToast('Iniciando GPS...');
  pathCoordinates=[]; pathPolylineMain.setPath(pathCoordinates); pathPolylineFS.setPath(pathCoordinates);

  watchId=navigator.geolocation.watchPosition(pos=>{
    if(!isTracking) return;
    const p={lat:pos.coords.latitude,lng:pos.coords.longitude};

    if(!currentPositionMarker){
      currentPositionMarker=new google.maps.Marker({position:p,map,icon=createCarIcon(0),zIndex:1000,title:'Você'});
      currentPositionMarkerFS=new google.maps.Marker({position:p,map:fsMap,icon=createCarIcon(0),zIndex:1000,title:'Você'});
    }else{
      const prev = pathCoordinates[pathCoordinates.length-1] || p;
      const heading = computeHeading(prev,p);
      currentPositionMarker.setPosition(p); currentPositionMarker.setIcon(createCarIcon(heading));
      currentPositionMarkerFS.setPosition(p); currentPositionMarkerFS.setIcon(createCarIcon(heading));
    }
    if(!pathCoordinates.length || hav(pathCoordinates[pathCoordinates.length-1],p)>3){ pathCoordinates.push(p); pathPolylineMain.setPath(pathCoordinates); pathPolylineFS.setPath(pathCoordinates); }
    if(followMode) recenter();

    if(tempNavActive && tempDestination){
      updateTempHUD(p, tempDestination);
      maybeRecalcTempRoute(p, tempDestination);
    } else {
      updateNextStopHUD(p);
      maybeRecalcMainRouteFromCurrent(p);
    }

  }, err=>{
    showToast(err?.code===1?'Permissão negada':err?.code===2?'Localização indisponível':err?.code===3?'Tempo esgotado':'Erro de GPS',true);
    stopGPSTracking();
  }, {enableHighAccuracy:true,maximumAge:3000,timeout:27000});

  const b=document.getElementById('start-trip'); b.textContent='Parar Rastreamento'; b.classList.remove('bg-travel-600'); b.classList.add('bg-red-600','tracking');
  updateHUDDateModeBadges();
}
function stopGPSTracking(){
  try{ if(watchId) navigator.geolocation.clearWatch(watchId); }catch(e){}
  watchId=null; isTracking=false; followMode=false;
  tempNavActive=false; tempDestination=null; directionsRendererTemp.setMap(activeMap()); directionsRendererTemp.set('directions', null);
  document.getElementById('abort-temp').style.display='none';
  document.getElementById('hud-mini').style.display='none';
  nextLegDist=nextLegETA=null; nextStepText='—'; updateHUDLabels();
  exitFullscreen();
  const b=document.getElementById('start-trip'); b.textContent='Iniciar Viagem'; b.classList.add('bg-travel-600'); b.classList.remove('bg-red-600','tracking');
}
function recenter(useFSAuto){
  const m = (useFSAuto??(document.fullscreenElement||fsOverlay().classList.contains('active'))) ? fsMap : activeMap();
  if(!currentPositionMarker) return;
  const pos=currentPositionMarker.getPosition();
  try{ m.panTo(pos); if(m.getZoom()<15) m.setZoom(15);}catch(e){}
}
function pauseFollow(){ followMode=false; setTimeout(()=>{ if(isTracking) followMode=true; },8000); }

/* ==================== HUD ==================== */
function getTravelMode(){ return document.getElementById('travel-mode').value === 'WALKING' ? google.maps.TravelMode.WALKING : google.maps.TravelMode.DRIVING; }
function visitDurationMin(){ return parseInt(document.getElementById('visit-duration').value)||60; }
function dayStartTime(){ return document.getElementById('day-start').value || '09:00'; }

function updateHUDLabels(){
  const act=getActivePlaces(true);
  const next=act[currentStopIndex]||null;
  const name=next?(next.name||'—'):'—';
  document.getElementById('hud-next-name').textContent=name;
  document.getElementById('hud-next-dist').textContent=nextLegDist||'—';
  document.getElementById('hud-next-eta').textContent=nextLegETA||'—';
  document.getElementById('hud-next-step').textContent=nextStepText||'—';
  document.getElementById('mini-next-name').textContent=name;
  document.getElementById('mini-next-dist').textContent=nextLegDist||'—';
  document.getElementById('mini-next-eta').textContent=nextLegETA||'—';
}
function updateNextStopHUD(currentPos){
  const act=getActivePlaces(true);
  if(act.length<2){ nextLegETA=nextLegDist=null; nextStepText='—'; updateHUDLabels(); return; }
  if(currentStopIndex<1) currentStopIndex=1;
  if(currentStopIndex>=act.length) currentStopIndex=act.length-1;

  const target=act[currentStopIndex];
  const dist=hav(currentPos,{lat:target.lat,lng:target.lng});
  if(dist<=NEAR_STOP_THRESHOLD && currentStopIndex<act.length-1){
    target.visited=true; saveData(); renderPlaces();
    currentStopIndex++; showToast(`Chegou em ${target.name}. Próxima: ${act[currentStopIndex].name}`);
  }
  const nextTarget=act[currentStopIndex];
  directionsService.route({origin:currentPos,destination:{lat:nextTarget.lat,lng:nextTarget.lng},travelMode:getTravelMode()},(res,status)=>{
    if(status==='OK'){
      try{
        const leg=res.routes[0].legs[0];
        nextLegDist=leg.distance.text; nextLegETA=leg.duration.text;
        const step=(leg.steps&&leg.steps[0])?leg.steps[0]:null;
        nextStepText=step? step.instructions.replace(/<[^>]+>/g,'') : '—';
        maybeWarnClosing(nextTarget, leg.duration.value);
      }catch(e){ nextLegDist=nextLegETA=null; nextStepText='—'; }
    }
    updateHUDLabels();
  });
}
function updateTempHUD(currentPos, poi){
  directionsService.route({origin:currentPos, destination:{lat:poi.lat,lng:poi.lng}, travelMode:getTravelMode()}, (res, status)=>{
    if(status==='OK'){
      try{
        const leg=res.routes[0].legs[0];
        nextLegDist=leg.distance.text; nextLegETA=leg.duration.text;
        const step=(leg.steps&&leg.steps[0])?leg.steps[0]:null;
        nextStepText=step? step.instructions.replace(/<[^>]+>/g,'') : '—';
        document.getElementById('hud-next-name').textContent = poi.name || '—';
        document.getElementById('mini-next-name').textContent = poi.name || '—';
      }catch(e){}
    }
    updateHUDLabels();
  });
}
function maybeWarnClosing(place, etaSec){
  if(!place.close) return;
  const now=new Date();
  const close=parseTimeToToday(place.close);
  if(!close) return;
  const left = minutesDiff(close, now);
  const etaMin = Math.round((etaSec||0)/60);
  if(left<=30 && etaMin>left){ showToast(`${place.name} fecha em ${left} min e seu ETA é ${etaMin} min. Considere inverter a ordem.`); }
}

/* ==================== Rotas: principal ==================== */
function maybeRecalcMainRouteFromCurrent(currentPos){
  if(tempNavActive) return;
  const now=Date.now(); if(now-lastMainRecalcAt<RECALC_MIN_MS) return;
  const last=pathCoordinates[pathCoordinates.length-1]||null;
  if(last && hav(last,currentPos)<RECALC_MIN_MOVE) return;
  lastMainRecalcAt=now; updateMainRouteFromCurrentPosition(currentPos);
}
function updateMainRouteFromCurrentPosition(currentPos){
  const act=getActivePlaces(true);
  if(!isTracking || act.length<2) return;
  const origin={lat:currentPos.lat,lng:currentPos.lng};
  const remaining=act.slice(Math.max(1,currentStopIndex), act.length-1).filter(p=>!p.visited);
  const waypoints=remaining.map(p=>({location:{lat:p.lat,lng:p.lng},stopover:true}));
  const request={origin,destination:{lat:act[act.length-1].lat,lng:act[act.length-1].lng},waypoints,travelMode:getTravelMode(),optimizeWaypoints:false};
  directionsService.route(request,(result,status)=>{
    if(status==='OK'){
      directionsRendererMain.setOptions({preserveViewport:true});
      directionsRendererMain.setMap(activeMap());
      directionsRendererMain.setDirections(result);
      lastRouteResult=result; lastRouteResultSaved=JSON.parse(JSON.stringify(result));
      renderRouteDetails(result, act); updateStats();
    }
  });
}

/* ==================== Rota temporária ==================== */
function setTemporaryDestination(poi){
  tempDestination=poi; tempNavActive=true;
  document.getElementById('abort-temp').style.display='block';
  showToast(`Rota temporária: ${poi.name}`);
  const start = currentPositionMarker ? {lat:currentPositionMarker.getPosition().lat(), lng:currentPositionMarker.getPosition().lng()} : {lat:activeMap().getCenter().lat(), lng:activeMap().getCenter().lng()};
  computeTempRoute(start, poi, {fit:!isTracking});
  document.getElementById('hud-next-name').textContent = poi.name || '—';
  document.getElementById('mini-next-name').textContent = poi.name || '—';
}
function computeTempRoute(startLatLng, poi, {fit=true}={}){
  directionsService.route({origin:startLatLng,destination:{lat:poi.lat,lng:poi.lng},travelMode:getTravelMode()},(result,status)=>{
    if(status==='OK'){
      directionsRendererTemp.setOptions({preserveViewport:isTracking});
      directionsRendererTemp.setMap(activeMap());
      directionsRendererTemp.setDirections(result);
      if(fit && !isTracking){
        try{ const b=new google.maps.LatLngBounds(); b.extend(result.routes[0].legs[0].start_location); b.extend(result.routes[0].legs[0].end_location); activeMap().fitBounds(b);}catch(e){}
      }
      renderTempDetails(result,poi);
    } else showToast('Erro rota temporária: '+status,true);
  });
}
function maybeRecalcTempRoute(currentPos, poi){
  const now=Date.now(); if(now-lastTempRecalcAt<RECALC_MIN_MS) return;
  lastTempRecalcAt=now; computeTempRoute(currentPos, poi, {fit:false});
}
function renderTempDetails(res,poi){
  const c=document.getElementById('route-details'); let html='<h3 class="font-semibold mb-2">Detalhes do Percurso (Data):</h3>';
  if(lastRouteResult?.routes) html+='<div class="text-sm text-gray-600 mb-2">Rota principal (salva)</div>';
  try{
    const leg=res.routes[0].legs[0];
    html+=`<div class="bg-green-50 p-3 rounded-lg mb-2"><div class="flex justify-between items-center">
      <div><p class="font-medium">Rota temporária → ${escapeHtml(poi.name)}</p><p class="text-sm text-gray-600">${leg.distance.text} • ${leg.duration.text}</p></div>
      <p class="text-travel-700 font-medium">${leg.duration.text}</p></div></div>`;
  }catch(e){}
  c.innerHTML=html;
}
function abortTemporaryRoute(){
  tempNavActive=false; tempDestination=null; directionsRendererTemp.setMap(activeMap()); directionsRendererTemp.set('directions', null);
  document.getElementById('abort-temp').style.display='none';
  showToast('Voltando à rota original.');
  if(lastRouteResultSaved){
    lastRouteResult=JSON.parse(JSON.stringify(lastRouteResultSaved));
    directionsRendererMain.setMap(activeMap()); directionsRendererMain.setDirections(lastRouteResult);
    renderRouteDetails(lastRouteResult, getActivePlaces(true)); updateStats();
  } else document.getElementById('route-details').innerHTML='';
}

/* ==================== FILTRO POR DATA ==================== */
function getActivePlaces(includeVisited=true){
  const d=getSelectedDate();
  const arr = places.filter(p=> (p.routeDate||'')===d );
  return includeVisited ? arr : arr.filter(p=>!p.visited);
}

/* ==================== PINGOS (Locais da data) ==================== */
function rebuildMarkers(){
  markers.forEach(m=>m.setMap(null)); markers=[]; markersFS.forEach(m=>m.setMap(null)); markersFS=[];
  if(clusterMain){ clusterMain.clearMarkers(); clusterMain=null; }

  const actAll = getActivePlaces(true);
  if(!actAll?.length) return;
  const allowedCats = Array.from(document.querySelectorAll('.flt-cat')).filter(c=>c.checked).map(c=>c.value);
  const showVisited = document.getElementById('flt-visited').checked;

  actAll.forEach(p=>{
    if(!allowedCats.includes(p.category)) return;
    if(!showVisited && p.visited) return;

    const style=categoryStyles[p.category]||categoryStyles.other;
    const iconUrl = markerSVG(p.name||'Local', style.color, style.emoji);

    const m1=new google.maps.Marker({
      position:{lat:p.lat,lng:p.lng},
      map, title:p.name,
      icon:{ url:iconUrl, scaledSize:new google.maps.Size(160,52), anchor:new google.maps.Point(22,48) }
    });
    const m2=new google.maps.Marker({
      position:{lat:p.lat,lng:p.lng},
      map:fsMap, title:p.name,
      icon:{ url:iconUrl, scaledSize:new google.maps.Size(160,52), anchor:new google.maps.Point(22,48) }
    });

    const openInfo=(marker)=>{
      const cat=categoryStyles[p.category]||categoryStyles.other;
      const content=`<div style="max-width:280px">
        <h3 style="margin:0 0 6px 0;font-weight:700">${escapeHtml(p.name)} ${p.priority==='must'?'<span class="chip">Quero muito</span>':p.priority==='maybe'?'<span class="chip">Talvez</span>':'<span class="chip muted">Baixa</span>'}</h3>
        <div style="color:${cat.color};font-weight:600;margin-bottom:6px">${cat.name}</div>
        ${p.address?`<div style="font-size:12px;color:#6b7280">${escapeHtml(p.address)}</div>`:''}
        ${(p.open||p.close)?`<div class="text-xs text-gray-600 mt-1">Horário: ${p.open?p.open:'—'} – ${p.close?p.close:'—'}</div>`:''}
        ${p.notes?`<div class="text-xs text-gray-600 mt-2"><b>Notas:</b> ${escapeHtml(p.notes)}</div>`:''}
        <div class="divider"></div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button id="iw-go" class="btn bg-travel-600 text-white">Ir agora</button>
          <button id="iw-next" class="btn bg-travel-100 text-travel-700">Definir como próxima</button>
          <button id="iw-vis" class="btn bg-green-100 text-green-700">${p.visited?'Desmarcar visitado':'Marcar visitado'}</button>
        </div>
      </div>`;
      infoWindow.setContent(content); infoWindow.open(marker.getMap(), marker);
      google.maps.event.addListenerOnce(infoWindow,'domready',()=>{
        document.getElementById('iw-go')?.addEventListener('click',()=>{ setTemporaryDestination(p); infoWindow.close(); });
        document.getElementById('iw-next')?.addEventListener('click',()=>{ const act=getActivePlaces(true); const idx=act.findIndex(q=>q===p); if(idx>=0){ currentStopIndex=Math.max(1,idx); renderPlaces(); showToast('Próxima parada definida.'); } infoWindow.close(); });
        document.getElementById('iw-vis')?.addEventListener('click',()=>{ p.visited=!p.visited; saveData(); renderPlaces(); updateRoute(); infoWindow.close(); });
      });
    };

    m1.addListener('click',()=>openInfo(m1));
    m2.addListener('click',()=>openInfo(m2));

    markers.push(m1); markersFS.push(m2);
  });

  clusterMain = new markerClusterer.MarkerClusterer({ map, markers, algorithm: new markerClusterer.SuperClusterAlgorithm({radius:60}) });
}

/* ==================== RENDER LISTA (data) ==================== */
function renderPlaces(){
  const el=document.getElementById('places-list'); el.innerHTML='';
  const act=getActivePlaces(true);
  if(!act.length){ el.innerHTML='<div class="text-center py-4 text-gray-500">Nenhum local nesta data</div>'; rebuildMarkers(); updateStats(); document.getElementById('place-date').value=getSelectedDate(); return; }
  act.forEach((p,i)=>{
    const cat=categoryStyles[p.category]||categoryStyles.other; const badgeBg=hexToRgba(cat.color,.12);
    const item=document.createElement('div'); item.className='place-item bg-white p-4 rounded-lg border border-gray-200';
    item.innerHTML=`<div class="flex justify-between items-start">
      <div>
        <div class="flex items-center gap-2">
          <h3 class="font-semibold text-travel-800">${escapeHtml(p.name)}</h3>
          <span class="category-badge" style="background:${badgeBg};color:${cat.color}">${cat.name}</span>
          ${p.priority==='must'?'<span class="chip">Quero muito</span>':p.priority==='maybe'?'<span class="chip">Talvez</span>':'<span class="chip muted">Baixa</span>'}
          ${p.visited?'<span class="visit-badge">Visitado</span>':''}
          ${(isTracking && i===currentStopIndex)?'<span class="chip">Próxima</span>':''}
        </div>
        ${(p.open||p.close)?`<p class="text-xs text-gray-500 mt-1">Horário: ${p.open?p.open:'—'} – ${p.close?p.close:'—'}</p>`:''}
        ${p.notes?`<p class="text-xs text-gray-600 mt-1">${escapeHtml(p.notes)}</p>`:''}
      </div>
      <div class="flex gap-2 items-center">
        <button data-i="${i}" title="Ir agora" class="go-now p-1">▶</button>
        <button data-i="${i}" title="Próxima" class="set-next p-1">➤</button>
        <button data-i="${i}" title="Visitado" class="toggle-visited p-1">✓</button>
        <button data-i="${i}" title="Subir" class="move-up p-1">▲</button>
        <button data-i="${i}" title="Descer" class="move-down p-1">▼</button>
        <button data-i="${i}" title="Remover" class="delete-place p-1 text-red-500">✕</button>
      </div>
    </div>`;
    el.appendChild(item);
  });
  rebuildMarkers();
  updateStats();
}

/* ==================== ROTA PRINCIPAL (data) ==================== */
function updateRoute(){
  rebuildMarkers();
  const act=getActivePlaces(true);
  if(!act.length){
    directionsRendererMain.setMap(activeMap()); directionsRendererMain.set('directions', null);
    directionsRendererTemp.setMap(activeMap()); directionsRendererTemp.set('directions', null);
    lastRouteResult=null; lastRouteResultSaved=null;
    document.getElementById('route-details').innerHTML=''; updateStats(); return;
  }
  if(act.length===1){
    directionsRendererMain.setMap(activeMap()); directionsRendererMain.set('directions', null);
    activeMap().panTo(new google.maps.LatLng(act[0].lat,act[0].lng)); activeMap().setZoom(15);
    document.getElementById('route-details').innerHTML=''; updateStats(); return;
  }
  const waypoints=act.slice(1,-1).map(p=>({location:{lat:p.lat,lng:p.lng},stopover:true}));
  directionsService.route({origin:{lat:act[0].lat,lng:act[0].lng},destination:{lat:act[act.length-1].lat,lng:act[act.length-1].lng},waypoints,travelMode:getTravelMode(),optimizeWaypoints:false},(res,status)=>{
    if(status==='OK'){
      directionsRendererMain.setOptions({preserveViewport:isTracking});
      directionsRendererMain.setMap(activeMap());
      directionsRendererMain.setDirections(res);
      lastRouteResult=res; lastRouteResultSaved=JSON.parse(JSON.stringify(res));
      if(!isTracking){
        try{ const b=new google.maps.LatLngBounds(); res.routes[0].legs.forEach(leg=>{b.extend(leg.start_location);b.extend(leg.end_location)}); activeMap().fitBounds(b);}catch(e){}
      }
      renderRouteDetails(res, act); updateStats();
    }else{
      showToast('Erro ao calcular rota: '+status,true); lastRouteResult=null; updateStats();
    }
  });
}
function renderRouteDetails(res, actArr){
  const c=document.getElementById('route-details'); c.innerHTML='<h3 class="font-semibold mb-2">Detalhes do Percurso (Data):</h3>';
  if(!res?.routes?.[0]){ c.innerHTML+='<div class="text-gray-500">Sem detalhes.</div>'; return; }
  const legs=res.routes[0].legs||[];
  legs.forEach((leg,i)=>{
    const from=actArr[i]||{name:'Ponto'}, to=actArr[i+1]||{name:'Destino'};
    const d=document.createElement('div'); d.className='bg-gray-50 p-3 rounded-lg mb-2';
    d.innerHTML=`<div class="flex justify-between items-center">
      <div><p class="font-medium">${escapeHtml(from.name)} → ${escapeHtml(to.name)}</p>
      <p class="text-sm text-gray-600">${leg.distance.text} • ${leg.duration.text}</p></div>
      <p class="text-travel-700 font-medium">${leg.duration.text}</p></div>`;
    c.appendChild(d);
  });
}

/* ==================== PLANEJAR ORDEM (por data) ==================== */
function planBestOrder({useCurrent=false, roundTrip=false, skipVisited=true}={}){
  const actAll=getActivePlaces(true);
  if(actAll.length<2){ showToast('Adicione pelo menos 2 locais nesta data',true); return; }

  let act = skipVisited ? actAll.filter(p=>!p.visited) : actAll.slice();
  // prioridade: must < maybe < low
  act.sort((a,b)=> (a.priority==='must'?0:a.priority==='maybe'?1:2) - (b.priority==='must'?0:b.priority==='maybe'?1:2) );

  const mode=getTravelMode();

  if(mode===google.maps.TravelMode.WALKING && useCurrent && currentPositionMarker){
    const start={lat:currentPositionMarker.getPosition().lat(), lng:currentPositionMarker.getPosition().lng()};
    const ordered = nearestNeighborOrder(start, act.slice(0, act.length-1)).concat([act[act.length-1]]);
    applyNewOrderForDate(ordered);
    postPlanTimeChecks(ordered);
    return;
  }

  const origin = useCurrent && currentPositionMarker ? {lat:currentPositionMarker.getPosition().lat(), lng:currentPositionMarker.getPosition().lng()} : {lat:act[0].lat,lng:act[0].lng};
  const destination = roundTrip ? origin : {lat:act[act.length-1].lat,lng:act[act.length-1].lng};
  const middle = roundTrip ? act : act.slice(1,-1);
  const waypoints = middle.map(p=>({location:{lat:p.lat,lng:p.lng},stopover:true}));

  directionsService.route({origin,destination,waypoints,travelMode:mode,optimizeWaypoints:true},(result,status)=>{
    if(status!=='OK'){ showToast('Não foi possível otimizar: '+status,true); return; }
    try{
      const order=result.routes[0].waypoint_order||[];
      let newAct;
      if(roundTrip){
        const base = act;
        const mid = order.map(i=>base[i]);
        newAct = mid;
      }else{
        const base = act.slice(1,-1);
        const mid = order.map(i=>base[i]);
        newAct = [act[0],...mid,act[act.length-1]];
      }
      applyNewOrderForDate(newAct);
      postPlanTimeChecks(newAct);
      showToast('Ordem otimizada!');
    }catch(e){ showToast('Falha ao aplicar ordem.',true); }
  });
}
function nearestNeighborOrder(start, arr){
  const left=arr.slice(); const out=[];
  let cur=start;
  while(left.length){
    let bi=0, bd=Infinity;
    left.forEach((p,i)=>{ const d=hav(cur,{lat:p.lat,lng:p.lng}); if(d<bd){bd=d; bi=i;} });
    const pick=left.splice(bi,1)[0]; out.push(pick); cur={lat:pick.lat,lng:pick.lng};
  }
  return out;
}
function applyNewOrderForDate(newAct){
  const d=getSelectedDate();
  const others=places.filter(p=> (p.routeDate||'')!==d );
  places = others.concat(newAct); // mantém referência dos objetos
  saveData(); renderPlaces(); updateRoute();
}
function postPlanTimeChecks(orderedAct){
  if(!orderedAct.length) return;
  const start = parseTimeToToday(dayStartTime()) || new Date();
  let cursor = new Date(start);
  const dur = visitDurationMin();

  for(let i=0;i<orderedAct.length;i++){
    const p=orderedAct[i];
    const arrv = new Date(cursor);
    const open = parseTimeToToday(p.open);
    const close = parseTimeToToday(p.close);
    if(open && arrv<open){ showToast(`${p.name}: abre às ${p.open}. Talvez mover mais tarde.`); }
    if(close && new Date(arrv.getTime()+dur*60000)>close){ showToast(`${p.name}: pode fechar antes do fim da visita.`); }
    cursor = new Date(arrv.getTime()+dur*60000);
  }
}

/* ==================== BUSCA (sempre pino) ==================== */
function showSearchTempMarker(latLng, placeName, address){
  const icon={url:'https://maps.google.com/mapfiles/ms/icons/lightblue-dot.png',scaledSize:new google.maps.Size(36,36)};
  if(searchTempMarker){ searchTempMarker.setPosition(latLng); searchTempMarker.setTitle(placeName||'Local'); }
  else{
    searchTempMarker=new google.maps.Marker({position:latLng,map,title:placeName||'Local',icon,draggable:true,animation:google.maps.Animation.BOUNCE,zIndex:1100});
    setTimeout(()=>{ searchTempMarker?.setAnimation(null); },1200);
    searchTempMarker.addListener('dragend',()=>{ map.panTo(searchTempMarker.getPosition()); mirrorSearchMarkerToFS(true); });
  }
  mirrorSearchMarkerToFS(true, latLng, placeName);
  map.panTo(latLng); map.setZoom(15);
  document.getElementById('place-name').value ||= (placeName||'');
  document.getElementById('search').value     ||= (address||'');
}
function mirrorSearchMarkerToFS(show, latLng=null, title='Local'){
  if(!fsMap) return;
  if(show){
    const pos = latLng || (searchTempMarker ? searchTempMarker.getPosition() : null);
    if(!pos) return;
    if(searchTempMarkerFS){ searchTempMarkerFS.setPosition(pos); }
    else{
      searchTempMarkerFS = new google.maps.Marker({ position: pos, map: fsMap, title, icon:{url:'https://maps.google.com/mapfiles/ms/icons/lightblue-dot.png',scaledSize:new google.maps.Size(36,36)}, zIndex:1100 });
    }
  }else{
    if(searchTempMarkerFS){ searchTempMarkerFS.setMap(null); searchTempMarkerFS=null; }
  }
}
function doSearch(){
  const q=document.getElementById('search').value.trim();
  if(!q){ showToast('Digite algo para pesquisar.',true); return; }
  if(!google?.maps?.places){ showToast('Serviço de lugares indisponível.',true); return; }
  const s=new google.maps.places.PlacesService(map);
  s.findPlaceFromQuery({query:q,fields:['name','geometry','formatted_address','types']},(res,status)=>{
    if(status===google.maps.places.PlacesServiceStatus.OK && res?.[0]){
      const p=res[0];
      if(p.geometry?.location) showSearchTempMarker(p.geometry.location,p.name||'',p.formatted_address||'');
      document.getElementById('place-name').value=p.name||'';
      document.getElementById('search').value=p.formatted_address||p.name||'';
      let category='other'; const t=p.types||[];
      if(t.includes('park')||t.includes('natural_feature')) category='park';
      else if(t.includes('tourist_attraction')||t.includes('point_of_interest')) category='attraction';
      else if(t.includes('lodging')||t.includes('hotel')) category='hotel';
      else if(t.includes('restaurant')||t.includes('food')) category='restaurant';
      else if(t.includes('museum')||t.includes('art_gallery')) category='museum';
      else if(t.includes('shopping_mall')||t.includes('store')) category='shopping';
      document.getElementById('place-category').value=category;
      showToast('Local encontrado! Ajuste o marcador e clique em Adicionar.');
    }else showToast('Não encontrado. Tente outro termo.',true);
  });
}

/* ==================== FILTROS / UI ==================== */
function buildFiltersListeners(){
  document.querySelectorAll('.flt-cat').forEach(c=>c.addEventListener('change',rebuildMarkers));
  document.getElementById('flt-visited').addEventListener('change',rebuildMarkers);
}
function buildUIListeners(){
  // Data
  document.getElementById('current-date').addEventListener('change',()=>{ document.getElementById('place-date').value=getSelectedDate(); currentStopIndex=1; renderPlaces(); updateRoute(); updateHUDDateModeBadges(); });

  // Modo
  document.getElementById('travel-mode').addEventListener('change',()=>{ updateRoute(); updateHUDDateModeBadges(); });

  // Planejamento
  document.getElementById('btn-plan-best').addEventListener('click',()=>{
    const useCurrent=document.getElementById('plan-use-current').checked;
    const roundTrip=document.getElementById('plan-roundtrip').checked;
    const skipVisited=document.getElementById('plan-skip-visited').checked;
    if(useCurrent && !currentPositionMarker) showToast('Dica: inicie a viagem para usar sua posição.');
    planBestOrder({useCurrent:!!(useCurrent && currentPositionMarker),roundTrip,skipVisited});
  });

  // GPS
  document.getElementById('start-trip').addEventListener('click',()=>{ if(isTracking){ stopGPSTracking(); showToast('Rastreamento parado'); } else { if(getActivePlaces(true).length<1){ showToast('Adicione locais nesta data',true); return; } startGPSTracking({goFullscreen:true}); } });
  document.getElementById('btn-enter-fs').addEventListener('click',()=>enterFullscreen());
  document.getElementById('btn-exit-fs').addEventListener('click',()=>exitFullscreen());
  document.getElementById('btn-recenter').addEventListener('click',()=>{ followMode=true; recenter(); });
  document.getElementById('abort-temp').addEventListener('click',()=>{ if(confirm('Abandonar rota temporária?')) abortTemporaryRoute(); });

  document.getElementById('btn-next-go').addEventListener('click',()=>{
    if(!isTracking){ showToast('Inicie a viagem.',true); return; }
    const act=getActivePlaces(true); if(act.length<2) return;
    if(currentStopIndex<1) currentStopIndex=1;
    const t=act[currentStopIndex]; setTemporaryDestination(t);
  });
  document.getElementById('btn-skip-stop').addEventListener('click',()=>{
    const act=getActivePlaces(true);
    if(currentStopIndex<act.length-1){ act[currentStopIndex].visited=true; saveData(); currentStopIndex++; renderPlaces(); updateHUDLabels(); showToast('Parada pulada.'); }
  });
  document.getElementById('btn-follow').addEventListener('click',()=>{ followMode=true; recenter(); });

  // Rota/clear
  document.getElementById('optimize-route').addEventListener('click',()=>{ updateRoute(); showToast('Rota recalculada.'); });
  document.getElementById('clear-route').addEventListener('click',()=>{
    if(places.length>0 && confirm('Limpar toda a rota e dados?')){
      places=[]; generalExpenses=[];
      saveData(); renderPlaces(); updateRoute();
      stopGPSTracking();
      searchTempMarker?.setMap(null); searchTempMarkerFS?.setMap(null); mapClickMarker?.setMap(null);
      searchTempMarker=null; searchTempMarkerFS=null; mapClickMarker=null;
      pathCoordinates=[]; pathPolylineMain.setPath(pathCoordinates); pathPolylineFS.setPath(pathCoordinates);
      showToast('Tudo limpo!');
    }
  });

  // Adicionar local
  document.getElementById('add-place').addEventListener('click',()=>{
    const name=document.getElementById('place-name').value.trim();
    const value=parseFloat(document.getElementById('place-value').value)||0;
    const category=document.getElementById('place-category').value;
    const routeDate=document.getElementById('place-date').value || getSelectedDate();
    const priority=document.getElementById('place-priority').value||'maybe';
    const open=document.getElementById('place-open').value||'';
    const close=document.getElementById('place-close').value||'';
    const notes=document.getElementById('place-notes').value||'';
    if(!name){ showToast('Dê um nome ao local',true); return; }
    if(!routeDate){ showToast('Selecione uma data',true); return; }
    let lat,lng;
    if(searchTempMarker){ const p=searchTempMarker.getPosition(); lat=p.lat(); lng=p.lng(); }
    else if(mapClickMarker){ const p=mapClickMarker.getPosition(); lat=p.lat(); lng=p.lng(); }
    else { const c=map.getCenter(); lat=c?c.lat():-15.795; lng=c?c.lng():-47.891; }
    const newPlace={name,value,category,lat,lng,address:document.getElementById('search').value||'',createdAt:new Date().toISOString(),visited:false,routeDate,priority,open,close,notes};
    places.push(newPlace); saveData(); renderPlaces(); updateRoute(); showToast('Local adicionado!');
    document.getElementById('place-name').value=''; document.getElementById('place-value').value=''; document.getElementById('place-notes').value='';
    searchTempMarker?.setMap(null); searchTempMarkerFS?.setMap(null); mapClickMarker?.setMap(null);
    searchTempMarker=null; searchTempMarkerFS=null; mapClickMarker=null;
  });

  // Busca
  document.getElementById('btn-search').addEventListener('click',doSearch);
  document.getElementById('search').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); doSearch(); } });

  // Lista de locais
  document.getElementById('places-list').addEventListener('click',(e)=>{
    const btn=e.target.closest('button'); if(!btn) return;
    const i=parseInt(btn.dataset.i); if(isNaN(i)) return;
    const act=getActivePlaces(true);
    const p=act[i];
    if(btn.classList.contains('delete-place')){
      if(confirm('Remover este local?')){
        const idxGlobal=places.indexOf(p);
        if(idxGlobal>=0){ places.splice(idxGlobal,1); saveData(); renderPlaces(); updateRoute(); showToast('Removido.'); }
      }
    }else if(btn.classList.contains('move-up')){
      moveWithinDate(p,-1);
    }else if(btn.classList.contains('move-down')){
      moveWithinDate(p,1);
    }else if(btn.classList.contains('set-next')){
      currentStopIndex=Math.max(1,i); renderPlaces(); showToast('Próxima parada definida.');
    }else if(btn.classList.contains('go-now')){
      setTemporaryDestination(p);
    }else if(btn.classList.contains('toggle-visited')){
      p.visited=!p.visited; saveData(); renderPlaces(); updateRoute();
    }
  });

  // Combustível
  document.getElementById('fuel-efficiency').addEventListener('change',updateStats);
  document.getElementById('fuel-price').addEventListener('change',updateStats);
}
function moveWithinDate(placeObj, dir){
  const d=getSelectedDate();
  const indices=places.map((p,idx)=>({p,idx})).filter(o=> (o.p.routeDate||'')===d ).map(o=>o.idx);
  const iGlobal=places.indexOf(placeObj);
  const pos=indices.indexOf(iGlobal);
  if(pos<0) return;
  const targetPos=pos+dir;
  if(targetPos<0 || targetPos>=indices.length) return;
  const jGlobal=indices[targetPos];
  [places[iGlobal],places[jGlobal]]=[places[jGlobal],places[iGlobal]];
  saveData(); renderPlaces(); updateRoute();
}

/* ==================== PERSISTÊNCIA + MIGRAÇÃO ==================== */
function loadData(){
  try{
    const sp=localStorage.getItem('travel_places'); if(sp) places=JSON.parse(sp); else places=[];
    const se=localStorage.getItem('travel_expenses'); if(se) generalExpenses=JSON.parse(se); else generalExpenses=[];

    // MIGRAÇÃO: antigos que tinham "day" -> "routeDate"
    const migratedFlag = localStorage.getItem('travel_migrated_day_to_date');
    const hasOldDay = places.some(p=> typeof p.day!=='undefined' && !p.routeDate );
    if(!migratedFlag && hasOldDay){
      // tenta usar a menor "createdAt/date" como base, senão hoje:
      let base = todayISO();
      const candidates = places.filter(p=>typeof p.day!=='undefined' && (p.createdAt || p.date));
      if(candidates.length){
        const min = candidates.reduce((acc,p)=>{
          const t = new Date(p.createdAt||p.date).getTime();
          return isNaN(t)?acc:Math.min(acc,t);
        }, Infinity);
        if(min!==Infinity){
          const d=new Date(min); const z=d.getTimezoneOffset(); base = new Date(d.getTime()-z*60000).toISOString().slice(0,10);
        }
      }
      places.forEach(p=>{
        if(typeof p.day!=='undefined' && !p.routeDate){
          const offset=(parseInt(p.day)||1)-1;
          const b=new Date(base+'T00:00:00'); b.setDate(b.getDate()+offset);
          const z=b.getTimezoneOffset(); const b2=new Date(b.getTime()-z*60000);
          p.routeDate=b2.toISOString().slice(0,10);
          delete p.day;
        }
      });
      localStorage.setItem('travel_migrated_day_to_date','1');
      saveData();
    }
  }catch(e){ places=[]; generalExpenses=[]; }
}
function saveData(){
  try{
    localStorage.setItem('travel_places', JSON.stringify(places));
    localStorage.setItem('travel_expenses', JSON.stringify(generalExpenses));
  }catch(e){}
}

/* ==================== ESTATÍSTICAS (data) ==================== */
function updateStats(){
  const act=getActivePlaces(true);
  const placesCost=(act||[]).reduce((s,p)=>s+(parseFloat(p.value)||0),0);
  const expensesCost=0; // exportações/aba de gastos removidas
  let totalDistance=0,totalTime=0,fuelCost=0;
  if(lastRouteResult?.routes?.[0]){
    lastRouteResult.routes[0].legs.forEach(leg=>{ totalDistance += leg.distance?.value||0; totalTime += leg.duration?.value||0; });
    if(getTravelMode()===google.maps.TravelMode.DRIVING){
      const fe=parseFloat(document.getElementById('fuel-efficiency').value)||10;
      const fp=parseFloat(document.getElementById('fuel-price').value)||5.5;
      const fuelConsumption=(totalDistance/1000)/fe; fuelCost=fuelConsumption*fp;
    } else fuelCost=0;
  }
  document.getElementById('total-distance').textContent=(totalDistance/1000).toFixed(1)+' km';
  const h=Math.floor(totalTime/3600), m=Math.round((totalTime%3600)/60);
  document.getElementById('total-time').textContent=(h>0?`${h} h `:'')+`${m} min`;
  document.getElementById('fuel-cost').textContent=formatCurrency(fuelCost||0);
  document.getElementById('total-cost').textContent=formatCurrency(placesCost+expensesCost+(fuelCost||0));
}

/* ==================== MAP CLICK ==================== */
function onMapClickAdd(e){
  if(mapClickMarker) mapClickMarker.setMap(null);
  mapClickMarker=new google.maps.Marker({position:e.latLng,map,icon:{url:'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',scaledSize:new google.maps.Size(36,36)},draggable:true});
  infoWindow.setContent(`<div style="max-width:220px"><b>Novo Local</b><div class="divider"></div><button id="iw-add" class="btn bg-travel-600 text-white">Usar este ponto</button></div>`);
  infoWindow.open(map,mapClickMarker);
  google.maps.event.addListenerOnce(infoWindow,'domready',()=>{
    document.getElementById('iw-add')?.addEventListener('click',()=>{
      const pos=mapClickMarker.getPosition();
      document.getElementById('place-name').value='Novo Local';
      document.getElementById('search').value=`Lat: ${pos.lat().toFixed(6)}, Lng: ${pos.lng().toFixed(6)}`;
      infoWindow.close(); mapClickMarker.setMap(null); mapClickMarker=null;
    });
  });
}

/* ==================== CARREGAR GOOGLE MAPS ==================== */
function getApiKey(){
  const urlParams=new URLSearchParams(window.location.search);
  if(GM_API_KEY && GM_API_KEY!=='YOUR_API_KEY_HERE') return GM_API_KEY;
  const fromLocal=localStorage.getItem('gm_api_key'); if(fromLocal) return fromLocal;
  const fromUrl=urlParams.get('gm_key'); if(fromUrl) return fromUrl;
  return 'YOUR_API_KEY_HERE';
}
function loadGoogleMaps(){
  const key=getApiKey();
  const s=document.createElement('script');
  s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&libraries=places,directions,geometry&callback=initMap`;
  s.async=true; s.defer=true;
  s.onerror=()=>showToast('Falha ao carregar Google Maps. Verifique sua chave/API.',true);
  document.head.appendChild(s);
}
window.addEventListener('DOMContentLoaded', loadGoogleMaps);
</script>
</body>
</html>
