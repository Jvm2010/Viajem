<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fotos & Vídeos — Viagem</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="firebase.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <script>
    // /* auth-check */
    (function(){
      try{
        const auth = sessionStorage.getItem('viagem:auth');
        if(auth !== '1' && auth !== '0'){
          window.location.href = 'index.html';
        }
        // if auth === '0' it's guest: allow but can restrict later
      }catch(e){
        console.error(e);
      }
    })();
  </script>

  <header class="bg-white shadow p-4 sticky top-0 z-10">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <h1 class="text-lg font-semibold">Fotos & Vídeos</h1>
      <nav class="text-sm space-x-4">
        <a href="index.html" class="text-sky-600">Início</a>
        <a href="roteiro.html" class="text-sky-600">Roteiro</a>
      </nav>
    </div>
  </header>

  <main class="max-w-4xl mx-auto p-4 space-y-4">
    <section class="card">
      <h2 class="font-semibold">Galeria</h2>
      <p class="small">Tire fotos direto do celular ou faça upload. Use templates rápidos para criar um "tumblr" estilizado.</p>

      <div class="mt-3 grid grid-cols-1 gap-3">
        <div class="flex gap-2">
          <input id="file-input" type="file" accept="image/*" multiple class="p-2 card" />
          <button id="open-camera" class="badge">Abrir Câmera</button>
        </div>

        <div class="mt-2 grid grid-cols-3 gap-2" id="gallery"></div>

        <div class="mt-4">
          <h4 class="font-semibold">Templates rápidos (para vídeos de casal)</h4>
          <p class="small">Escolha um template e clique em "Criar slideshow" para gerar uma página com transições que pode ser gravada.</p>
          <select id="template" class="p-2 card mt-2">
            <option value="romantic">Romântico - fades suaves com trilha lenta</option>
            <option value="adventure">Aventura - cortes rápidos e zooms</option>
            <option value="cinematic">Cinemático - barras pretas e letras grandes</option>
          </select>
          <div class="mt-2 flex gap-2">
            <button id="make-slideshow" class="badge">Criar slideshow</button>
            <button id="clear-gallery" class="text-sm text-red-600">Limpar galeria</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  
  <script type="module">
  import app, { db, storage } from './firebase.js';
  import { ref, push, set, onValue } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js';
  import { ref as sRef, uploadString, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js';

  const gallery = document.getElementById('gallery');
  const filesInput = document.getElementById('file-input');
  let images = []; // local cache of dataURLs (but we'll upload immediately)

  // load locais list for association
  let locaisList = [];
  onValue(ref(db,'locais'), (snap)=>{
    const val = snap.val() || {};
    locaisList = Object.keys(val).map(k=>({id:k, name: val[k].name}));
  });

  // helper to upload dataURL to storage and link to DB under locais or gastos
  async function uploadAndLink(dataUrl, assocType, assocId){
    const filename = Date.now() + '.jpg';
    let path = 'media/' + filename;
    if(assocType === 'local' && assocId) path = `locais/${assocId}/fotos/${filename}`;
    if(assocType === 'gasto' && assocId) path = `gastos/${assocId}/fotos/${filename}`;
    const sref = sRef(storage, path);
    // upload as data_url
    await uploadString(sref, dataUrl, 'data_url');
    const url = await getDownloadURL(sref);
    // push url into DB under the assoc node
    if(assocType === 'local' && assocId){
      const nodeRef = ref(db, `locais/${assocId}/fotos`);
      const list = (await (await fetch('https://www.gstatic.com/firebasejs/placeholder')).ok) ? [] : []; // noop to keep structure
      // use push by reading current and updating array (simple approach)
      const curSnap = await fetch('/__no__');
    }
    return url;
  }

  async function simpleUploadToMedia(dataUrl){
    const filename = Date.now() + '.jpg';
    const path = 'media/' + filename;
    const sref = sRef(storage, path);
    await uploadString(sref, dataUrl, 'data_url');
    const url = await getDownloadURL(sref);
    // create DB entry in /midia
    const md = { url, created: Date.now() };
    const p = push(ref(db,'midia'));
    await set(p, md);
    return url;
  }

  function render(){
    gallery.innerHTML='';
    images.forEach((d,i)=>{
      const div = document.createElement('div');
      div.className='card p-1';
      div.innerHTML = `<img src="${d}" style="width:100%;height:120px;object-fit:cover;border-radius:8px" /> <div class="small mt-1 text-center"><button data-i="${i}" class="text-sm text-red-600">Remover</button></div>`;
      gallery.appendChild(div);
    });
    localStorage.setItem('viagem:photos', JSON.stringify(images));
  }

  filesInput.addEventListener('change', async (e)=>{
    const files = Array.from(e.target.files);
    for(const f of files){
      const data = await readFileAsDataURL(f);
      // ask association
      const assoc = prompt('Associar a (local id) ou (gasto id) ou deixe em branco para biblioteca. Para ver ids, abra Roteiro e copie o id do item.');
      if(assoc){
        // attempt local association: if startsWith 'local:' or 'gasto:'
        if(assoc.startsWith('local:')){
          const id = assoc.split(':')[1];
          const filename = Date.now() + '.jpg';
          const path = `locais/${id}/fotos/${filename}`;
          const sref = sRef(storage, path);
          await uploadString(sref, data, 'data_url');
          const url = await getDownloadURL(sref);
          // push into database array
          const cur = await fetch('/__no__');
          // simple add: set at /locais/{id}/fotos_{timestamp}
          await set(ref(db, `locais/${id}/fotos_${Date.now()}`), url);
          alert('Upload concluído e associado ao local.');
        } else if(assoc.startsWith('gasto:')){
          const id = assoc.split(':')[1];
          const filename = Date.now() + '.jpg';
          const path = `gastos/${id}/fotos/${filename}`;
          const sref = sRef(storage, path);
          await uploadString(sref, data, 'data_url');
          const url = await getDownloadURL(sref);
          await set(ref(db, `gastos/${id}/fotos_${Date.now()}`), url);
          alert('Upload concluído e associado ao gasto.');
        } else {
          // if user pasted an id, assume local
          try{
            const filename = Date.now() + '.jpg';
            const path = `locais/${assoc}/fotos/${filename}`;
            const sref = sRef(storage, path);
            await uploadString(sref, data, 'data_url');
            const url = await getDownloadURL(sref);
            await set(ref(db, `locais/${assoc}/fotos_${Date.now()}`), url);
            alert('Upload concluído e associado.');
          }catch(e){ console.error(e); alert('Erro ao associar.'); }
        }
      } else {
        // library
        const url = await simpleUploadToMedia(data);
        images.push(url);
      }
    }
    render();
  });

  gallery.addEventListener('click', (ev)=>{
    const b = ev.target.closest('button');
    if(!b) return;
    const i = Number(b.dataset.i);
    images.splice(i,1); render();
  });

  document.getElementById('clear-gallery').addEventListener('click', ()=>{ if(confirm('Apagar todas as imagens da galeria local?')){ images=[]; render(); }});

  function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const fr = new FileReader(); fr.onload = ()=>res(fr.result); fr.onerror = rej; fr.readAsDataURL(file); }); }

  document.getElementById('open-camera').addEventListener('click', async ()=>{
    // open capture via input capture if available
    const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*'; inp.capture='environment';
    inp.onchange = async (e)=>{ const f = e.target.files[0]; const data = await readFileAsDataURL(f); 
      const assoc = prompt('Associar a (local:id) ou (gasto:id) ou deixe em branco para biblioteca');
      if(assoc){
        if(assoc.startsWith('local:')){
          const id = assoc.split(':')[1];
          const filename = Date.now() + '.jpg';
          const path = `locais/${id}/fotos/${filename}`;
          const sref = sRef(storage, path);
          await uploadString(sref, data, 'data_url');
          const url = await getDownloadURL(sref);
          await set(ref(db, `locais/${id}/fotos_${Date.now()}`), url);
          alert('Foto enviada.');
        } else {
          const url = await simpleUploadToMedia(data);
          images.push(url); render();
        }
      } else {
        const url = await simpleUploadToMedia(data);
        images.push(url); render();
      }
    };
    inp.click();
  });

  // init load images from localStorage (library)
  images = JSON.parse(localStorage.getItem('viagem:photos')||'[]');
  render();
  </script>
</body>
</html>
