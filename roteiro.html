<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Roteiro de Viagem ‚Äî GPS & POIs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            travel: { 50:'#f0f9ff',100:'#e0f2fe',200:'#bae6fd',300:'#7dd3fc',400:'#38bdf8',500:'#0ea5e9',600:'#0284c7',700:'#0369a1',800:'#075985',900:'#0c4a6e' }
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root { --hud-shadow: 0 12px 30px rgba(2,132,199,.18); }
    body { font-family: 'Roboto', sans-serif; }
    #map { height: 420px; width: 100%; border-radius: 16px; }
    .place-item { transition: all .3s ease; }
    .place-item:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,.1); }
    .category-badge { display:inline-block; padding:.25rem .5rem; border-radius:9999px; font-size:.75rem; font-weight:500; }
    #start-trip.tracking { animation: pulse 2s infinite; }
    @keyframes pulse { 0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)} }
    .toast { position:fixed; bottom:20px; right:20px; padding:12px 24px; border-radius:8px; color:white; background-color:#0ea5e9; box-shadow:0 4px 6px rgba(0,0,0,.1); z-index:10000; transition:opacity .3s ease; }
    .toast.error{ background-color:#dc2626; }

    .iw-btn { display:inline-block; margin-top:6px; background:#0ea5e9; color:#fff; padding:6px 10px; border-radius:6px; text-decoration:none; font-weight:600; }
    .iw-btn.save { background:#10b981; }

    /* Overlay pseudo-fullscreen quando a API nativa n√£o rolar */
    .fullscreen-overlay {
      position: fixed; inset: 0; background:#fff; z-index: 1000; display:none;
    }
    .fullscreen-overlay.active { display:block; }
    .fullscreen-map-wrap { position:absolute; inset:0; display:flex; flex-direction:column; }
    .fullscreen-map { flex: 1 1 auto; }

    /* HUD GPS grande (em tela cheia fica no topo) */
    .gps-hud {
      position:absolute; left:12px; top:12px; z-index:1001;
      background:rgba(255,255,255,.96); backdrop-filter:saturate(160%) blur(8px);
      border:1px solid rgba(2,132,199,.15); border-radius:12px; padding:10px 12px; min-width:280px;
      box-shadow: var(--hud-shadow);
    }
    .hud-title { font-weight:700; color:#0369a1; margin-bottom:6px; display:flex; align-items:center; gap:8px;}
    .chip { display:inline-block; padding:2px 8px; border-radius:9999px; font-size:12px; background:#e0f2fe; color:#075985; margin-left:6px;}
    .hud-line { font-size:14px; color:#0c4a6e; }
    .hud-actions { margin-top:8px; display:flex; gap:8px; flex-wrap: wrap; }
    .hud-btn { background:#0284c7; color:#fff; font-weight:600; padding:6px 10px; border-radius:8px; }
    .hud-btn.secondary { background:#e2e8f0; color:#0f172a; }

    /* Bot√µes flutuantes */
    .fab { position:absolute; z-index:1001; right:12px; bottom:12px; display:flex; flex-direction:column; gap:8px; }
    .fab button { background:#fff; border:1px solid #e5e7eb; box-shadow: var(--hud-shadow); padding:8px 10px; border-radius:10px; font-weight:600; color:#0c4a6e; }
    .fab button.danger { background:#ef4444; color:#fff; border-color:#ef4444; }

    /* HUD mini (fora do fullscreen) */
    .gps-hud.mini { top: unset; bottom: 12px; }

    /* InfoRoute List */
    .info-route h3 { margin-bottom: 8px; }
  </style>
</head>
<body class="bg-travel-50">
  <!-- pseudo-fullscreen overlay -->
  <div id="fs-overlay" class="fullscreen-overlay">
    <div class="fullscreen-map-wrap">
      <div id="fs-map" class="fullscreen-map"></div>

      <!-- HUD dentro do fullscreen -->
      <div id="fs-hud" class="gps-hud" style="display:none">
        <div class="hud-title">
          Navega√ß√£o <span id="hud-mode" class="chip">GPS</span>
        </div>
        <div class="hud-line"><strong>Pr√≥xima parada:</strong> <span id="hud-next-name">‚Äî</span></div>
        <div class="hud-line"><strong>Dist√¢ncia:</strong> <span id="hud-next-dist">‚Äî</span> ‚Ä¢ <strong>ETA:</strong> <span id="hud-next-eta">‚Äî</span></div>
        <div class="hud-line" id="hud-next-step" style="margin-top:4px; font-size:13px; color:#334155">‚Äî</div>
        <div class="hud-actions">
          <button id="btn-next-go" class="hud-btn">Ir para pr√≥xima</button>
          <button id="btn-skip-stop" class="hud-btn secondary">Pular parada</button>
          <button id="btn-follow" class="hud-btn secondary" title="Focar no ve√≠culo">Seguir</button>
          <button id="btn-exit-fs" class="hud-btn secondary">Sair tela cheia</button>
        </div>
      </div>

      <div class="fab">
        <button id="btn-recenter">Recentrar</button>
        <button id="abort-temp" class="danger" style="display:none;">Desistir (Rota Temp)</button>
      </div>
    </div>
  </div>

  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-travel-700">Roteiro de Viagem</h1>
      <nav class="flex gap-4">
        <a href="fotos.html" class="text-travel-600 font-medium">Fotos</a>
        <a href="index.html" class="text-gray-500">Sair</a>
      </nav>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6 max-w-3xl">
    <!-- Configura√ß√µes do Ve√≠culo -->
    <div class="card bg-white p-4 mb-6 shadow-md rounded-xl">
      <h2 class="text-lg font-semibold text-travel-800 mb-3">Configura√ß√µes do Ve√≠culo</h2>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Consumo (km/l)</label>
          <input id="fuel-efficiency" type="number" min="1" value="10" class="w-full p-3 border border-gray-200 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Pre√ßo do Combust√≠vel (R$/l)</label>
          <input id="fuel-price" type="number" min="0.1" step="0.01" value="5.50" class="w-full p-3 border border-gray-200 rounded-lg">
        </div>
      </div>
    </div>

    <!-- Mapa Google (modo normal) -->
    <div class="card bg-white p-4 mb-6 shadow-md rounded-xl relative">
      <h2 class="text-lg font-semibold text-travel-800 mb-3">Mapa da Viagem</h2>
      <div id="map"></div>

      <!-- HUD mini (quando n√£o est√° em fullscreen, opcional) -->
      <div id="hud-mini" class="gps-hud mini" style="display:none">
        <div class="hud-title">Navega√ß√£o <span class="chip">GPS</span></div>
        <div class="hud-line"><strong>Pr√≥xima:</strong> <span id="mini-next-name">‚Äî</span></div>
        <div class="hud-line"><span id="mini-next-dist">‚Äî</span> ‚Ä¢ <span id="mini-next-eta">‚Äî</span></div>
      </div>

      <div class="flex justify-between mt-3 items-center">
        <div class="flex gap-2 items-center">
          <button id="start-trip" type="button" class="bg-travel-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-travel-700 transition">
            Iniciar Viagem
          </button>
          <button id="optimize-route" type="button" class="bg-travel-100 text-travel-700 px-4 py-2 rounded-lg font-medium hover:bg-travel-200 transition">
            Otimizar Rota
          </button>
          <button id="btn-enter-fs" type="button" class="bg-travel-100 text-travel-700 px-4 py-2 rounded-lg font-medium hover:bg-travel-200 transition">
            Tela Cheia
          </button>
        </div>
        <div>
          <button id="clear-route" type="button" class="text-red-500 px-4 py-2 rounded-lg border border-red-200 hover:bg-red-50 transition">
            Limpar Tudo
          </button>
        </div>
      </div>
    </div>

    <!-- Adicionar Local -->
    <div class="card bg-white p-5 mb-6 shadow-md rounded-xl">
      <h2 class="text-lg font-semibold text-travel-800 mb-4">Adicionar Local</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Pesquisar local...</label>
          <div class="relative">
            <input id="search" type="text" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-travel-300 focus:border-travel-300" placeholder="Digite o nome de um local">
            <button id="btn-search" type="button" class="absolute right-2 top-2 bg-travel-500 text-white p-2 rounded-lg" title="Buscar">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/></svg>
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Local</label>
            <input id="place-name" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-travel-300">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Custo (R$)</label>
            <input id="place-value" type="number" min="0" step="0.01" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-travel-300">
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
          <select id="place-category" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-travel-300">
            <option value="attraction">Atra√ß√£o Tur√≠stica</option>
            <option value="park">Parque/Natureza</option>
            <option value="hotel">Hotel/Hospedagem</option>
            <option value="restaurant">Restaurante</option>
            <option value="museum">Museu/Cultural</option>
            <option value="shopping">Compras</option>
            <option value="other">Outro</option>
          </select>
        </div>

        <button id="add-place" type="button" class="w-full bg-travel-600 text-white py-3 rounded-lg font-medium hover:bg-travel-700 transition">
          Adicionar Local
        </button>
        <div class="text-xs text-gray-500">Se voc√™ usou a busca, arraste o marcador azul claro no mapa para ajustar a posi√ß√£o exata antes de salvar.</div>
      </div>
    </div>

    <!-- Locais Salvos -->
    <div class="card bg-white p-5 mb-6 shadow-md rounded-xl">
      <h2 class="text-lg font-semibold text-travel-800 mb-4">Locais Salvos</h2>
      <div id="places-list" class="space-y-3"></div>
    </div>

    <!-- Gastos Gerais -->
    <div class="card bg-white p-5 mb-6 shadow-md rounded-xl">
      <h2 class="text-lg font-semibold text-travel-800 mb-4">Gastos Gerais</h2>
      <div id="expenses-list" class="space-y-3 mb-4"></div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
          <input id="expense-title" class="w-full p-3 border border-gray-200 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
          <input id="expense-amount" type="number" min="0" step="0.01" class="w-full p-3 border border-gray-200 rounded-lg">
        </div>
        <div class="flex items-end">
          <button id="add-expense" type="button" class="w-full bg-travel-600 text-white py-3 rounded-lg font-medium hover:bg-travel-700 transition">
            Adicionar
          </button>
        </div>
      </div>
    </div>

    <!-- Resumo Completo -->
    <div class="card bg-white p-5 shadow-md rounded-xl">
      <h2 class="text-lg font-semibold text-travel-800 mb-4">Resumo da Viagem</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div class="bg-travel-50 p-3 rounded-lg">
          <p class="text-sm text-gray-600">Dist√¢ncia Total</p>
          <p id="total-distance" class="text-xl font-bold text-travel-700">0 km</p>
        </div>
        <div class="bg-travel-50 p-3 rounded-lg">
          <p class="text-sm text-gray-600">Tempo Total</p>
          <p id="total-time" class="text-xl font-bold text-travel-700">0 min</p>
        </div>
        <div class="bg-travel-50 p-3 rounded-lg">
          <p class="text-sm text-gray-600">Custo de Combust√≠vel</p>
          <p id="fuel-cost" class="text-xl font-bold text-travel-700">R$ 0,00</p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div class="bg-travel-50 p-3 rounded-lg">
          <p class="text-sm text-gray-600">Custo dos Locais</p>
          <p id="places-cost" class="text-xl font-bold text-travel-700">R$ 0,00</p>
        </div>
        <div class="bg-travel-50 p-3 rounded-lg">
          <p class="text-sm text-gray-600">Gastos Gerais</p>
          <p id="expenses-cost" class="text-xl font-bold text-travel-700">R$ 0,00</p>
        </div>
        <div class="bg-travel-50 p-3 rounded-lg">
          <p class="text-sm text-gray-600">Custo Total</p>
          <p id="total-cost" class="text-xl font-bold text-travel-700">R$ 0,00</p>
        </div>
      </div>

      <div id="route-details" class="space-y-2 info-route"></div>
    </div>
  </main>

  <script>
    // ---------------- CONFIG ----------------
    // üëâ Coloque sua chave ou use localStorage['gm_api_key'] ou par√¢metro ?gm_key=
    const GM_API_KEY = 'AIzaSyDwbThPtdCFKguYQggrrdJsiyJbPyDeKZc';

    // Cores/√≠cones por categoria
    const categoryStyles = {
      attraction: { color: '#ef4444', icon: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',    name: 'Atra√ß√£o' },
      park:       { color: '#10b981', icon: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',  name: 'Parque' },
      hotel:      { color: '#14b8a6', icon: 'https://maps.google.com/mapfiles/ms/icons/cyan-dot.png',   name: 'Hotel' },
      restaurant: { color: '#f97316', icon: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png', name: 'Restaurante' },
      gas_station:{ color: '#f59e0b', icon: 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png', name: 'Posto' },
      supermarket:{ color: '#a3e635', icon: 'https://maps.google.com/mapfiles/ms/icons/lightgreen-dot.png', name: 'Mercado' },
      museum:     { color: '#f59e0b', icon: 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png', name: 'Museu' },
      shopping:   { color: '#8b5cf6', icon: 'https://maps.google.com/mapfiles/ms/icons/purple-dot.png', name: 'Compras' },
      other:      { color: '#6b7280', icon: 'https://maps.google.com/mapfiles/ms/icons/pink-dot.png',   name: 'Outro' }
    };

    // ===== util =====
    const showToast = (m,err=false)=>{ const t=document.createElement('div'); t.className='toast'+(err?' error':''); t.textContent=m; document.body.appendChild(t); setTimeout(()=>{t.style.opacity='0'; setTimeout(()=>t.remove(),300)},3000) };
    const formatCurrency = v => (Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    const hexToRgba = (hex,a=1)=>{ if(!hex) return`rgba(0,0,0,${a})`; const h=hex.replace('#',''); const n=parseInt(h,16); const r=(n>>16)&255,g=(n>>8)&255,b=n&255; return`rgba(${r},${g},${b},${a})` };
    const sanitizeHTML = (s='') => s.replace(/<\/?[^>]+(>|$)/g,""); // simples p/ instru√ß√µes
    function computeHeading(a, b) {
      const toRad = d=>d*Math.PI/180, toDeg = r=>r*180/Math.PI;
      const lat1 = toRad(a.lat), lat2 = toRad(b.lat), dLon = toRad(b.lng - a.lng);
      const y = Math.sin(dLon) * Math.cos(lat2);
      const x = Math.cos(lat1)*Math.sin(lat2) - Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
      return (toDeg(Math.atan2(y,x)) + 360) % 360;
    }
    const hav = (a,b)=>{ const R=6371000,toRad=d=>d*Math.PI/180; const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng); const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2); const A=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2; return 2*R*Math.asin(Math.sqrt(A)) };

    // ===== estado global =====
    let map, fsMap, directionsService, directionsRendererMain, directionsRendererTemp, placesService, infoWindow;
    let markers = [], poiMarkers = [];
    let places = [], generalExpenses = [];
    let lastRouteResult = null, lastRouteResultSaved = null;
    let watchId = null, isTracking = false, followMode = true, followPauseTimer = null;
    let currentPositionMarker = null, pathCoordinates = [], pathPolyline = null;
    let tempDestination = null;
    let poiDebounceTimer = null, lastPOICenter = null;
    const POI_SEARCH_DISTANCE_THRESHOLD = 500; // m
    let searchTempMarker = null, mapClickMarker = null;

    // Pr√≥xima parada / HUD
    let currentStopIndex = 0;
    const NEAR_STOP_THRESHOLD = 120; // m
    let nextLegETA = null, nextLegDist = null, nextStepText = '‚Äî';

    // throttle p/ route recalc
    let lastRouteRecalcAt = 0;
    const ROUTE_RECALC_MIN_MS = 12000; // 12s
    const ROUTE_RECALC_MIN_MOVE = 60; // 60m

    // ---------- √≠cone do ‚Äúcarro‚Äù rotacion√°vel ----------
    function createCarIcon(headingDeg = 0) {
      const size = 36;
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
        <g transform="translate(${size/2},${size/2}) rotate(${headingDeg}) translate(${-size/2},${-size/2})">
          <circle cx="${size/2}" cy="${size/2}" r="${size/2 - 1}" fill="#0b74de" opacity="0.95"/>
          <path d="M ${size/2} ${6} L ${size/2 + 6} ${size/2 + 6} L ${size/2} ${size/2 + 2} L ${size/2 - 6} ${size/2 + 6} Z" fill="white"/>
        </g>
      </svg>`;
      return { url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg), scaledSize: new google.maps.Size(size, size), anchor: new google.maps.Point(size/2, size/2) };
    }

    // ---------- initMap ----------
    function initMap() {
      const initialLocation = { lat: -15.795, lng: -47.891 }; // Bras√≠lia

      // mapa normal
      map = new google.maps.Map(document.getElementById('map'), {
        center: initialLocation, zoom: 13, mapTypeControl: true, streetViewControl: false, gestureHandling: 'greedy',
        styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
      });

      // mapa do fullscreen (compartilha estado & servi√ßos)
      fsMap = new google.maps.Map(document.getElementById('fs-map'), {
        center: initialLocation, zoom: 15, mapTypeControl: false, streetViewControl: false, gestureHandling: 'greedy',
        styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
      });

      infoWindow = new google.maps.InfoWindow();
      directionsService = new google.maps.DirectionsService();

      // Renderers (principal azul / tempor√°ria verde)
      directionsRendererMain = new google.maps.DirectionsRenderer({
        map: map, suppressMarkers: true,
        polylineOptions: { strokeColor: '#0ea5e9', strokeOpacity: 0.95, strokeWeight: 6 },
        preserveViewport: false
      });
      directionsRendererTemp = new google.maps.DirectionsRenderer({
        map: map, suppressMarkers: true,
        polylineOptions: { strokeColor: '#16a34a', strokeOpacity: 0.95, strokeWeight: 6 },
        preserveViewport: true
      });

      placesService = new google.maps.places.PlacesService(map);

      // polyline do caminho percorrido (GPS) nos dois mapas
      pathPolyline = new google.maps.Polyline({
        path: pathCoordinates, geodesic: true, strokeColor: '#0b74de', strokeOpacity: 1.0, strokeWeight: 4
      });
      pathPolyline.setMap(map);
      pathPolyline.setMap(fsMap);

      // Ao interagir manualmente enquanto tracking, pausa follow por alguns segundos
      [map, fsMap].forEach(m => {
        m.addListener('dragstart', () => { if (isTracking) pauseFollowTemporarily(); });
        m.addListener('zoom_changed', () => { if (isTracking) pauseFollowTemporarily(); });
      });

      // Clique no mapa normal ‚Üí marcador tempor√°rio para salvar local
      map.addListener('click', onMapClickToAdd);

      // dados iniciais + listeners
      loadData();
      setupEventListeners();

      // Buscar POIs quando parar de mover (no mapa normal)
      map.addListener('idle', () => { schedulePOISearch(map.getCenter()); });

      console.log('Mapas inicializados.');
    }

    function onMapClickToAdd(e) {
      if (mapClickMarker) mapClickMarker.setMap(null);
      mapClickMarker = new google.maps.Marker({
        position: e.latLng, map: map,
        icon: { url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png', scaledSize: new google.maps.Size(36, 36) },
        draggable: true
      });

      const content = `
        <div style="max-width:220px">
          <h3 style="margin:0 0 6px 0;font-weight:700">Novo Local</h3>
          <div style="margin-bottom:6px">Clique para adicionar este local</div>
          <div style="margin-top:8px">
            <a href="#" class="iw-btn save">Salvar este local</a>
          </div>
        </div>`;
      infoWindow.setContent(content);
      infoWindow.open(map, mapClickMarker);

      google.maps.event.addListenerOnce(infoWindow, 'domready', () => {
        const saveBtn = document.querySelector('.iw-btn.save');
        if (saveBtn) {
          saveBtn.addEventListener('click', (ev) => {
            ev.preventDefault();
            document.getElementById('place-name').focus();
            document.getElementById('place-name').value = 'Novo Local';
            const pos = mapClickMarker.getPosition();
            document.getElementById('search').value = `Lat: ${pos.lat().toFixed(6)}, Lng: ${pos.lng().toFixed(6)}`;
            infoWindow.close();
            mapClickMarker.setMap(null);
            mapClickMarker = null;
          });
        }
      });
    }

    // ---------- Fullscreen helpers ----------
    const fsOverlay = ()=>document.getElementById('fs-overlay');
    async function enterFullscreen() {
      // tenta API nativa
      try {
        if (fsOverlay().requestFullscreen) {
          await fsOverlay().requestFullscreen();
        }
      } catch(e) { /* ignora */ }
      // se n√£o entrou, usa overlay
      fsOverlay().classList.add('active');
      document.getElementById('fs-hud').style.display = 'block';
      // apontar renderers para o fsMap
      directionsRendererMain.setMap(fsMap);
      directionsRendererTemp.setMap(fsMap);
      pathPolyline.setMap(fsMap);
      // HUD mini some
      document.getElementById('hud-mini').style.display = 'none';
      // recenter suave se tiver posi√ß√£o
      if (currentPositionMarker) centerOnCurrent();
    }
    async function exitFullscreen() {
      try { if (document.fullscreenElement) await document.exitFullscreen(); } catch(e){}
      fsOverlay().classList.remove('active');
      document.getElementById('fs-hud').style.display = 'none';
      // voltar renderers para mapa normal
      directionsRendererMain.setMap(map);
      directionsRendererTemp.setMap(map);
      pathPolyline.setMap(map);
      // HUD mini volta se estiver tracking
      document.getElementById('hud-mini').style.display = isTracking ? 'block' : 'none';
      if (currentPositionMarker) centerOnCurrent(true);
    }

    // ---------- GPS ----------
    function startGPSTracking({goFullscreen=true}={}) {
      if (!navigator.geolocation) { showToast('Geolocaliza√ß√£o n√£o suportada', true); return; }
      if (isTracking) return;
      isTracking = true; followMode = true;
      document.getElementById('hud-mini').style.display = 'block';
      document.getElementById('hud-mode').textContent = 'GPS';

      // define parada inicial
      currentStopIndex = guessNextStopIndex();
      updateHUDLabels();

      showToast('Iniciando rastreamento GPS...');
      pathCoordinates = [];
      pathPolyline.setPath(pathCoordinates);

      // renderers n√£o alteram viewport no modo GPS (evita "pular")
      directionsRendererMain.setOptions({ preserveViewport: true });
      directionsRendererTemp.setOptions({ preserveViewport: true });

      // tentar fullscreen j√° no clique de iniciar
      if (goFullscreen) enterFullscreen();

      watchId = navigator.geolocation.watchPosition(pos => {
        if (!isTracking) return;
        const p = { lat: pos.coords.latitude, lng: pos.coords.longitude };

        // marcador do carro nos 2 mapas
        if (!currentPositionMarker) {
          currentPositionMarker = new google.maps.Marker({
            position: p, map: map, icon: createCarIcon(0), title: 'Voc√™', zIndex: 1000
          });
          // clone no fsMap
          currentPositionMarker.fs = new google.maps.Marker({
            position: p, map: fsMap, icon: createCarIcon(0), title: 'Voc√™', zIndex: 1000
          });
        } else {
          let heading = 0;
          if (pathCoordinates.length >= 1) heading = computeHeading(pathCoordinates[pathCoordinates.length-1], p);
          currentPositionMarker.setPosition(p);
          currentPositionMarker.setIcon(createCarIcon(heading));
          if (currentPositionMarker.fs) {
            currentPositionMarker.fs.setPosition(p);
            currentPositionMarker.fs.setIcon(createCarIcon(heading));
          }
        }

        // breadcrumb
        if (!pathCoordinates.length || hav(pathCoordinates[pathCoordinates.length-1], p) > 3) {
          pathCoordinates.push(p);
          pathPolyline.setPath(pathCoordinates);
        }

        // seguir ve√≠culo se followMode
        if (followMode) centerOnCurrent();

        // POIs din√¢micos (no mapa normal) ‚Äì n√£o mexe c√¢mera
        schedulePOISearch(new google.maps.LatLng(p.lat, p.lng));

        // Rota: se temp, prioriza; sen√£o, pr√≥xima parada
        if (tempDestination) {
          maybeRecalcTempRoute(p, tempDestination);
        } else {
          updateNextStopHUD(p);
          maybeRecalcMainRouteFromCurrent(p);
        }

      }, err => {
        console.warn('GPS error', err);
        let msg = 'Erro desconhecido no GPS.';
        if (err && err.code !== undefined) {
          if (err.code === 1) msg = 'Permiss√£o de localiza√ß√£o negada.';
          else if (err.code === 2) msg = 'Informa√ß√£o de localiza√ß√£o indispon√≠vel.';
          else if (err.code === 3) msg = 'Tempo de espera para localiza√ß√£o expirado.';
        }
        showToast(msg, true);
        stopGPSTracking();
      }, { enableHighAccuracy: true, maximumAge: 3000, timeout: 27000 });

      const startBtn = document.getElementById('start-trip');
      startBtn.textContent = 'Parar Rastreamento';
      startBtn.classList.remove('bg-travel-600');
      startBtn.classList.add('bg-red-600', 'tracking');
    }

    function stopGPSTracking() {
      try { if (watchId) navigator.geolocation.clearWatch(watchId); } catch(e){}
      watchId = null;
      isTracking = false; followMode = false;
      tempDestination = null;
      directionsRendererTemp.setMap(null); // some temp
      document.getElementById('abort-temp').style.display = 'none';
      document.getElementById('hud-mini').style.display = 'none';
      nextLegDist = nextLegETA = null; nextStepText = '‚Äî';
      updateHUDLabels();

      // renderer principal volta a poder mexer viewport
      directionsRendererMain.setOptions({ preserveViewport: false });

      // sair do fullscreen se estiver
      exitFullscreen();

      const startBtn = document.getElementById('start-trip');
      startBtn.textContent = 'Iniciar Viagem';
      startBtn.classList.add('bg-travel-600');
      startBtn.classList.remove('bg-red-600', 'tracking');
    }

    function centerOnCurrent(useNormalMap=false) {
      const m = (document.fullscreenElement || fsOverlay().classList.contains('active')) && !useNormalMap ? fsMap : map;
      if (!currentPositionMarker) return;
      const pos = currentPositionMarker.getPosition();
      try {
        m.panTo(pos);
        if (m.getZoom() < 15) m.setZoom(15);
      } catch(e){}
    }

    function pauseFollowTemporarily() {
      followMode = false;
      if (followPauseTimer) clearTimeout(followPauseTimer);
      followPauseTimer = setTimeout(()=>{ if (isTracking) followMode = true; }, 8000);
    }

    // ---------- Pr√≥xima parada ----------
    function guessNextStopIndex() {
      if (!places || places.length < 2) return 0;
      return 1; // 0 costuma ser origem
    }
    function updateHUDLabels() {
      const next = places[currentStopIndex] || null;
      const name = next ? (next.name || '‚Äî') : '‚Äî';
      document.getElementById('hud-next-name').textContent = name;
      document.getElementById('hud-next-dist').textContent = nextLegDist || '‚Äî';
      document.getElementById('hud-next-eta').textContent = nextLegETA || '‚Äî';
      document.getElementById('hud-next-step').textContent = nextStepText || '‚Äî';
      // mini
      document.getElementById('mini-next-name').textContent = name;
      document.getElementById('mini-next-dist').textContent = nextLegDist || '‚Äî';
      document.getElementById('mini-next-eta').textContent = nextLegETA || '‚Äî';
    }
    function updateNextStopHUD(currentPos) {
      if (!places || places.length < 2) { nextLegETA = nextLegDist = null; nextStepText = '‚Äî'; updateHUDLabels(); return; }
      if (currentStopIndex < 1) currentStopIndex = 1;
      if (currentStopIndex >= places.length) currentStopIndex = places.length - 1;

      const target = places[currentStopIndex];
      const distMeters = hav(currentPos, {lat: target.lat, lng: target.lng});
      if (distMeters <= NEAR_STOP_THRESHOLD && currentStopIndex < places.length - 1) {
        currentStopIndex++;
        showToast(`Chegou em ${target.name}. Pr√≥xima: ${places[currentStopIndex].name}`);
      }
      const nextTarget = places[currentStopIndex];
      // ETA r√°pido
      const req = { origin: currentPos, destination: { lat: nextTarget.lat, lng: nextTarget.lng }, travelMode: google.maps.TravelMode.DRIVING };
      directionsService.route(req, (res, status) => {
        if (status === 'OK') {
          try {
            const leg = res.routes[0].legs[0];
            nextLegDist = leg.distance.text; nextLegETA = leg.duration.text;
            // pr√≥xima instru√ß√£o
            const step = (leg.steps && leg.steps[0]) ? leg.steps[0] : null;
            nextStepText = step ? sanitizeHTML(step.instructions) : '‚Äî';
          } catch(e){ nextLegDist = nextLegETA = null; nextStepText = '‚Äî'; }
        }
        updateHUDLabels();
      });
    }

    // ---------- Rota principal (recalc throttle) ----------
    function maybeRecalcMainRouteFromCurrent(currentPos) {
      const now = Date.now();
      if (now - lastRouteRecalcAt < ROUTE_RECALC_MIN_MS) return;
      const last = pathCoordinates.length ? pathCoordinates[pathCoordinates.length-1] : null;
      if (last && hav(last, currentPos) < ROUTE_RECALC_MIN_MOVE) return;

      lastRouteRecalcAt = now;
      updateMainRouteFromCurrentPosition(currentPos);
    }

    function updateMainRouteFromCurrentPosition(currentPos) {
      if (!isTracking || !places || places.length < 2) return;

      const origin = { lat: currentPos.lat, lng: currentPos.lng };
      const remaining = places.slice(Math.max(1, currentStopIndex), places.length - 1);
      const waypoints = remaining.map(p => ({ location: { lat: p.lat, lng: p.lng }, stopover: true }));

      const request = {
        origin, destination: { lat: places[places.length -1].lat, lng: places[places.length -1].lng },
        waypoints, travelMode: google.maps.TravelMode.DRIVING, optimizeWaypoints: false
      };
      directionsService.route(request, (result, status) => {
        if (status === 'OK') {
          // manter viewport (evita "pulos")
          directionsRendererMain.setOptions({ preserveViewport: true });
          directionsRendererMain.setMap(activeMap());
          directionsRendererMain.setDirections(result);
          lastRouteResult = result; lastRouteResultSaved = JSON.parse(JSON.stringify(result));
          renderRouteDetails(result);
          updateStats();
        } else {
          console.warn('updateMainRouteFromCurrentPosition status', status);
        }
      });
    }

    // ---------- Rota Tempor√°ria ----------
    function setTemporaryDestination(poi) {
      tempDestination = poi;
      document.getElementById('abort-temp').style.display = 'block';
      showToast(`Rota tempor√°ria: ${poi.name}`);
      const start = currentPositionMarker ? currentPositionMarker.getPosition() : map.getCenter();
      if (!start) { showToast('Sem posi√ß√£o para iniciar rota tempor√°ria.', true); return; }
      const startLatLng = { lat: start.lat(), lng: start.lng() };
      computeTempRoute(startLatLng, poi, { fit: !isTracking });
    }

    function computeTempRoute(startLatLng, poi, {fit=true}={}) {
      if (!poi) return;
      const request = { origin: startLatLng, destination: { lat: poi.lat, lng: poi.lng }, travelMode: google.maps.TravelMode.DRIVING };
      directionsService.route(request, (result, status) => {
        if (status === 'OK') {
          directionsRendererTemp.setOptions({ preserveViewport: isTracking });
          directionsRendererTemp.setMap(activeMap());
          directionsRendererTemp.setDirections(result);
          if (fit && !isTracking) {
            try {
              const b = new google.maps.LatLngBounds();
              b.extend(result.routes[0].legs[0].start_location);
              b.extend(result.routes[0].legs[0].end_location);
              activeMap().fitBounds(b);
            } catch(e){}
          }
          renderTempDetails(result, poi);
        } else {
          showToast('Erro ao calcular rota tempor√°ria: ' + status, true);
        }
      });
    }

    function maybeRecalcTempRoute(startLatLng, poi) {
      const now = Date.now();
      if (now - lastRouteRecalcAt < ROUTE_RECALC_MIN_MS) return;
      lastRouteRecalcAt = now;
      computeTempRoute(startLatLng, poi, {fit:false});
    }

    function renderTempDetails(routeResult, poi) {
      const c = document.getElementById('route-details');
      let html = '<h3 class="font-semibold mb-2">Detalhes do Percurso:</h3>';
      if (lastRouteResult && lastRouteResult.routes) html += '<div class="text-sm text-gray-600 mb-2">Rota principal (salva)</div>';
      try {
        const leg = routeResult.routes[0].legs[0];
        html += `<div class="bg-green-50 p-3 rounded-lg mb-2">
          <div class="flex justify-between items-center">
            <div>
              <p class="font-medium">Rota tempor√°ria ‚Üí ${escapeHtml(poi.name)}</p>
              <p class="text-sm text-gray-600">${leg.distance.text} ‚Ä¢ ${leg.duration.text}</p>
            </div>
            <p class="text-travel-700 font-medium">${leg.duration.text}</p>
          </div>
        </div>`;
      } catch(e){}
      c.innerHTML = html;
    }

    function abortTemporaryRoute() {
      tempDestination = null;
      directionsRendererTemp.setMap(null);
      document.getElementById('abort-temp').style.display = 'none';
      showToast('Voltando √† rota original.');
      if (lastRouteResultSaved) {
        lastRouteResult = JSON.parse(JSON.stringify(lastRouteResultSaved));
        directionsRendererMain.setMap(activeMap());
        directionsRendererMain.setDirections(lastRouteResult);
        renderRouteDetails(lastRouteResult);
        updateStats();
      } else {
        document.getElementById('route-details').innerHTML = '';
      }
    }

    // ---------- POIs ----------
    function schedulePOISearch(centerLatLng) {
      if (poiDebounceTimer) clearTimeout(poiDebounceTimer);
      poiDebounceTimer = setTimeout(() => {
        if (lastPOICenter) {
          const last = lastPOICenter;
          const dist = google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(last.lat,last.lng), centerLatLng);
          if (dist < POI_SEARCH_DISTANCE_THRESHOLD) return;
        }
        searchNearbyPOIs(centerLatLng);
      }, 800);
    }

    function searchNearbyPOIs(center) {
      if (!map || !placesService) return;
      const centerLatLng = center instanceof google.maps.LatLng ? center : new google.maps.LatLng(center.lat, center.lng);
      lastPOICenter = { lat: centerLatLng.lat(), lng: centerLatLng.lng() };

      poiMarkers.forEach(m => m.setMap(null)); poiMarkers = [];

      const typesToSearch = ['gas_station','lodging','restaurant','supermarket','convenience_store','tourist_attraction'];
      const radius = 4000;

      typesToSearch.forEach(type => {
        const req = { location: centerLatLng, radius, type };
        placesService.nearbySearch(req, (results, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length) {
            results.slice(0, 12).forEach(r => addPOIMarker(r, type));
          }
        });
      });
    }

    function addPOIMarker(placeResult, forcedType) {
      if (!placeResult.geometry || !placeResult.geometry.location) return;
      let type = forcedType || (placeResult.types && placeResult.types[0]) || 'other';
      if (type.includes('lodging')) type = 'hotel';
      if (type.includes('gas')) type = 'gas_station';
      if (type.includes('restaurant')) type = 'restaurant';
      if (type.includes('tourist')) type = 'attraction';
      if (type.includes('supermarket') || type.includes('grocery') || type.includes('convenience')) type = 'supermarket';

      const style = categoryStyles[type] || categoryStyles.other;
      const icon = { url: style.icon, scaledSize: new google.maps.Size(36,36) };

      const marker = new google.maps.Marker({ position: placeResult.geometry.location, map, title: placeResult.name, icon, zIndex: 900 });

      marker.addListener('click', () => {
        const content =
          `<div style="max-width:260px">
            <h3 style="margin:0 0 6px 0;font-weight:700">${escapeHtml(placeResult.name)}</h3>
            <div style="color:${style.color};font-weight:600;margin-bottom:6px">${style.name}</div>
            ${placeResult.vicinity ? `<div style="font-size:12px;color:#6b7280">${escapeHtml(placeResult.vicinity)}</div>` : ''}
            <div style="margin-top:8px">
              <a href="#" data-place-id="${placeResult.place_id}" class="iw-btn go-btn">Ir at√© aqui</a>
              <a href="#" data-place-id="${placeResult.place_id}" class="iw-btn save">Salvar este local</a>
            </div>
          </div>`;
        infoWindow.setContent(content);
        infoWindow.open(map, marker);

        google.maps.event.addListenerOnce(infoWindow, 'domready', () => {
          const goBtn = document.querySelector('.iw-btn.go-btn');
          if (goBtn) goBtn.addEventListener('click', (ev) => {
            ev.preventDefault();
            const poi = {
              name: placeResult.name,
              lat: placeResult.geometry.location.lat(),
              lng: placeResult.geometry.location.lng(),
              address: placeResult.vicinity || '',
              place_id: placeResult.place_id,
              category: type
            };
            setTemporaryDestination(poi);
            infoWindow.close();
          });
          
          const saveBtn = document.querySelector('.iw-btn.save');
          if (saveBtn) saveBtn.addEventListener('click', (ev) => {
            ev.preventDefault();
            document.getElementById('place-name').value = placeResult.name || '';
            document.getElementById('place-value').value = '';
            document.getElementById('search').value = placeResult.vicinity || placeResult.name || '';
            if (type) document.getElementById('place-category').value = type;
            showToast('Preenchi os campos. Ajuste e clique em Adicionar Local.');
            infoWindow.close();
          });
        });
      });

      poiMarkers.push(marker);
    }

    // ---------- Rota principal (setup + detalhes) ----------
    function updateRoute() {
      // limpar marcadores salvos
      markers.forEach(m => m.setMap(null)); markers = [];

      if (!places || places.length === 0) {
        clearRouteRenderers();
        document.getElementById('route-details').innerHTML = '';
        updateStats(); return;
      }

      // marcadores
      places.forEach((place) => {
        const cat = categoryStyles[place.category] || categoryStyles.other;
        const icon = { url: cat.icon, scaledSize: new google.maps.Size(36,36) };
        const mk1 = new google.maps.Marker({ position: { lat: place.lat, lng: place.lng }, map, title: place.name, icon });
        mk1.addListener('click', () => openPlaceInfo(place, mk1, cat));
        markers.push(mk1);
        // tamb√©m no fsMap
        const mk2 = new google.maps.Marker({ position: { lat: place.lat, lng: place.lng }, map: fsMap, title: place.name, icon });
        mk2.addListener('click', () => openPlaceInfo(place, mk2, cat));
        markers.push(mk2);
      });

      if (places.length === 1) {
        (isTracking ? centerOnCurrent(true) : map.panTo(markers[0].getPosition()));
        clearRouteRenderers(); document.getElementById('route-details').innerHTML = ''; updateStats(); return;
      }

      // monta rota completa (fora do GPS pode ajustar viewport)
      const waypoints = places.slice(1, -1).map(p => ({ location: { lat: p.lat, lng: p.lng }, stopover: true }));
      const req = {
        origin: { lat: places[0].lat, lng: places[0].lng },
        destination: { lat: places[places.length -1].lat, lng: places[places.length -1].lng },
        waypoints, travelMode: google.maps.TravelMode.DRIVING, optimizeWaypoints: false, provideRouteAlternatives: false
      };
      directionsService.route(req, (result, status) => {
        if (status === 'OK') {
          directionsRendererMain.setOptions({ preserveViewport: isTracking }); // se estiver no GPS, preserva
          directionsRendererMain.setMap(activeMap());
          directionsRendererMain.setDirections(result);
          lastRouteResult = result; lastRouteResultSaved = JSON.parse(JSON.stringify(result));

          // s√≥ d√° fitBounds quando N√ÉO est√° no GPS (evita "pulos")
          if (!isTracking) {
            try {
              const b = new google.maps.LatLngBounds();
              result.routes[0].legs.forEach(leg => { b.extend(leg.start_location); b.extend(leg.end_location); });
              activeMap().fitBounds(b);
            } catch(e){}
          }

          renderRouteDetails(result);
          updateStats();
        } else {
          showToast('Erro ao calcular rota: ' + status, true);
          lastRouteResult = null; updateStats();
        }
      });
    }

    function clearRouteRenderers() {
      directionsRendererMain.setMap(null);
      directionsRendererTemp.setMap(null);
      lastRouteResult = null; lastRouteResultSaved = null; tempDestination = null;
      document.getElementById('abort-temp').style.display = 'none';
    }

    function openPlaceInfo(place, marker, cat) {
      const content = `<div style="max-width:260px">
        <h3 style="margin:0 0 4px 0;font-weight:700">${escapeHtml(place.name)}</h3>
        <div style="color:${cat.color};font-weight:600;margin-bottom:6px">${cat.name}</div>
        ${place.value ? `<div style="margin-bottom:6px">${formatCurrency(place.value)}</div>` : ''}
        ${place.address ? `<div style="font-size:12px;color:#6b7280">${escapeHtml(place.address)}</div>` : ''}
        <div style="margin-top:8px"><a href="#" class="iw-btn set-next-btn">Definir como pr√≥xima parada</a></div>
      </div>`;
      infoWindow.setContent(content);
      infoWindow.open(marker.getMap(), marker);
      google.maps.event.addListenerOnce(infoWindow, 'domready', () => {
        const btn = document.querySelector('.iw-btn.set-next-btn');
        if (btn) btn.addEventListener('click', (ev) => {
          ev.preventDefault();
          const idx = places.findIndex(p => p.lat===place.lat && p.lng===place.lng);
          if (idx>=0) { currentStopIndex = Math.max(1, idx); showToast(`Pr√≥xima parada: ${place.name}`); infoWindow.close(); }
        });
      });
    }

    function renderRouteDetails(routeResult) {
      const container = document.getElementById('route-details'); container.innerHTML = '<h3 class="font-semibold mb-2">Detalhes do Percurso:</h3>';
      if (!routeResult || !routeResult.routes || !routeResult.routes[0]) { container.innerHTML += '<div class="text-gray-500">Sem detalhes de rota.</div>'; return; }
      const legs = routeResult.routes[0].legs || [];
      legs.forEach((leg,index) => {
        const fromPlace = places[index] || { name: 'Ponto' }, toPlace = places[index+1] || { name: 'Destino' };
        const div = document.createElement('div');
        div.className = 'bg-gray-50 p-3 rounded-lg mb-2';
        div.innerHTML =
          `<div class="flex justify-between items-center">
            <div>
              <p class="font-medium">${escapeHtml(fromPlace.name)} ‚Üí ${escapeHtml(toPlace.name)}</p>
              <p class="text-sm text-gray-600">${leg.distance.text} ‚Ä¢ ${leg.duration.text}</p>
            </div>
            <p class="text-travel-700 font-medium">${leg.duration.text}</p>
          </div>`;
        container.appendChild(div);
      });
    }

    // ---------- Estat√≠sticas ----------
    function updateStats() {
      const placesCost = (places||[]).reduce((s,p)=>s+(parseFloat(p.value)||0),0);
      document.getElementById('places-cost').textContent = formatCurrency(placesCost);
      const expensesCost = (generalExpenses||[]).reduce((s,e)=>s+(parseFloat(e.amount)||0),0);
      document.getElementById('expenses-cost').textContent = formatCurrency(expensesCost);

      let totalDistance=0, totalTime=0, fuelCost=0;
      if (lastRouteResult && lastRouteResult.routes && lastRouteResult.routes[0]) {
        lastRouteResult.routes[0].legs.forEach(leg=>{ totalDistance += (leg.distance && leg.distance.value)?leg.distance.value:0; totalTime += (leg.duration && leg.duration.value)?leg.duration.value:0; });
        const fuelEfficiency = parseFloat(document.getElementById('fuel-efficiency').value) || 10;
        const fuelPrice = parseFloat(document.getElementById('fuel-price').value) || 5.50;
        const fuelConsumption = (totalDistance/1000)/fuelEfficiency;
        fuelCost = fuelConsumption * fuelPrice;
      }

      document.getElementById('total-distance').textContent = (totalDistance/1000).toFixed(1) + ' km';
      const hours = Math.floor(totalTime/3600); const minutes = Math.round((totalTime%3600)/60);
      let timeText = ''; if(hours>0) timeText += `${hours} h `; timeText += `${minutes} min`;
      document.getElementById('total-time').textContent = timeText;
      document.getElementById('fuel-cost').textContent = formatCurrency(parseFloat(fuelCost)||0);
      const totalCost = placesCost + expensesCost + (fuelCost||0);
      document.getElementById('total-cost').textContent = formatCurrency(totalCost);
    }

    // ---------- Persist√™ncia ----------
    function loadData() {
      try {
        const savedPlaces = localStorage.getItem('travel_places');
        const savedExpenses = localStorage.getItem('travel_expenses');
        if (savedPlaces) places = JSON.parse(savedPlaces);
        if (savedExpenses) generalExpenses = JSON.parse(savedExpenses);
      } catch (err) { console.warn('Erro parse localStorage', err); places = []; generalExpenses = []; }
      renderPlaces(); renderExpenses(); updateRoute();
    }
    function saveData() {
      try {
        localStorage.setItem('travel_places', JSON.stringify(places));
        localStorage.setItem('travel_expenses', JSON.stringify(generalExpenses));
      } catch (err) { console.warn('Erro ao salvar localStorage', err); }
    }

    // ---------- Listas ----------
    function renderPlaces() {
      const container = document.getElementById('places-list'); container.innerHTML = '';
      if (!places || places.length === 0) { container.innerHTML = '<div class="text-center py-4 text-gray-500">Nenhum local adicionado ainda</div>'; updateStats(); return; }
      places.forEach((place, index) => {
        const category = categoryStyles[place.category] || categoryStyles.other;
        const badgeBg = hexToRgba(category.color, .12);
        const div = document.createElement('div'); div.className = 'place-item bg-white p-4 rounded-lg border border-gray-200';
        let html = '';
        html += '<div class="flex justify-between items-start">';
        html += '<div>';
        html += '<div class="flex items-center gap-2">';
        html += `<h3 class="font-semibold text-travel-800">${escapeHtml(place.name)}</h3>`;
        html += `<span class="category-badge" style="background-color: ${badgeBg}; color: ${category.color};">${category.name}</span>`;
        html += (isTracking && index===currentStopIndex) ? `<span class="ml-2 chip">Pr√≥xima parada</span>` : '';
        html += '</div>';
        if (place.value) html += `<p class="text-sm text-travel-600">${formatCurrency(place.value)}</p>`;
        if (place.address) html += `<p class="text-xs text-gray-500 mt-1">${escapeHtml(place.address)}</p>`;
        html += '</div>';
        html += '<div class="flex gap-2 items-center">';
        html += `<button data-index="${index}" title="Definir como pr√≥xima" class="set-next text-travel-600 hover:text-travel-800 p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M13 5l7 7-7 7v-4H4v-6h9V5z"/></svg></button>`;
        html += `<button data-index="${index}" title="Subir" class="move-up text-travel-600 hover:text-travel-800 p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3l5 6H5l5-6z"/></svg></button>`;
        html += `<button data-index="${index}" title="Descer" class="move-down text-travel-600 hover:text-travel-800 p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 17l-5-6h10l-5 6z"/></svg></button>`;
        html += `<button data-index="${index}" title="Remover" class="delete-place text-red-500 hover:text-red-700 p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button>`;
        html += '</div></div>';
        div.innerHTML = html;
        container.appendChild(div);
      });
      updateStats();
    }

    function renderExpenses() {
      const container = document.getElementById('expenses-list'); container.innerHTML = '';
      if (!generalExpenses || generalExpenses.length === 0) { container.innerHTML = '<div class="text-center py-4 text-gray-500">Nenhum gasto geral adicionado</div>'; updateStats(); return; }
      generalExpenses.forEach((expense, index) => {
        const div = document.createElement('div'); div.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg';
        div.innerHTML = `<div><p class="font-medium">${escapeHtml(expense.title)}</p><p class="text-xs text-gray-500">${new Date(expense.date).toLocaleDateString()}</p></div>
           <div class="flex items-center gap-2"><p class="font-medium">${formatCurrency(expense.amount)}</p>
           <button data-index="${index}" class="delete-expense text-red-500 hover:text-red-700" title="Remover"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div>`;
        container.appendChild(div);
      });
      updateStats();
    }

    function escapeHtml(str) { if (!str) return ''; return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

    // ---------- Listeners e Intera√ß√µes ----------
    function setupEventListeners() {
      // add place
      document.getElementById('add-place').addEventListener('click', () => {
        const name = document.getElementById('place-name').value.trim();
        const value = parseFloat(document.getElementById('place-value').value) || 0;
        const category = document.getElementById('place-category').value;
        if (!name) { showToast('Por favor, digite um nome para o local', true); return; }
        let lat, lng;
        if (searchTempMarker) { const p = searchTempMarker.getPosition(); lat = p.lat(); lng = p.lng(); }
        else if (mapClickMarker) { const p = mapClickMarker.getPosition(); lat = p.lat(); lng = p.lng(); }
        else { const c = map.getCenter(); lat = c ? c.lat() : -15.795; lng = c ? c.lng() : -47.891; }
        const newPlace = { name, value, category, lat, lng, address: document.getElementById('search').value || '', date: new Date().toISOString() };
        places.push(newPlace); saveData(); renderPlaces(); updateRoute(); showToast('Local adicionado!');
        document.getElementById('place-name').value = ''; document.getElementById('place-value').value = ''; document.getElementById('search').value = '';
        if (searchTempMarker) { searchTempMarker.setMap(null); searchTempMarker = null; }
        if (mapClickMarker) { mapClickMarker.setMap(null); mapClickMarker = null; }
      });

      // search
      document.getElementById('btn-search').addEventListener('click', () => {
        const q = document.getElementById('search').value.trim();
        if (!q) { showToast('Digite algo para pesquisar.', true); return; }
        if (!map || !google?.maps?.places) { showToast('Servi√ßo de lugares indispon√≠vel.', true); return; }
        const service = new google.maps.places.PlacesService(map);
        service.findPlaceFromQuery({ query: q, fields: ['name','geometry','formatted_address','types'] }, (results, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK && results?.[0]) {
            const p = results[0]; if (p.geometry?.location) showSearchTempMarker(p.geometry.location, p.name||'', p.formatted_address||'');
            document.getElementById('place-name').value = p.name || '';
            document.getElementById('search').value = p.formatted_address || p.name || '';
            let category = 'other';
            const t = p.types || [];
            if (t.includes('park') || t.includes('natural_feature')) category = 'park';
            else if (t.includes('tourist_attraction') || t.includes('point_of_interest')) category = 'attraction';
            else if (t.includes('lodging') || t.includes('hotel')) category = 'hotel';
            else if (t.includes('restaurant') || t.includes('food')) category = 'restaurant';
            else if (t.includes('museum') || t.includes('art_gallery')) category = 'museum';
            else if (t.includes('shopping_mall') || t.includes('store')) category = 'shopping';
            document.getElementById('place-category').value = category;
            showToast('Local encontrado! Ajuste o marcador azul claro e clique em Adicionar.');
          } else { showToast('Local n√£o encontrado. Tente outro termo.', true); }
        });
      });

      // expenses
      document.getElementById('add-expense').addEventListener('click', () => {
        const title = document.getElementById('expense-title').value.trim();
        const amount = parseFloat(document.getElementById('expense-amount').value);
        if (!title || isNaN(amount)) { showToast('Preencha os campos do gasto', true); return; }
        generalExpenses.push({ title, amount, date: new Date().toISOString() });
        saveData(); renderExpenses(); showToast('Gasto adicionado!');
        document.getElementById('expense-title').value=''; document.getElementById('expense-amount').value='';
      });

      // places list
      document.getElementById('places-list').addEventListener('click', (e) => {
        const btn = e.target.closest('button'); if (!btn) return;
        const i = parseInt(btn.dataset.index); if (isNaN(i)) return;
        if (btn.classList.contains('delete-place')) {
          if (confirm('Remover este local?')) { places.splice(i,1); saveData(); renderPlaces(); updateRoute(); showToast('Local removido!'); }
        } else if (btn.classList.contains('move-up') && i>0) {
          [places[i-1], places[i]] = [places[i], places[i-1]]; saveData(); renderPlaces(); updateRoute();
        } else if (btn.classList.contains('move-down') && i<places.length-1) {
          [places[i+1], places[i]] = [places[i], places[i+1]]; saveData(); renderPlaces(); updateRoute();
        } else if (btn.classList.contains('set-next')) {
          if (i>=1) { currentStopIndex = i; showToast(`Pr√≥xima parada: ${places[i].name}`); renderPlaces(); }
        }
      });

      document.getElementById('expenses-list').addEventListener('click', (e) => {
        const btn = e.target.closest('button'); if (!btn) return;
        const i = parseInt(btn.dataset.index); if (isNaN(i)) return;
        if (confirm('Remover este gasto?')) { generalExpenses.splice(i,1); saveData(); renderExpenses(); showToast('Gasto removido!'); }
      });

      // otimizar (mantemos ordem do usu√°rio ‚Äì bot√£o s√≥ recalc)
      document.getElementById('optimize-route').addEventListener('click', () => {
        if (places.length < 2) { showToast('Adicione pelo menos 2 locais', true); return; }
        updateRoute(); showToast('Rota atualizada!');
      });

      // limpar
      document.getElementById('clear-route').addEventListener('click', () => {
        if (places.length > 0 && confirm('Tem certeza que deseja limpar toda a rota?')) {
          places = []; generalExpenses = []; saveData(); renderPlaces(); renderExpenses(); updateRoute();
          stopGPSTracking();
          if (currentPositionMarker) { currentPositionMarker.setMap(null); currentPositionMarker.fs?.setMap(null); currentPositionMarker=null; }
          pathPolyline.setMap(map);
          pathPolyline.setPath([]);
          poiMarkers.forEach(m=>m.setMap(null)); poiMarkers=[];
          document.getElementById('abort-temp').style.display = 'none';
          searchTempMarker?.setMap(null); searchTempMarker=null;
          mapClickMarker?.setMap(null); mapClickMarker=null;
          currentStopIndex = 0; nextLegETA = nextLegDist = null; nextStepText='‚Äî'; updateHUDLabels();
          showToast('Roteiro limpo!');
        }
      });

      // iniciar/parar
      document.getElementById('start-trip').addEventListener('click', () => {
        if (isTracking) { stopGPSTracking(); showToast('Rastreamento parado'); }
        else {
          if (places.length < 2) { showToast('Adicione pelo menos origem e destino', true); return; }
          startGPSTracking({goFullscreen:true});
        }
      });

      // fullscreen manual
      document.getElementById('btn-enter-fs').addEventListener('click', () => enterFullscreen());
      document.getElementById('btn-exit-fs').addEventListener('click', () => exitFullscreen());

      // HUD actions
      document.getElementById('btn-next-go').addEventListener('click', () => {
        if (!isTracking) { showToast('Inicie a viagem.', true); return; }
        const pos = currentPositionMarker ? { lat: currentPositionMarker.getPosition().lat(), lng: currentPositionMarker.getPosition().lng() } : null;
        if (!pos) { showToast('Posi√ß√£o atual indispon√≠vel.', true); return; }
        if (places.length < 2) return;
        if (currentStopIndex < 1) currentStopIndex = 1;
        const target = places[currentStopIndex];
        setTemporaryDestination({ name: target.name, lat: target.lat, lng: target.lng });
      });
      document.getElementById('btn-skip-stop').addEventListener('click', () => {
        if (places.length < 2) return;
        if (currentStopIndex < places.length - 1) {
          currentStopIndex++; showToast(`Pulada. Pr√≥xima: ${places[currentStopIndex].name}`); updateHUDLabels();
        }
      });
      document.getElementById('btn-follow').addEventListener('click', () => { followMode = true; centerOnCurrent(); });

      // bot√µes flutuantes
      document.getElementById('btn-recenter').addEventListener('click', () => { followMode = true; centerOnCurrent(); });
      document.getElementById('abort-temp').addEventListener('click', () => { if (confirm('Abandonar rota tempor√°ria?')) abortTemporaryRoute(); });

      // inputs
      document.getElementById('fuel-efficiency').addEventListener('change', updateStats);
      document.getElementById('fuel-price').addEventListener('change', updateStats);
      document.getElementById('search').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); document.getElementById('btn-search').click(); } });
    }

    // ---------- Busca (marcador azul claro, draggable) ----------
    function showSearchTempMarker(latLng, placeName, address) {
      const markerIcon = { url: 'https://maps.google.com/mapfiles/ms/icons/lightblue-dot.png', scaledSize: new google.maps.Size(36,36) };
      if (searchTempMarker) {
        searchTempMarker.setPosition(latLng);
        searchTempMarker.setTitle(placeName || 'Local encontrado');
      } else {
        searchTempMarker = new google.maps.Marker({
          position: latLng, map, title: placeName || 'Local encontrado', icon: markerIcon, draggable: true, animation: google.maps.Animation.BOUNCE, zIndex: 1100
        });
        setTimeout(()=>{ searchTempMarker?.setAnimation(null); }, 1200);
        searchTempMarker.addListener('dragend', () => { map.panTo(searchTempMarker.getPosition()); });
        searchTempMarker.addListener('click', () => { map.panTo(searchTempMarker.getPosition()); });
      }
      map.panTo(latLng); map.setZoom(15);
      document.getElementById('place-name').value ||= (placeName || '');
      document.getElementById('search').value ||= (address || '');
    }

    // ---------- helpers ----------
    function activeMap() {
      return (document.fullscreenElement || fsOverlay().classList.contains('active')) ? fsMap : map;
    }

    // ---------- carregar Google Maps script dinamicamente ----------
    function getApiKey() {
      const urlParams = new URLSearchParams(window.location.search);
      if (GM_API_KEY && GM_API_KEY !== 'YOUR_API_KEY_HERE') return GM_API_KEY;
      const fromLocal = localStorage.getItem('gm_api_key'); if (fromLocal) return fromLocal;
      const fromUrl = urlParams.get('gm_key'); if (fromUrl) return fromUrl;
      return null;
    }
    function loadGoogleMaps() {
      const key = getApiKey();
      if (!key) console.warn('Substitua YOUR_API_KEY_HERE pela sua chave do Google Maps, ou salve em localStorage["gm_api_key"], ou passe ?gm_key=...');
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key || 'YOUR_API_KEY_HERE')}&libraries=places,directions,geometry&callback=initMap`;
      script.async = true; script.defer = true;
      script.onerror = () => showToast('Falha ao carregar Google Maps. Verifique sua chave/API.', true);
      document.head.appendChild(script);
    }
    window.addEventListener('DOMContentLoaded', loadGoogleMaps);
  </script>
</body>
</html>
