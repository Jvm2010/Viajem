<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Roteiro — Viagem</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script type="module" src="app_mod.js" defer></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-gray-50 text-gray-800">
  <header class="bg-white shadow p-4 sticky top-0 z-10">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <h1 class="text-lg font-semibold">Roteiro — Viagem</h1>
      <nav class="text-sm space-x-4">
        <a href="index.html" class="text-sky-600">Início</a>
        <a href="fotos.html" class="text-sky-600">Fotos & Vídeos</a>
      </nav>
    </div>
  </header>

  <main class="max-w-4xl mx-auto p-4 space-y-4">
    <section class="card">
      <h2 class="font-semibold">Adicionar local</h2>
      <p class="small">Toque no mapa para adicionar um ponto ou use o campo para pesquisar.</p>

      <div class="mt-3 grid grid-cols-1 gap-3">
        <div class="flex gap-2">
          <input id="search" class="flex-1 input card p-2" placeholder="Pesquisar endereço ou nome do local" />
          <button id="btn-search" class="badge">Procurar</button>
        </div>

        <div class="input-grid">
          <input id="place-name" placeholder="Nome do local (ex: Praia do X)" class="p-2 card" />
          <input id="place-value" placeholder="Valor (opcional)" class="p-2 card" type="number" min="0" />
          <button id="add-current" class="badge">Adicionar</button>
        </div>

        <div class="flex gap-2 items-center">
          <label class="small">Gastos gerais separados</label>
          <button id="add-general" class="text-sm text-sky-600">Adicionar gasto geral</button>
        </div>
      </div>
    </section>

    <section class="grid md:grid-cols-2 gap-4">
      <div class="card">
        <h3 class="font-semibold">Mapa</h3>
        <div id="map" class="mt-3"></div>
        <div class="small mt-2">Clique nos marcadores para editar/remover. A ordem de lista define a rota.</div>
      </div>

      <div class="card">
        <h3 class="font-semibold">Locais salvos</h3>
        <div id="places-list" class="mt-3"></div>

        <h4 class="mt-4 font-semibold">Gastos gerais</h4>
        <div id="general-list" class="mt-2"></div>

        <div class="footer-summary mt-4">
          <div>
            <div class="small">Distância total</div>
            <div id="total-distance" class="text-xl font-bold">0 km</div>
          </div>
          <div>
            <div class="small">Custo total</div>
            <div id="total-cost" class="text-xl font-bold">R$ 0,00</div>
          </div>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="export-json" class="badge">Exportar JSON</button>
          <button id="clear-all" class="text-sm text-red-600">Limpar tudo</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal backdrop -->
  <div id="modal-backdrop" class="modal-backdrop" aria-hidden="true" style="display:flex">
    <div class="modal">
      <div class="flex items-center justify-between">
        <h3 id="modal-title" class="font-semibold text-lg">Título</h3>
        <button id="modal-cancel" class="text-sm text-gray-500">✕</button>
      </div>
      <div id="modal-body" class="mt-3 small"></div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="modal-confirm" class="badge">Confirmar</button>
        <button id="modal-cancel-2" onclick="document.getElementById('modal-backdrop').classList.remove('show')" class="text-sm text-gray-500">Cancelar</button>
      </div>
    </div>
  </div>


  <footer class="max-w-4xl mx-auto p-4 text-center small">
    Desenvolvido — Melhorias rápidas para usar no celular.
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script type="module">
  import * as core from './app_mod.js';

  const state = core.loadState();
  const map = L.map('map').setView([-23.5489, -46.6388], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);

  let markers = [];
  const toastEl = createToast();
  const modalEl = document.getElementById('modal-backdrop');
  const modalTitle = document.getElementById('modal-title');
  const modalBody = document.getElementById('modal-body');
  const modalConfirm = document.getElementById('modal-confirm');
  const modalCancel = document.getElementById('modal-cancel');

  function showToast(msg, timeout=2000){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), timeout); }
  function createToast(){ const t = document.createElement('div'); t.className='toast'; document.body.appendChild(t); return t; }
  function showModal(title, bodyHtml, onConfirm){ modalTitle.textContent=title; modalBody.innerHTML = bodyHtml; modalEl.classList.add('show'); function cleanup(){ modalEl.classList.remove('show'); modalConfirm.onclick = null; modalCancel.onclick = null; } modalConfirm.onclick = ()=>{ try{ onConfirm(); } finally{ cleanup(); } }; modalCancel.onclick = cleanup; }

  function renderLists(){
    const places = document.getElementById('places-list');
    places.innerHTML='';
    state.points.forEach((p, idx)=>{
      const div = document.createElement('div'); div.className='list-item fade-in';
      const left = document.createElement('div');
      // make name and value editable inline
      left.innerHTML = `<div contenteditable="true" class="editable" data-idx="${idx}" data-field="name" title="Clique para editar">${escapeHtml(p.name)}</div><div class="small">${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}</div>`;
      const right = document.createElement('div' );
      right.innerHTML = `<div class="text-right"><div contenteditable="true" class="editable" data-idx="${idx}" data-field="value">${p.value?p.value:''}</div><div class="mt-2"><button class="text-sm text-sky-600 btn-focus" data-idx="${idx}" data-action="zoom">Ir</button> <button class="text-sm text-red-600" data-idx="${idx}" data-action="del">Remover</button></div></div>`;
      div.appendChild(left); div.appendChild(right);
      places.appendChild(div);
    });

    const gen = document.getElementById('general-list');
    gen.innerHTML='';
    state.generalExpenses.forEach((g, i)=>{
      const d = document.createElement('div'); d.className='list-item fade-in';
      d.innerHTML = `<div><div class="font-semibold editable" contenteditable="true" data-gi="${i}" data-field="title">${escapeHtml(g.title)}</div><div class="small">${new Date(g.created).toLocaleString()}</div></div><div class="text-right">${core.formatCurrency(g.amount)} <div class="mt-2"><button class="text-sm text-red-600" data-gi="${i}" data-action="delgen">Remover</button></div></div>`;
      gen.appendChild(d);
    });

    // markers
    markers.forEach(m=>map.removeLayer(m)); markers = [];
    state.points.forEach((p, idx)=>{
      const m = L.marker([p.lat,p.lng]).addTo(map).bindPopup(`<strong>${escapeHtml(p.name)}</strong><br>${p.value?core.formatCurrency(p.value):''}`);
      m.on('click', ()=>{ showToast(p.name, 1000); });
      markers.push(m);
    });

    attachEditableHandlers();
    updateTotals();
  }

  function attachEditableHandlers(){
    document.querySelectorAll('[contenteditable="true"]').forEach(el=>{
      el.addEventListener('blur', (e)=>{
        const idx = el.dataset.idx;
        const field = el.dataset.field;
        const gi = el.dataset.gi;
        if(typeof idx !== 'undefined' && field){
          // place edit
          const i = Number(idx); const val = el.textContent.trim();
          if(field === 'name'){ state.points[i].name = val||'Ponto'; showToast('Nome salvo'); }
          if(field === 'value'){ state.points[i].value = Number(val)||0; showToast('Valor salvo'); }
          renderLists();
        } else if(typeof gi !== 'undefined' && el.dataset.field === 'title'){
          const g = Number(gi); state.generalExpenses[g].title = el.textContent.trim()||'Gasto'; showToast('Título salvo'); renderLists();
        }
      });
      // allow Enter to blur (prevent newlines)
      el.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); el.blur(); } });
    });
  }

  function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  function updateTotals(){
    let totalKm = 0;
    for(let i=1;i<state.points.length;i++){
      totalKm += core.haversine(state.points[i-1], state.points[i]);
    }
    document.getElementById('total-distance').textContent = totalKm.toFixed(2) + ' km';
    let totalCost = state.points.reduce((s,p)=>s + (Number(p.value)||0), 0) + state.generalExpenses.reduce((s,g)=>s + (Number(g.amount)||0),0);
    document.getElementById('total-cost').textContent = core.formatCurrency(totalCost);
    core.saveState(state);
  }

  map.on('click', function(e){
    const lat = e.latlng.lat, lng = e.latlng.lng;
    document.getElementById('place-name').value = '';
    document.getElementById('place-value').value = '';
    map._temp = {lat,lng};
    showToast('Local selecionado. Preencha nome e toque Adicionar.');
  });

  document.getElementById('add-current').addEventListener('click', ()=>{
    const name = document.getElementById('place-name').value.trim() || 'Ponto';
    const val = document.getElementById('place-value').value;
    const coords = map._temp || {lat: map.getCenter().lat, lng: map.getCenter().lng};
    state.points.push({name, lat: coords.lat, lng: coords.lng, value: val?Number(val):0});
    renderLists();
    showToast('Local adicionado!');
  });

  document.getElementById('places-list').addEventListener('click', (ev)=>{
    const a = ev.target.closest('button');
    if(!a) return;
    if(a.dataset.action === 'zoom'){
      const i = Number(a.dataset.idx); map.setView([state.points[i].lat,state.points[i].lng],15);
      // open popup to highlight
      markers[i].openPopup();
    } else if(a.dataset.action === 'del'){
      const i = Number(a.dataset.idx);
      showModal('Remover local', `<p>Remover <strong>${escapeHtml(state.points[i].name)}</strong>?</p>`, ()=>{ state.points.splice(i,1); renderLists(); showToast('Removido'); });
    }
  });

  document.getElementById('general-list').addEventListener('click', (ev)=>{
    const b = ev.target.closest('button');
    if(!b) return;
    if(b.dataset.action === 'delgen'){
      const i = Number(b.dataset.gi);
      showModal('Remover gasto', `<p>Remover <strong>${escapeHtml(state.generalExpenses[i].title)}</strong>?</p>`, ()=>{ state.generalExpenses.splice(i,1); renderLists(); showToast('Gasto removido'); });
    }
  });

  document.getElementById('add-general').addEventListener('click', ()=>{
    showModal('Adicionar gasto geral', `<div><label class="small">Título</label><input id="gen-title" class="p-2 card w-full" value="Gasto" /></div><div class="mt-2"><label class="small">Valor (R$)</label><input id="gen-amt" type="number" min="0" class="p-2 card w-full" value="0" /></div>`, ()=>{ const title = document.getElementById('gen-title').value||'Gasto'; const amt = Number(document.getElementById('gen-amt').value)||0; state.generalExpenses.push({title, amount: amt, created: Date.now()}); renderLists(); showToast('Gasto geral adicionado'); });
  });

  document.getElementById('export-json').addEventListener('click', ()=>{
    const a = document.createElement('a');
    const blob = new Blob([JSON.stringify(state, null, 2)],{type:'application/json'});
    a.href = URL.createObjectURL(blob);
    a.download = 'roteiro.json';
    a.click();
  });

  document.getElementById('clear-all').addEventListener('click', ()=>{
    showModal('Limpar roteiro', `<p>Deseja limpar todos os locais e gastos?</p>`, ()=>{ state.points=[]; state.generalExpenses=[]; renderLists(); showToast('Roteiro limpo'); });
  });

  document.getElementById('btn-search').addEventListener('click', async ()=>{
    const q = document.getElementById('search').value.trim();
    if(!q) return showToast('Digite algo para buscar');
    const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(q));
    const data = await res.json();
    if(!data || !data.length) return showToast('Nenhum resultado');
    const top = data[0];
    const lat = parseFloat(top.lat), lon = parseFloat(top.lon);
    map.setView([lat,lon],15);
    map._temp = {lat, lng: lon};
    document.getElementById('place-name').value = top.display_name;
    showToast('Resultado selecionado. Preencha nome e adicione.');
  });

  // initial render
  renderLists();
  </script>

</body>
</html>
