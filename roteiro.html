<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Roteiro de Viagem</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            travel: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            }
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
    }
    #map {
      height: 400px;
      width: 100%;
      border-radius: 16px;
      background-color: #e5e7eb; /* Cor de fundo enquanto o mapa carrega */
    }
    /* Garante que o mapa ocupe espaço mesmo durante o carregamento */
    .map-container {
      min-height: 400px;
    }
    @media (min-width: 768px) {
      #map {
        height: 400px;
      }
    }
    .place-item {
      transition: all 0.3s ease;
    }
    .place-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    .category-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    #start-trip.tracking {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 24px;
      border-radius: 8px;
      color: white;
      background-color: #0ea5e9;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      transition: opacity 0.3s ease;
    }
    .toast.error {
      background-color: #dc2626;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Cabeçalho -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="container mx-auto px-4 py-6 max-w-3xl">
      <h1 class="text-2xl font-bold text-travel-700">Roteiro de Viagem</h1>
      <nav class="flex gap-4">
        <a href="fotos.html" class="text-travel-600 font-medium">Fotos</a>
        <a href="index.html" class="text-gray-500">Sair</a>
      </nav>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6 max-w-3xl">
    <!-- Configurações do Veículo -->
    <div class="card bg-white p-4 mb-6 shadow-md rounded-xl">
      <h2 class="text-lg font-semibold text-travel-800 mb-3">Configurações do Veículo</h2>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Consumo (km/l)</label>
          <input id="fuel-efficiency" type="number" min="1" value="10" class="w-full p-3 border border-gray-200 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Preço do Combustível (R$/l)</label>
          <input id="fuel-price" type="number" min="0.1" step="0.01" value="5.50" class="w-full p-3 border border-gray-200 rounded-lg">
        </div>
      </div>
    </div>

    <!-- Mapa Google -->
    <div class="card bg-white p-4 mb-6 shadow-md rounded-xl">
      <h2 class="text-lg font-semibold text-blue-800 mb-3">Mapa da Viagem</h2>
      <div class="map-container">
        <div id="map"></div>
       </div>
          <button id="start-trip" class="bg-travel-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-travel-700 transition mr-2">
            Iniciar Viagem
          </button>
          <button id="optimize-route" class="bg-travel-100 text-travel-700 px-4 py-2 rounded-lg font-medium hover:bg-travel-200 transition">
            Otimizar Rota
          </button>
        </div>
        <button id="clear-route" class="text-red-500 px-4 py-2 rounded-lg border border-red-200 hover:bg-red-50 transition">
          Limpar Tudo
        </button>
      </div>
    </div>

    <!-- Adicionar Local -->
    <div class="card bg-white p-5 mb-6 shadow-md rounded-xl">
      <h2 class="text-lg font-semibold text-travel-800 mb-4">Adicionar Local</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Pesquisar local...</label>
          <div class="relative">
            <input id="search" type="text" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-travel-300 focus:border-travel-300" placeholder="Digite o nome de um local">
            <button id="btn-search" class="absolute right-2 top-2 bg-travel-500 text-white p-2 rounded-lg">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
              </svg>
            </button>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Local</label>
            <input id="place-name" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-travel-300">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Custo (R$)</label>
            <input id="place-value" type="number" min="0" step="0.01" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-travel-300">
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
          <select id="place-category" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-travel-300">
            <option value="attraction">Atração Turística</option>
            <option value="park">Parque/Natureza</option>
            <option value="hotel">Hotel/Hospedagem</option>
            <option value="restaurant">Restaurante</option>
            <option value="museum">Museu/Cultural</option>
            <option value="shopping">Compras</option>
            <option value="other">Outro</option>
          </select>
        </div>
        
        <button id="add-place" class="w-full bg-travel-600 text-white py-3 rounded-lg font-medium hover:bg-travel-700 transition">
          Adicionar Local
        </button>
      </div>
    </div>

    <!-- Locais Salvos -->
    <div class="card bg-white p-5 mb-6 shadow-md rounded-xl">
      <h2 class="text-lg font-semibold text-travel-800 mb-4">Locais Salvos</h2>
      <div id="places-list" class="space-y-3"></div>
    </div>

    <!-- Gastos Gerais -->
    <div class="card bg-white p-5 mb-6 shadow-md rounded-xl">
      <h2 class="text-lg font-semibold text-travel-800 mb-4">Gastos Gerais</h2>
      <div id="expenses-list" class="space-y-3 mb-4"></div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
          <input id="expense-title" class="w-full p-3 border border-gray-200 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
          <input id="expense-amount" type="number" min="0" step="0.01" class="w-full p-3 border border-gray-200 rounded-lg">
        </div>
        <div class="flex items-end">
          <button id="add-expense" class="w-full bg-travel-600 text-white py-3 rounded-lg font-medium hover:bg-travel-700 transition">
            Adicionar
          </button>
        </div>
      </div>
    </div>

    <!-- Resumo Completo -->
    <div class="card bg-white p-5 shadow-md rounded-xl">
      <h2 class="text-lg font-semibold text-travel-800 mb-4">Resumo da Viagem</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div class="bg-travel-50 p-3 rounded-lg">
          <p class="text-sm text-gray-600">Distância Total</p>
          <p id="total-distance" class="text-xl font-bold text-travel-700">0 km</p>
        </div>
        <div class="bg-travel-50 p-3 rounded-lg">
          <p class="text-sm text-gray-600">Tempo Total</p>
          <p id="total-time" class="text-xl font-bold text-travel-700">0 min</p>
        </div>
        <div class="bg-travel-50 p-3 rounded-lg">
          <p class="text-sm text-gray-600">Custo de Combustível</p>
          <p id="fuel-cost" class="text-xl font-bold text-travel-700">R$ 0,00</p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div class="bg-travel-50 p-3 rounded-lg">
          <p class="text-sm text-gray-600">Custo dos Locais</p>
          <p id="places-cost" class="text-xl font-bold text-travel-700">R$ 0,00</p>
        </div>
        <div class="bg-travel-50 p-3 rounded-lg">
          <p class="text-sm text-gray-600">Gastos Gerais</p>
          <p id="expenses-cost" class="text-xl font-bold text-travel-700">R$ 0,00</p>
        </div>
        <div class="bg-travel-50 p-3 rounded-lg">
          <p class="text-sm text-gray-600">Custo Total</p>
          <p id="total-cost" class="text-xl font-bold text-travel-700">R$ 0,00</p>
        </div>
      </div>

      <div id="route-details" class="space-y-2">
        <!-- Detalhes da rota serão inseridos aqui -->
      </div>
    </div>
  </main>

  <script>
    // Variáveis globais
    let map;
    let directionsService;
    let directionsRenderer;
    let markers = [];
    let places = [];
    let generalExpenses = [];
    let infoWindow;
    let autocomplete;
    
    // Variáveis para o rastreamento GPS
    let watchId = null;
    let currentPositionMarker = null;
    let pathCoordinates = [];
    let pathPolyline = null;

    // Cores e ícones para categorias
    const categoryStyles = {
      attraction: { color: 'red', icon: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png', name: 'Atração' },
      park: { color: 'green', icon: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png', name: 'Parque' },
      hotel: { color: 'blue', icon: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png', name: 'Hotel' },
      restaurant: { color: 'orange', icon: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png', name: 'Restaurante' },
      museum: { color: 'yellow', icon: 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png', name: 'Museu' },
      shopping: { color: 'pink', icon: 'https://maps.google.com/mapfiles/ms/icons/pink-dot.png', name: 'Compras' },
      other: { color: 'purple', icon: 'https://maps.google.com/mapfiles/ms/icons/purple-dot.png', name: 'Outro' }
    };

    // Estilo para o marcador de posição atual
    const currentPositionIcon = {
      url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
      scaledSize: new google.maps.Size(40, 40),
      anchor: new google.maps.Point(20, 20)
    };

    // Função para mostrar notificações
    function showToast(message, isError = false) {
      const toast = document.createElement('div');
      toast.className = `toast ${isError ? 'error' : ''}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Inicialização do mapa
    // Função para inicializar o mapa
    function initMap() {
      console.log("Inicializando mapa...");
      
      // Coordenadas iniciais (Brasília)
      const initialLocation = { lat: -15.795, lng: -47.891 };
      
      // Criar o mapa
      const map = new google.maps.Map(document.getElementById("map"), {
        center: initialLocation,
        zoom: 12,
        mapTypeControl: true,
        streetViewControl: false,
        styles: [
          {
            featureType: "poi",
            elementType: "labels",
            stylers: [{ visibility: "off" }]
          }
        ]
      });
      
      // Adicionar um marcador inicial
      new google.maps.Marker({
        position: initialLocation,
        map: map,
        title: "Localização inicial"
      });
      
      console.log("Mapa inicializado com sucesso!");
    }

    // Carregar a API do Google Maps
    function loadGoogleMaps() {
      // Verificar se a API já foi carregada
      if (window.google && window.google.maps) {
        initMap();
        return;
      }
      
      const script = document.createElement("script");
      script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyAPkjcgFgdopkeZN0GnvhOc787jrajJnWc&callback=initMap`;
      script.async = true;
      script.defer = true;
      script.onerror = () => {
        console.error("Erro ao carregar a API do Google Maps");
        document.getElementById("map").innerHTML = 
          '<div class="p-4 text-center text-red-600">Erro ao carregar o mapa. Verifique sua conexão com a internet.</div>';
      };
      document.head.appendChild(script);
    }

    // Iniciar quando a página carregar
    window.addEventListener("DOMContentLoaded", () => {
      console.log("Página carregada, carregando mapa...");
      loadGoogleMaps();
    });

      infoWindow = new google.maps.InfoWindow();

      // Configurar autocomplete para pesquisa
      autocomplete = new google.maps.places.Autocomplete(
        document.getElementById('search'),
        {
          types: ['establishment', 'geocode'],
          fields: ['name', 'geometry', 'formatted_address', 'types']
        }
      );

      // Quando um lugar é selecionado no autocomplete
      autocomplete.addListener('place_changed', onPlaceChanged);

      // Carregar dados salvos
      loadData();
      
      // Configurar eventos
      setupEventListeners();
    }

    // Função chamada quando um lugar é selecionado no autocomplete
    function onPlaceChanged() {
      const place = autocomplete.getPlace();
      
      if (!place.geometry) {
        showToast('Local não encontrado. Tente outro termo de busca.', true);
        return;
      }
      
      // Centralizar o mapa no local encontrado
      map.setCenter(place.geometry.location);
      map.setZoom(15);
      
      // Preencher automaticamente o nome do local
      document.getElementById('place-name').value = place.name;
      
      // Tentar determinar a categoria automaticamente
      let category = 'other';
      if (place.types.includes('park') || place.types.includes('natural_feature')) {
        category = 'park';
      } else if (place.types.includes('tourist_attraction') || place.types.includes('point_of_interest')) {
        category = 'attraction';
      } else if (place.types.includes('lodging') || place.types.includes('hotel')) {
        category = 'hotel';
      } else if (place.types.includes('restaurant') || place.types.includes('food')) {
        category = 'restaurant';
      } else if (place.types.includes('museum') || place.types.includes('art_gallery')) {
        category = 'museum';
      } else if (place.types.includes('shopping_mall') || place.types.includes('store')) {
        category = 'shopping';
      }
      
      document.getElementById('place-category').value = category;
      
      // Mostrar o endereço completo no campo de pesquisa
      if (place.formatted_address) {
        document.getElementById('search').value = place.formatted_address;
      }
      
      showToast('Local encontrado! Preencha os detalhes e adicione.');
    }

    // Função para iniciar o rastreamento GPS
    function startGPSTracking() {
      if (navigator.geolocation) {
        showToast('Iniciando rastreamento GPS...');
        
        watchId = navigator.geolocation.watchPosition(
          (position) => {
            const pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            
            // Atualiza ou cria o marcador da posição atual
            if (!currentPositionMarker) {
              currentPositionMarker = new google.maps.Marker({
                position: pos,
                map: map,
                icon: currentPositionIcon,
                title: 'Sua posição atual',
                zIndex: 1000
              });
            } else {
              currentPositionMarker.setPosition(pos);
            }
            
            // Centraliza o mapa na posição atual (apenas no primeiro movimento)
            if (pathCoordinates.length === 0) {
              map.setCenter(pos);
              map.setZoom(15);
            }
            
            // Adiciona a posição ao histórico do trajeto
            pathCoordinates.push(pos);
            
            // Atualiza a linha do trajeto percorrido
            updatePathPolyline();
            
            // Se houver locais na rota, calcular distância até o próximo
            if (places.length > 0) {
              calculateDistanceToNextPlace(pos);
            }
          },
          (error) => {
            let errorMessage;
            switch(error.code) {
              case error.PERMISSION_DENIED:
                errorMessage = "Permissão de localização negada. Ative no navegador.";
                break;
              case error.POSITION_UNAVAILABLE:
                errorMessage = "Informação de localização indisponível.";
                break;
              case error.TIMEOUT:
                errorMessage = "Tempo de espera para localização expirado.";
                break;
              default:
                errorMessage = "Erro desconhecido no GPS.";
            }
            showToast(errorMessage, true);
            stopGPSTracking();
          },
          {
            enableHighAccuracy: true,
            maximumAge: 30000,
            timeout: 27000
          }
        );
        
        document.getElementById('start-trip').textContent = 'Parar Rastreamento';
        document.getElementById('start-trip').classList.remove('bg-travel-600');
        document.getElementById('start-trip').classList.add('bg-red-600', 'tracking');
      } else {
        showToast('Geolocalização não é suportada por este navegador.', true);
      }
    }

    // Função para calcular distância até o próximo local na rota
    function calculateDistanceToNextPlace(currentPos) {
      if (!places || places.length === 0) return;
      
      // Encontrar o local mais próximo
      let closestPlace = null;
      let minDistance = Infinity;
      
      places.forEach(place => {
        const distance = google.maps.geometry.spherical.computeDistanceBetween(
          new google.maps.LatLng(currentPos.lat, currentPos.lng),
          new google.maps.LatLng(place.lat, place.lng)
        );
        
        if (distance < minDistance) {
          minDistance = distance;
          closestPlace = place;
        }
      });
      
      // Mostrar notificação se estiver próximo (menos de 500m)
      if (minDistance < 500) {
        showToast(`Você está próximo de ${closestPlace.name} (${Math.round(minDistance)}m)`);
      }
    }

    // Função para atualizar a linha do trajeto
    function updatePathPolyline() {
      if (pathPolyline) {
        pathPolyline.setMap(null);
      }
      
      if (pathCoordinates.length > 1) {
        pathPolyline = new google.maps.Polyline({
          path: pathCoordinates,
          geodesic: true,
          strokeColor: '#0ea5e9',
          strokeOpacity: 1.0,
          strokeWeight: 4,
          map: map
        });
      }
    }

    // Função para parar o rastreamento GPS
    function stopGPSTracking() {
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      
      document.getElementById('start-trip').textContent = 'Iniciar Viagem';
      document.getElementById('start-trip').classList.add('bg-travel-600');
      document.getElementById('start-trip').classList.remove('bg-red-600', 'tracking');
    }

    // Carregar dados do localStorage
    function loadData() {
      const savedPlaces = localStorage.getItem('travel_places');
      const savedExpenses = localStorage.getItem('travel_expenses');
      
      if (savedPlaces) places = JSON.parse(savedPlaces);
      if (savedExpenses) generalExpenses = JSON.parse(savedExpenses);
      
      renderPlaces();
      renderExpenses();
      updateRoute();
    }

    // Salvar dados no localStorage
    function saveData() {
      localStorage.setItem('travel_places', JSON.stringify(places));
      localStorage.setItem('travel_expenses', JSON.stringify(generalExpenses));
    }

    // Renderizar lista de locais
    function renderPlaces() {
      const container = document.getElementById('places-list');
      container.innerHTML = '';

      if (places.length === 0) {
        container.innerHTML = '<div class="text-center py-4 text-gray-500">Nenhum local adicionado ainda</div>';
        return;
      }

      places.forEach((place, index) => {
        const category = categoryStyles[place.category] || categoryStyles.other;
        
        const div = document.createElement('div');
        div.className = 'place-item bg-white p-4 rounded-lg border border-gray-200';
        div.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <div class="flex items-center gap-2">
                <h3 class="font-semibold text-travel-800">${place.name}</h3>
                <span class="category-badge" style="background-color: ${category.color}20; color: ${category.color}800">
                  ${category.name}
                </span>
              </div>
              ${place.value ? `<p class="text-sm text-travel-600">R$ ${place.value.toFixed(2)}</p>` : ''}
              ${place.address ? `<p class="text-xs text-gray-500 mt-1">${place.address}</p>` : ''}
            </div>
            <div class="flex gap-2">
              <button data-index="${index}" class="move-up text-travel-600 hover:text-travel-800 p-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
              </button>
              <button data-index="${index}" class="move-down text-travel-600 hover:text-travel-800 p-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </button>
              <button data-index="${index}" class="delete-place text-red-500 hover:text-red-700 p-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
              </button>
            </div>
          </div>
        `;
        container.appendChild(div);
      });

      updateStats();
    }

    // Renderizar gastos gerais
    function renderExpenses() {
      const container = document.getElementById('expenses-list');
      container.innerHTML = '';

      if (generalExpenses.length === 0) {
        container.innerHTML = '<div class="text-center py-4 text-gray-500">Nenhum gasto geral adicionado</div>';
        return;
      }

      generalExpenses.forEach((expense, index) => {
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg';
        div.innerHTML = `
          <div>
            <p class="font-medium">${expense.title}</p>
            <p class="text-xs text-gray-500">${new Date(expense.date).toLocaleDateString()}</p>
          </div>
          <div class="flex items-center gap-2">
            <p class="font-medium">R$ ${expense.amount.toFixed(2)}</p>
            <button data-index="${index}" class="text-red-500 hover:text-red-700">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
              </svg>
            </button>
          </div>
        `;
        container.appendChild(div);
      });

      updateStats();
    }

    // Atualizar rota no mapa
    function updateRoute() {
      // Limpar marcadores antigos
      markers.forEach(marker => marker.setMap(null));
      markers = [];

      if (places.length === 0) {
        directionsRenderer.setMap(null);
        document.getElementById('route-details').innerHTML = '';
        return;
      }

      // Adicionar marcadores personalizados por categoria
      places.forEach((place, index) => {
        const category = categoryStyles[place.category] || categoryStyles.other;
        
        const marker = new google.maps.Marker({
          position: { lat: place.lat, lng: place.lng },
          map: map,
          label: {
            text: (index + 1).toString(),
            color: 'white',
            fontSize: '14px',
            fontWeight: 'bold'
          },
          icon: {
            url: category.icon,
            scaledSize: new google.maps.Size(40, 40),
            labelOrigin: new google.maps.Point(20, 13)
          }
        });

        // InfoWindow ao clicar no marcador
        marker.addListener('click', () => {
          infoWindow.setContent(`
            <div class="p-2">
              <h3 class="font-bold text-lg">${place.name}</h3>
              <p class="text-sm ${category.color}-600 mb-1">${category.name}</p>
              ${place.value ? `<p class="text-travel-600">Custo: R$ ${place.value.toFixed(2)}</p>` : ''}
              ${place.address ? `<p class="text-sm text-gray-600 mt-1">${place.address}</p>` : ''}
            </div>
          `);
          infoWindow.open(map, marker);
        });

        markers.push(marker);
      });

      // Se apenas um local, centralizar nele
      if (places.length === 1) {
        map.setCenter(markers[0].getPosition());
        map.setZoom(14);
        directionsRenderer.setMap(null);
        document.getElementById('route-details').innerHTML = '';
        return;
      }

      // Para múltiplos locais, calcular rota
      if (places.length >= 2) {
        const waypoints = places.slice(1, -1).map(place => ({
          location: { lat: place.lat, lng: place.lng },
          stopover: true
        }));

        const request = {
          origin: { lat: places[0].lat, lng: places[0].lng },
          destination: { lat: places[places.length - 1].lat, lng: places[places.length - 1].lng },
          waypoints: waypoints,
          travelMode: 'DRIVING',
          optimizeWaypoints: true,
          provideRouteAlternatives: false
        };

        directionsService.route(request, (result, status) => {
          if (status === 'OK') {
            directionsRenderer.setDirections(result);
            
            // Ajustar o zoom para mostrar toda a rota
            const bounds = new google.maps.LatLngBounds();
            result.routes[0].legs.forEach(leg => {
              bounds.extend(leg.start_location);
              bounds.extend(leg.end_location);
            });
            map.fitBounds(bounds);
            
            updateStats(result);
            renderRouteDetails(result);
          }
        });
      }
    }

    // Renderizar detalhes da rota
    function renderRouteDetails(routeResult) {
      const container = document.getElementById('route-details');
      container.innerHTML = '<h3 class="font-semibold mb-2">Detalhes do Percurso:</h3>';
      
      routeResult.routes[0].legs.forEach((leg, index) => {
        const fromPlace = places[index];
        const toPlace = places[index + 1];
        
        const div = document.createElement('div');
        div.className = 'bg-gray-50 p-3 rounded-lg mb-2';
        div.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <p class="font-medium">${fromPlace.name} → ${toPlace.name}</p>
              <p class="text-sm text-gray-600">${leg.distance.text} • ${leg.duration.text}</p>
            </div>
            <p class="text-travel-700 font-medium">${leg.duration.text}</p>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // Atualizar estatísticas
    function updateStats(routeResult) {
      // Calcular custo dos locais
      const placesCost = places.reduce((sum, place) => sum + (place.value || 0), 0);
      document.getElementById('places-cost').textContent = `R$ ${placesCost.toFixed(2)}`;
      
      // Calcular custo dos gastos gerais
      const expensesCost = generalExpenses.reduce((sum, exp) => sum + exp.amount, 0);
      document.getElementById('expenses-cost').textContent = `R$ ${expensesCost.toFixed(2)}`;
      
      // Calcular distância e tempo totais (se tiver rota)
      let totalDistance = 0;
      let totalTime = 0;
      let fuelCost = 0;
      
      if (routeResult) {
        routeResult.routes[0].legs.forEach(leg => {
          totalDistance += leg.distance.value;
          totalTime += leg.duration.value;
        });
        
        // Calcular custo do combustível
        const fuelEfficiency = parseFloat(document.getElementById('fuel-efficiency').value) || 10;
        const fuelPrice = parseFloat(document.getElementById('fuel-price').value) || 5.50;
        const fuelConsumption = (totalDistance / 1000) / fuelEfficiency;
        fuelCost = fuelConsumption * fuelPrice;
      }
      
      document.getElementById('total-distance').textContent = `${(totalDistance / 1000).toFixed(1)} km`;
      
      // Converter segundos para horas e minutos
      const hours = Math.floor(totalTime / 3600);
      const minutes = Math.round((totalTime % 3600) / 60);
      let timeText = '';
      if (hours > 0) timeText += `${hours} h `;
      timeText += `${minutes} min`;
      document.getElementById('total-time').textContent = timeText;
      
      document.getElementById('fuel-cost').textContent = `R$ ${fuelCost.toFixed(2)}`;
      
      // Calcular custo total
      const totalCost = placesCost + expensesCost + fuelCost;
      document.getElementById('total-cost').textContent = `R$ ${totalCost.toFixed(2)}`;
    }

    // Configurar event listeners
    function setupEventListeners() {
      document.getElementById('add-place').addEventListener('click', () => {
        const name = document.getElementById('place-name').value.trim();
        const value = parseFloat(document.getElementById('place-value').value) || 0;
        const category = document.getElementById('place-category').value;

        if (!name) {
          showToast('Por favor, digite um nome para o local', true);
          return;
        }

        const center = map.getCenter();
        const newPlace = {
          name,
          value,
          category,
          lat: center.lat(),
          lng: center.lng(),
          address: document.getElementById('search').value || '',
          date: new Date().toISOString()
        };

        places.push(newPlace);
        saveData();
        renderPlaces();
        updateRoute();
        showToast('Local adicionado com sucesso!');

        // Limpar campos
        document.getElementById('place-name').value = '';
        document.getElementById('place-value').value = '';
        document.getElementById('search').value = '';
      });

      document.getElementById('btn-search').addEventListener('click', () => {
        const query = document.getElementById('search').value.trim();
        if (!query) return;

        const request = {
          query,
          fields: ['name', 'geometry', 'formatted_address', 'types']
        };

        const service = new google.maps.places.PlacesService(map);
        service.findPlaceFromQuery(request, (results, status) => {
          if (status === 'OK' && results[0]) {
            const place = results[0];
            map.setCenter(place.geometry.location);
            
            // Preencher automaticamente o nome do local
            document.getElementById('place-name').value = place.name;
            
            // Tentar determinar a categoria automaticamente
            let category = 'other';
            if (place.types.includes('park') || place.types.includes('natural_feature')) {
              category = 'park';
            } else if (place.types.includes('tourist_attraction') || place.types.includes('point_of_interest')) {
              category = 'attraction';
            } else if (place.types.includes('lodging') || place.types.includes('hotel')) {
              category = 'hotel';
            } else if (place.types.includes('restaurant') || place.types.includes('food')) {
              category = 'restaurant';
            } else if (place.types.includes('museum') || place.types.includes('art_gallery')) {
              category = 'museum';
            } else if (place.types.includes('shopping_mall') || place.types.includes('store')) {
              category = 'shopping';
            }
            
            document.getElementById('place-category').value = category;
            
            // Mostrar o endereço completo no campo de pesquisa
            if (place.formatted_address) {
              document.getElementById('search').value = place.formatted_address;
            }
            
            showToast('Local encontrado! Preencha os detalhes e adicione.');
          } else {
            showToast('Local não encontrado. Tente outro termo de busca.', true);
          }
        });
      });

      document.getElementById('add-expense').addEventListener('click', () => {
        const title = document.getElementById('expense-title').value.trim();
        const amount = parseFloat(document.getElementById('expense-amount').value);

        if (!title || isNaN(amount)) {
          showToast('Por favor, preencha todos os campos do gasto', true);
          return;
        }

        generalExpenses.push({
          title,
          amount,
          date: new Date().toISOString()
        });

        saveData();
        renderExpenses();
        showToast('Gasto adicionado com sucesso!');

        // Limpar campos
        document.getElementById('expense-title').value = '';
        document.getElementById('expense-amount').value = '';
      });

      document.getElementById('places-list').addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        const index = parseInt(btn.dataset.index);
        if (isNaN(index)) return;

        if (btn.classList.contains('delete-place')) {
          if (confirm('Remover este local?')) {
            places.splice(index, 1);
            saveData();
            renderPlaces();
            updateRoute();
            showToast('Local removido!');
          }
        } 
        else if (btn.classList.contains('move-up') && index > 0) {
          [places[index], places[index - 1]] = [places[index - 1], places[index]];
          saveData();
          renderPlaces();
          updateRoute();
        }
        else if (btn.classList.contains('move-down') && index < places.length - 1) {
          [places[index], places[index + 1]] = [places[index + 1], places[index]];
          saveData();
          renderPlaces();
          updateRoute();
        }
      });

      document.getElementById('expenses-list').addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        const index = parseInt(btn.dataset.index);
        if (isNaN(index)) return;

        if (confirm('Remover este gasto?')) {
          generalExpenses.splice(index, 1);
          saveData();
          renderExpenses();
          showToast('Gasto removido!');
        }
      });

      document.getElementById('optimize-route').addEventListener('click', () => {
        if (places.length < 2) {
          showToast('Adicione pelo menos 2 locais para otimizar a rota', true);
          return;
        }
        updateRoute();
        showToast('Rota otimizada com sucesso!');
      });

      document.getElementById('clear-route').addEventListener('click', () => {
        if (places.length > 0 && confirm('Tem certeza que deseja limpar toda a rota?')) {
          places = [];
          generalExpenses = [];
          saveData();
          renderPlaces();
          renderExpenses();
          updateRoute();
          stopGPSTracking();
          if (currentPositionMarker) {
            currentPositionMarker.setMap(null);
            currentPositionMarker = null;
          }
          if (pathPolyline) {
            pathPolyline.setMap(null);
            pathPolyline = null;
          }
          pathCoordinates = [];
          showToast('Roteiro limpo com sucesso!');
        }
      });

      // Event listener para o botão de iniciar/parar viagem
      document.getElementById('start-trip').addEventListener('click', function() {
        if (watchId) {
          stopGPSTracking();
          showToast('Rastreamento parado');
        } else {
          startGPSTracking();
        }
      });

      // Atualizar cálculos quando mudar consumo ou preço do combustível
      document.getElementById('fuel-efficiency').addEventListener('change', updateStats);
      document.getElementById('fuel-price').addEventListener('change', updateStats);

      // Permitir pesquisa ao pressionar Enter
      document.getElementById('search').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('btn-search').click();
        }
      });
    }

    // Carrega a API do Google Maps de forma assíncrona
    function loadGoogleMaps() {
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyAPkjcgFgdopkeZN0GnvhOc787jrajJnWc&libraries=places,directions,geometry&callback=initMap`;
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    }
    
    // Inicia o aplicativo quando a página carregar
    window.addEventListener('DOMContentLoaded', loadGoogleMaps);
  </script>
</body>
</html>
