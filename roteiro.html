<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Roteiro — Viagem (Mapa Corrigido)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script type="module" src="firebase.js"></script>
  <style>
    /* Ensure map container has height */
    #map { width: 100%; height: 520px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    html,body{height:100%;}
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <header class="bg-white shadow p-4">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <h1 class="text-lg font-semibold">Roteiro & Gastos (Mapa Corrigido)</h1>
      <a href="index.html" class="text-sm text-sky-600">← Voltar</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <section class="lg:col-span-2 bg-white rounded-2xl shadow p-4">
      <div id="map"></div>
      <div class="mt-3 flex gap-2">
        <input id="place-input" class="flex-1 rounded-md border px-3 py-2" placeholder="Buscar lugar (ex: Praia do Rosa)">
        <button id="add-marker" class="px-4 py-2 rounded-md bg-sky-600 text-white">Adicionar</button>
        <button id="calc-route" class="px-4 py-2 rounded-md bg-indigo-600 text-white">Calcular Rota</button>
      </div>
      <div class="mt-3 text-sm text-gray-500">Toque no mapa para marcar local. Arraste os itens na lista para reordenar.</div>
    </section>

    <aside class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-medium mb-2">Locais salvos</h2>
      <div class="mb-3">
        <button id="add-favorite" class="px-3 py-2 rounded-md border text-sm">Mostrar Favoritos</button>
        <button id="clear-all" class="px-3 py-2 rounded-md border text-sm float-right text-red-600">Limpar tudo</button>
      </div>
      <ul id="locais-list" class="space-y-2 max-h-[300px] overflow-auto"></ul>

      <h3 class="mt-4 font-medium">Gastos gerais</h3>
      <div class="mt-2">
        <form id="gasto-form" class="space-y-2">
          <select id="g-local" class="w-full rounded-md border px-3 py-2 text-sm"></select>
          <input id="g-desc" class="w-full rounded-md border px-3 py-2 text-sm" placeholder="Descrição">
          <input id="g-valor" type="number" step="0.01" class="w-full rounded-md border px-3 py-2 text-sm" placeholder="Valor (R$)">
          <div class="flex gap-2">
            <button type="submit" class="flex-1 px-3 py-2 rounded-md bg-emerald-600 text-white">Adicionar</button>
            <button id="export-gastos" type="button" class="px-3 py-2 rounded-md border">Exportar CSV</button>
          </div>
        </form>
      </div>

      <ul id="lista-gastos" class="mt-4 space-y-2 text-sm"></ul>
      <div class="text-xs text-gray-400 mt-4">Total: <span id="total">R$ 0,00</span></div>
      <div class="text-xs text-gray-400 mt-2">Transporte (ida/volta) estimado: <span id="transport-total">R$ 0,00</span></div>
    </aside>
  </main>

  <!-- Inline script (non-module) so initMap is global for the callback -->
  <script>
    // Basic map init and small logic to ensure map is visible
    var map;
    var markers = [];
    function initMap() { 
      // set a sensible default center and zoom (Brazil)
      var center = { lat: -14.235004, lng: -51.92528 };
      map = new google.maps.Map(document.getElementById('map'), { zoom: 5, center: center });

      // Add a temporary marker to show it's working
      var temp = new google.maps.Marker({ position: center, map: map, title: 'Início' });
      markers.push(temp);

      // Click to add a marker (quick test)
      map.addListener('click', function(e) { 
        var name = prompt('Nome para esse local:', 'Ponto de interesse') || 'Ponto';
        var pos = e.latLng;
        var m = new google.maps.Marker({ position: pos, map: map, title: name });
        markers.push(m);
      });

      // Wire up autocomplete after maps loaded
      var input = document.getElementById('place-input');
      var autocomplete = new google.maps.places.Autocomplete(input);
    }

    // small guard: if API fails to load, show an error after 6s
    setTimeout(function(){ if(!window.google || !window.google.maps){ alert('Erro: Google Maps não carregou. Verifique a chave e as APIs habilitadas.'); } }, 6000);
  </script>

  <!-- Load Google Maps with callback=initMap (global function) -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPkjcgFgdopkeZN0GnvhOc787jrajJnWc&libraries=places&callback=initMap"></script>

</body>
</html>
