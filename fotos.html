<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Fotos — Viagem Romântica</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/ffmpeg.js@1.1.0/dist/ffmpeg.min.js"></script>
</head>
<body class="bg-pink-50">
  <div class="fixed top-0 left-0 right-0 bg-white shadow-md z-10 p-4">
    <div class="flex justify-between items-center max-w-3xl mx-auto">
      <h1 class="text-xl font-bold text-pink-600">Memórias Românticas</h1>
      <nav class="flex gap-3">
        <a href="roteiro.html" class="text-pink-500">Roteiro</a>
        <a href="index.html" class="text-gray-500">Sair</a>
      </nav>
    </div>
  </div>

  <main class="pt-20 pb-24 px-4 max-w-3xl mx-auto">
    <!-- Upload de Fotos -->
    <div class="card bg-white p-4 mb-6">
      <h2 class="text-lg font-bold text-pink-600 mb-3">Adicionar Fotos</h2>
      
      <div class="flex flex-col gap-3">
        <input type="file" id="file-input" accept="image/*" multiple class="hidden">
        <button id="upload-btn" class="bg-pink-600 text-white py-3 rounded-lg">
          Selecionar Fotos
        </button>
        
        <button id="camera-btn" class="border border-pink-500 text-pink-600 py-3 rounded-lg">
          Tirar Foto com Câmera
        </button>
      </div>
    </div>
    
    <!-- Galeria -->
    <div class="card bg-white p-4 mb-6">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-bold text-pink-600">Suas Fotos</h2>
        <button id="clear-photos" class="text-red-500 text-sm">Limpar Tudo</button>
      </div>
      
      <div id="gallery" class="grid grid-cols-3 gap-2"></div>
    </div>
    
    <!-- Criação de Vídeo -->
    <div class="card bg-white p-4">
      <h2 class="text-lg font-bold text-pink-600 mb-3">Criar Vídeo Romântico</h2>
      
      <div class="grid grid-cols-2 gap-3 mb-4">
        <button id="btn-tumblr" class="bg-pink-100 text-pink-600 p-3 rounded-lg border border-pink-200">
          Estilo Tumblr
        </button>
        <button id="btn-casal" class="bg-pink-100 text-pink-600 p-3 rounded-lg border border-pink-200">
          Vídeo de Casal
        </button>
      </div>
      
      <div id="video-result" class="hidden">
        <video controls class="w-full rounded-lg mb-3"></video>
        <button id="download-video" class="w-full bg-pink-600 text-white py-2 rounded-lg">
          Baixar Vídeo
        </button>
      </div>
      
      <div id="progress" class="hidden mt-3">
        <p class="text-center text-sm text-pink-600">Processando vídeo...</p>
        <div class="w-full bg-pink-100 rounded-full h-2">
          <div id="progress-bar" class="bg-pink-600 h-2 rounded-full" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Elementos da UI
    const fileInput = document.getElementById('file-input');
    const uploadBtn = document.getElementById('upload-btn');
    const cameraBtn = document.getElementById('camera-btn');
    const gallery = document.getElementById('gallery');
    const videoResult = document.getElementById('video-result');
    const videoElement = videoResult.querySelector('video');
    const progress = document.getElementById('progress');
    const progressBar = document.getElementById('progress-bar');
    
    // Fotos do usuário
    let photos = JSON.parse(localStorage.getItem('viagem_photos')) || [];
    
    // Inicializar FFmpeg
    const ffmpeg = createFFmpeg({ log: true });
    let ffmpegLoaded = false;
    
    // Carregar FFmpeg
    async function loadFFmpeg() {
      if (!ffmpegLoaded) {
        await ffmpeg.load();
        ffmpegLoaded = true;
      }
    }
    
    // Renderizar galeria
    function renderGallery() {
      gallery.innerHTML = photos.map((photo, index) => `
        <div class="relative aspect-square">
          <img src="${photo.url}" class="w-full h-full object-cover rounded-lg">
          <button data-index="${index}" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">
            ×
          </button>
        </div>
      `).join('');
      
      localStorage.setItem('viagem_photos', JSON.stringify(photos));
    }
    
    // Adicionar foto
    function addPhoto(url) {
      photos.push({
        url,
        date: new Date().toISOString()
      });
      renderGallery();
    }
    
    // Event Listeners
    uploadBtn.addEventListener('click', () => fileInput.click());
    
    fileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;
      
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (event) => addPhoto(event.target.result);
        reader.readAsDataURL(file);
      });
      
      fileInput.value = '';
    });
    
    cameraBtn.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        
        // Criar interface da câmera
        const cameraUI = document.createElement('div');
        cameraUI.className = 'fixed inset-0 bg-black z-50 flex flex-col';
        cameraUI.innerHTML = `
          <video id="camera-preview" autoplay class="flex-1"></video>
          <div class="bg-white p-4 flex justify-center gap-4">
            <button id="take-photo" class="bg-pink-600 text-white p-3 rounded-full">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
              </svg>
            </button>
            <button id="close-camera" class="bg-gray-200 p-3 rounded-full">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        `;
        
        document.body.appendChild(cameraUI);
        const preview = document.getElementById('camera-preview');
        preview.srcObject = stream;
        
        document.getElementById('take-photo').addEventListener('click', () => {
          const canvas = document.createElement('canvas');
          canvas.width = preview.videoWidth;
          canvas.height = preview.videoHeight;
          canvas.getContext('2d').drawImage(preview, 0, 0);
          
          addPhoto(canvas.toDataURL('image/jpeg'));
          closeCamera();
        });
        
        document.getElementById('close-camera').addEventListener('click', closeCamera);
        
        function closeCamera() {
          stream.getTracks().forEach(track => track.stop());
          cameraUI.remove();
        }
      } catch (error) {
        alert('Não foi possível acessar a câmera: ' + error.message);
      }
    });
    
    // Remover foto
    gallery.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      
      const index = btn.dataset.index;
      photos.splice(index, 1);
      renderGallery();
    });
    
    // Limpar fotos
    document.getElementById('clear-photos').addEventListener('click', () => {
      if (photos.length > 0 && confirm('Limpar todas as fotos?')) {
        photos = [];
        renderGallery();
      }
    });
    
    // Criar vídeo estilo Tumblr
    document.getElementById('btn-tumblr').addEventListener('click', async () => {
      if (photos.length < 3) return alert('Adicione pelo menos 3 fotos');
      await createVideo('tumblr');
    });
    
    // Criar vídeo de casal
    document.getElementById('btn-casal').addEventListener('click', async () => {
      if (photos.length < 3) return alert('Adicione pelo menos 3 fotos');
      await createVideo('casal');
    });
    
    // Baixar vídeo
    document.getElementById('download-video').addEventListener('click', () => {
      const a = document.createElement('a');
      a.href = videoElement.src;
      a.download = `viagem-romantica-${new Date().toISOString().slice(0,10)}.mp4`;
      a.click();
    });
    
    // Criar vídeo com FFmpeg
    async function createVideo(style) {
      try {
        videoResult.classList.add('hidden');
        progress.classList.remove('hidden');
        progressBar.style.width = '0%';
        
        await loadFFmpeg();
        
        // Configurações baseadas no estilo
        const config = {
          tumblr: { duration: 3, transition: 'fade', filter: 'vignette' },
          casal: { duration: 4, transition: 'slide', filter: 'warm' }
        }[style];
        
        // Processar cada foto
        let ffmpegCommand = '';
        const inputFiles = [];
        
        for (let i = 0; i < photos.length; i++) {
          const photo = photos[i];
          const filename = `input${i}.jpg`;
          
          // Converter data URL para blob
          const blob = await fetch(photo.url).then(r => r.blob());
          const arrayBuffer = await blob.arrayBuffer();
          const uint8Array = new Uint8Array(arrayBuffer);
          
          ffmpeg.FS('writeFile', filename, uint8Array);
          inputFiles.push(filename);
          
          // Adicionar efeitos baseados no estilo
          let filter = '';
          if (config.filter === 'vignette') {
            filter = ', vignette=angle=45:strength=0.5';
          } else if (config.filter === 'warm') {
            filter = ', colorbalance=rs=0.3:gs=-0.1:bs=-0.2';
          }
          
          ffmpegCommand += `
            -i ${filename} -vf "scale=w=720:h=720:force_original_aspect_ratio=1${filter}" ${filename}_scaled.mp4;
            -loop 1 -t ${config.duration} -i ${filename}_scaled.mp4
          `;
          
          progressBar.style.width = `${(i / photos.length) * 50}%`;
        }
        
        // Criar transições
        let filterComplex = '';
        for (let i = 0; i < photos.length - 1; i++) {
          if (config.transition === 'fade') {
            filterComplex += `[v${i}][v${i+1}]blend=all_expr='A*(1-T/${config.duration})+B*(T/${config.duration})'[b${i}];`;
          } else {
            filterComplex += `[v${i}][v${i+1}]slide=transition=${config.transition}:duration=1:offset=${config.duration-1}[b${i}];`;
          }
        }
        
        // Comando FFmpeg final
        const outputFilename = 'output.mp4';
        const fullCommand = `
          ${ffmpegCommand}
          -filter_complex "${filterComplex}"
          -map "[b${photos.length-2}]" -c:v libx264 -pix_fmt yuv420p ${outputFilename}
        `;
        
        // Executar FFmpeg
        await ffmpeg.run(fullCommand);
        
        // Obter resultado
        const data = ffmpeg.FS('readFile', outputFilename);
        const videoUrl = URL.createObjectURL(
          new Blob([data.buffer], { type: 'video/mp4' })
        );
        
        // Mostrar resultado
        videoElement.src = videoUrl;
        videoResult.classList.remove('hidden');
        progress.classList.add('hidden');
        
      } catch (error) {
        console.error('Erro ao criar vídeo:', error);
        alert('Erro ao criar vídeo. Tente novamente.');
        progress.classList.add('hidden');
      }
    }
    
    // Inicializar
    renderGallery();
  </script>
</body>
</html>