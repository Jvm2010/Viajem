<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Galeria de Fotos ‚Äî Viagem Planner Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="firebase.js"></script>
  <script type="module" src="ia_helper.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- Verifica√ß√£o de autentica√ß√£o -->
  <script>
    (function(){
      try {
        const auth = sessionStorage.getItem('viagem:auth');
        if(auth !== '1' && auth !== '0') window.location.href = 'index.html';
      } catch(e) { console.error(e); }
    })();
  </script>

  <header class="bg-white shadow p-4 sticky top-0 z-10">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <h1 class="text-lg font-semibold">Galeria de Fotos</h1>
      <nav class="text-sm space-x-4">
        <a href="index.html" class="text-sky-600">Sair</a>
        <a href="roteiro.html" class="text-sky-600">Roteiro</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 space-y-6">
    <section class="card">
      <h2 class="font-semibold text-lg">Upload de Fotos</h2>
      
      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
          <input type="file" id="file-upload" accept="image/*" multiple class="hidden">
          <button id="upload-btn" class="badge mb-2">Selecionar Fotos</button>
          <p class="small text-gray-500">Ou arraste e solte fotos aqui</p>
        </div>
        
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
          <button id="camera-btn" class="badge mb-2">Tirar Foto</button>
          <p class="small text-gray-500">Use a c√¢mera do seu dispositivo</p>
        </div>
      </div>
    </section>
    
    <section class="card">
      <h2 class="font-semibold text-lg">Suas Fotos</h2>
      <div class="mt-3 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3" id="gallery"></div>
    </section>
    
    <section class="card" id="ia-section">
      <h2 class="font-semibold text-lg">Cria√ß√£o Autom√°tica com IA</h2>
      <p class="small mt-1">Selecione fotos e crie v√≠deos incr√≠veis automaticamente</p>
      
      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="ia-option" data-style="romantic">
          <div class="bg-pink-100 rounded-lg p-4 h-full">
            <div class="bg-pink-200 h-32 rounded-lg flex items-center justify-center">
              <span class="text-pink-500 text-4xl">‚ù§Ô∏è</span>
            </div>
            <h4 class="mt-3 font-medium">Rom√¢ntico</h4>
            <p class="small mt-1 text-gray-600">Transi√ß√µes suaves, filtros quentes</p>
            <button class="badge mt-3 w-full">Criar V√≠deo</button>
          </div>
        </div>
        
        <div class="ia-option" data-style="adventure">
          <div class="bg-green-100 rounded-lg p-4 h-full">
            <div class="bg-green-200 h-32 rounded-lg flex items-center justify-center">
              <span class="text-green-500 text-4xl">üèîÔ∏è</span>
            </div>
            <h4 class="mt-3 font-medium">Aventura</h4>
            <p class="small mt-1 text-gray-600">Cortes din√¢micos, m√∫sica animada</p>
            <button class="badge mt-3 w-full">Criar V√≠deo</button>
          </div>
        </div>
        
        <div class="ia-option" data-style="cinematic">
          <div class="bg-blue-100 rounded-lg p-4 h-full">
            <div class="bg-blue-200 h-32 rounded-lg flex items-center justify-center">
              <span class="text-blue-500 text-4xl">üé¨</span>
            </div>
            <h4 class="mt-3 font-medium">Cinem√°tico</h4>
            <p class="small mt-1 text-gray-600">Efeito filme, barras laterais</p>
            <button class="badge mt-3 w-full">Criar V√≠deo</button>
          </div>
        </div>
      </div>
      
      <div id="ia-result" class="mt-6 hidden">
        <div class="flex justify-between items-center">
          <h4 class="font-semibold">Seu v√≠deo est√° pronto!</h4>
          <button id="download-video" class="badge">Baixar V√≠deo</button>
        </div>
        <video controls class="w-full mt-3 rounded-lg bg-black"></video>
        <div class="mt-3 flex gap-2">
          <button id="save-video" class="badge">Salvar na Galeria</button>
          <button id="new-video" class="text-sm text-sky-600">Criar outro</button>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import { VideoCreator } from './ia_helper.js';
    import { uploadImage, getImageUrl, saveVideo } from './db_api.js';
    
    const gallery = document.getElementById('gallery');
    const fileUpload = document.getElementById('file-upload');
    const uploadBtn = document.getElementById('upload-btn');
    const cameraBtn = document.getElementById('camera-btn');
    const videoResult = document.querySelector('#ia-result video');
    const videoCreator = new VideoCreator();
    
    let selectedPhotos = [];
    let currentUserPhotos = [];
    
    // Carregar fotos do usu√°rio
    async function loadUserPhotos() {
      // Simula√ß√£o - na pr√°tica buscaria do Firebase
      currentUserPhotos = JSON.parse(localStorage.getItem('user_photos') || [];
      renderGallery();
    }
    
    // Renderizar galeria
    function renderGallery() {
      gallery.innerHTML = currentUserPhotos.map((photo, index) => `
        <div class="relative group">
          <img src="${photo.url}" class="w-full h-32 object-cover rounded-lg">
          <div class="absolute inset-0 bg-black bg-opacity-50 rounded-lg opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
            <button data-index="${index}" class="select-btn ${photo.selected ? 'bg-blue-500' : 'bg-white'} text-xs p-1 rounded">
              ${photo.selected ? '‚úì Selecionada' : 'Selecionar'}
            </button>
          </div>
        </div>
      `).join('');
    }
    
    // Upload de fotos
    uploadBtn.addEventListener('click', () => fileUpload.click());
    
    fileUpload.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;
      
      for (const file of files) {
        try {
          const url = await uploadImage(file);
          currentUserPhotos.push({ url, selected: false });
        } catch (error) {
          console.error('Erro no upload:', error);
        }
      }
      
      savePhotos();
      renderGallery();
    });
    
    // Tirar foto
    cameraBtn.addEventListener('click', async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      
      // Criar interface para tirar foto
      const cameraModal = document.createElement('div');
      cameraModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center z-50';
      cameraModal.innerHTML = `
        <div class="bg-white rounded-lg p-4 max-w-md w-full">
          <h3 class="font-semibold mb-2">Tirar Foto</h3>
          <video id="camera-preview" class="w-full bg-black rounded" autoplay></video>
          <div class="mt-3 flex justify-center gap-3">
            <button id="capture-btn" class="badge">Capturar</button>
            <button id="cancel-camera" class="text-sm text-gray-600">Cancelar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(cameraModal);
      const preview = document.getElementById('camera-preview');
      preview.srcObject = stream;
      
      document.getElementById('capture-btn').addEventListener('click', async () => {
        const canvas = document.createElement('canvas');
        canvas.width = preview.videoWidth;
        canvas.height = preview.videoHeight;
        canvas.getContext('2d').drawImage(preview, 0, 0);
        
        const photoUrl = canvas.toDataURL('image/jpeg');
        currentUserPhotos.push({ url: photoUrl, selected: false });
        savePhotos();
        renderGallery();
        
        stream.getTracks().forEach(track => track.stop());
        cameraModal.remove();
      });
      
      document.getElementById('cancel-camera').addEventListener('click', () => {
        stream.getTracks().forEach(track => track.stop());
        cameraModal.remove();
      });
    });
    
    // Selecionar fotos para v√≠deo
    gallery.addEventListener('click', (e) => {
      const selectBtn = e.target.closest('.select-btn');
      if (!selectBtn) return;
      
      const index = selectBtn.dataset.index;
      currentUserPhotos[index].selected = !currentUserPhotos[index].selected;
      savePhotos();
      renderGallery();
    });
    
    // Criar v√≠deos com IA
    document.querySelectorAll('.ia-option').forEach(option => {
      option.addEventListener('click', async () => {
        const style = option.dataset.style;
        selectedPhotos = currentUserPhotos.filter(p => p.selected);
        
        if (selectedPhotos.length < 3) {
          alert('Selecione pelo menos 3 fotos para criar um v√≠deo');
          return;
        }
        
        // Mostrar loading
        option.querySelector('button').textContent = 'Processando...';
        
        try {
          const video = await videoCreator.createVideo(
            selectedPhotos.map(p => p.url),
            style
          );
          
          videoResult.src = video.url;
          document.getElementById('ia-result').classList.remove('hidden');
        } catch (error) {
          console.error('Erro ao criar v√≠deo:', error);
          alert('Erro ao criar v√≠deo. Tente novamente.');
        }
        
        option.querySelector('button').textContent = 'Criar V√≠deo';
      });
    });
    
    // Salvar v√≠deo
    document.getElementById('save-video').addEventListener('click', async () => {
      try {
        await saveVideo(videoResult.src);
        alert('V√≠deo salvo na galeria!');
      } catch (error) {
        console.error('Erro ao salvar v√≠deo:', error);
        alert('Erro ao salvar v√≠deo.');
      }
    });
    
    // Baixar v√≠deo
    document.getElementById('download-video').addEventListener('click', () => {
      const a = document.createElement('a');
      a.href = videoResult.src;
      a.download = `viagem-${new Date().toISOString().slice(0,10)}.mp4`;
      a.click();
    });
    
    // Novo v√≠deo
    document.getElementById('new-video').addEventListener('click', () => {
      document.getElementById('ia-result').classList.add('hidden');
    });
    
    // Salvar fotos no localStorage (simula√ß√£o)
    function savePhotos() {
      localStorage.setItem('user_photos', JSON.stringify(currentUserPhotos));
    }
    
    // Inicializar
    loadUserPhotos();
  </script>
</body>
</html>