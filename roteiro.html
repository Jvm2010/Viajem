<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roteiro de Viagem (GPS avançado)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Roboto',sans-serif; }
    #map { height: 420px; width: 100%; border-radius: 12px; }
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 10px 16px; border-radius: 8px; color: #fff; background:#0ea5e9; z-index:2000; }
    .toast.error { background:#dc2626; }
    .badge { padding:4px 8px; border-radius:9999px; font-size:12px; font-weight:600; }
    .poi-result { cursor: pointer; }
    .marker-label { color: white; font-weight:700; font-size:12px; }
  </style>
</head>
<body class="bg-gray-50">
<header class="bg-white shadow sticky top-0 z-40">
  <div class="container mx-auto px-4 py-3 flex justify-between items-center">
    <h1 class="text-xl font-bold text-sky-700">Roteiro de Viagem — GPS avançado</h1>
    <div class="text-sm text-gray-600">Teste local — substitua a chave do Google</div>
  </div>
</header>

<main class="container mx-auto px-4 py-6 max-w-6xl grid grid-cols-1 lg:grid-cols-3 gap-6">
  <section class="lg:col-span-2 space-y-4">
    <div class="bg-white p-4 rounded shadow">
      <div class="flex gap-3 items-center">
        <button id="start-trip" class="px-4 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">Iniciar Viagem</button>
        <button id="optimize-route" class="px-4 py-2 rounded bg-sky-100 text-sky-700">Otimizar Rota</button>
        <button id="clear-route" class="px-4 py-2 rounded border text-red-600">Limpar Tudo</button>
        <div class="ml-auto flex items-center gap-3">
          <label class="text-sm text-gray-600">Consumo (km/l)</label>
          <input id="fuel-efficiency" type="number" value="10" min="1" class="w-20 p-2 border rounded" />
          <label class="text-sm text-gray-600">Preço (R$/l)</label>
          <input id="fuel-price" type="number" value="5.50" step="0.01" min="0.1" class="w-24 p-2 border rounded" />
        </div>
      </div>

      <div id="map" class="mt-4"></div>

      <div class="mt-3 flex gap-2">
        <button data-poi="gas_station" class="poi-button px-3 py-2 bg-yellow-100 rounded">Postos</button>
        <button data-poi="restaurant" class="poi-button px-3 py-2 bg-rose-100 rounded">Restaurantes</button>
        <button data-poi="lodging" class="poi-button px-3 py-2 bg-blue-100 rounded">Hotéis / Motéis / Hostels</button>
        <button data-poi="tourist_attraction" class="poi-button px-3 py-2 bg-green-100 rounded">Pontos Turísticos</button>
        <button id="clear-poi-results" class="ml-auto px-3 py-2 border rounded text-sm">Limpar POIs</button>
      </div>

      <div id="poi-results" class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-2"></div>
    </div>

    <div class="bg-white p-4 rounded shadow">
      <h3 class="font-semibold mb-3">Adicionar Local Manualmente</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <input id="search" placeholder="Pesquisar local..." class="p-2 border rounded" />
        <button id="btn-search" class="px-4 py-2 bg-sky-600 text-white rounded">Pesquisar</button>

        <input id="place-name" placeholder="Nome do local" class="p-2 border rounded" />
        <input id="place-value" type="number" placeholder="Custo (R$)" class="p-2 border rounded" />

        <select id="place-category" class="p-2 border rounded">
          <option value="attraction">Atração</option>
          <option value="park">Parque</option>
          <option value="hotel">Hotel</option>
          <option value="restaurant">Restaurante</option>
          <option value="shopping">Compras</option>
          <option value="other">Outro</option>
        </select>

        <button id="add-place" class="px-4 py-2 bg-sky-600 text-white rounded">Adicionar Local</button>
      </div>
    </div>

    <div class="bg-white p-4 rounded shadow">
      <h3 class="font-semibold mb-3">Resumo da Rota</h3>
      <div id="route-details" class="space-y-2"></div>
      <div class="mt-3 grid grid-cols-3 gap-2">
        <div class="p-3 bg-sky-50 rounded">
          <div class="text-sm text-gray-500">Distância</div>
          <div id="total-distance" class="font-bold">0 km</div>
        </div>
        <div class="p-3 bg-sky-50 rounded">
          <div class="text-sm text-gray-500">Tempo</div>
          <div id="total-time" class="font-bold">0 min</div>
        </div>
        <div class="p-3 bg-sky-50 rounded">
          <div class="text-sm text-gray-500">Custo Combustível</div>
          <div id="fuel-cost" class="font-bold">R$ 0,00</div>
        </div>
      </div>
    </div>
  </section>

  <aside class="space-y-4">
    <div class="bg-white p-4 rounded shadow">
      <h4 class="font-semibold mb-2">Locais Salvos</h4>
      <div id="places-list" class="space-y-2 max-h-[420px] overflow-auto"></div>
    </div>

    <div class="bg-white p-4 rounded shadow">
      <h4 class="font-semibold mb-2">Gastos Gerais</h4>
      <div id="expenses-list" class="space-y-2"></div>
      <div class="mt-3">
        <input id="expense-title" placeholder="Descrição" class="w-full p-2 border rounded mb-2" />
        <input id="expense-amount" type="number" placeholder="Valor" class="w-full p-2 border rounded mb-2" />
        <button id="add-expense" class="w-full bg-sky-600 text-white p-2 rounded">Adicionar Gasto</button>
      </div>
    </div>
  </aside>
</main>

<div id="toast-root"></div>

<script>
/*
  Versão avançada:
  - Use YOUR_API_KEY_HERE (substitua)
  - Recursos:
    * start-trip agora usa a posição atual (origem) e salva snapshot original
    * "avoid" toggle para marcar locais que não devem entrar na rota
    * busca de POIs próximos e adicionar como próxima parada
    * remoção com opção de restaurar rota original
*/

let map, directionsService, directionsRenderer, infoWindow, autocomplete;
let markers = [];
let places = []; // todos os locais salvos (inclui 'avoid' flag)
let generalExpenses = [];
let lastRouteResult = null;
let originalPlacesSnapshot = null; // snapshot da rota antes de iniciar jornada
let watchId = null;
let currentPositionMarker = null;
let pathPolyline = null;
let pathCoordinates = [];

const ICONS = {
  origin: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
  waypoint: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
  avoid: 'https://maps.google.com/mapfiles/ms/icons/gray-dot.png',
  poi: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png',
  current: 'https://maps.google.com/mapfiles/ms/icons/ltblue-dot.png'
};

const categoryStyles = {
  attraction: { name: 'Atração', color: '#ef4444' },
  park: { name: 'Parque', color: '#10b981' },
  hotel: { name: 'Hotel', color: '#3b82f6' },
  restaurant: { name: 'Restaurante', color: '#f97316' },
  shopping: { name: 'Compras', color: '#8b5cf6' },
  other: { name: 'Outro', color: '#6b7280' }
};

function formatCurrency(v){ return v.toLocaleString('pt-BR', {style:'currency',currency:'BRL'}); }
function showToast(msg, isError=false){
  const t = document.createElement('div');
  t.className = 'toast' + (isError ? ' error': '');
  t.textContent = msg;
  document.getElementById('toast-root').appendChild(t);
  setTimeout(()=> t.remove(), 3000);
}

// ========== Inicialização do mapa ==========
function initMap(){
  const initial = { lat: -15.795, lng: -47.891 };
  map = new google.maps.Map(document.getElementById('map'), { center: initial, zoom: 12, mapTypeControl:true, streetViewControl:false });
  infoWindow = new google.maps.InfoWindow();
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers:true, map, polylineOptions:{ strokeColor:'#0ea5e9', strokeWeight:5 } });

  // autocomplete para pesquisa simples
  autocomplete = new google.maps.places.Autocomplete(document.getElementById('search'), { types:['establishment','geocode'], fields:['name','geometry','formatted_address','types'] });
  autocomplete.addListener('place_changed', onAutocompletePlace);

  // carregar dados
  loadData();
  setupEventListeners();
  renderPlaces();
  renderExpenses();
  updateRoute();

  showToast('Mapa inicializado');
}

function onAutocompletePlace(){
  const place = autocomplete.getPlace();
  if (!place || !place.geometry) { showToast('Local não encontrado', true); return; }
  map.setCenter(place.geometry.location);
  map.setZoom(15);
  document.getElementById('place-name').value = place.name || '';
  document.getElementById('search').value = place.formatted_address || place.name || '';
}

// ========== Persistência ==========
function loadData(){
  try {
    const ps = localStorage.getItem('travel_places');
    const ex = localStorage.getItem('travel_expenses');
    if (ps) places = JSON.parse(ps);
    if (ex) generalExpenses = JSON.parse(ex);
  } catch(e) { console.warn('localStorage parse error',e); places=[]; generalExpenses=[]; }
}
function saveData(){ try{ localStorage.setItem('travel_places', JSON.stringify(places)); localStorage.setItem('travel_expenses', JSON.stringify(generalExpenses)); }catch(e){console.warn(e);} }

// ========== Marcadores e rota ==========
function clearMarkers(){ markers.forEach(m=>m.setMap(null)); markers=[]; }
function addMarker(latlng, iconUrl, labelText, title){
  const marker = new google.maps.Marker({ position: latlng, map, icon:{ url: iconUrl, scaledSize: new google.maps.Size(36,36) }, title });
  if (labelText) {
    // label with text using marker's setLabel for simple numbering
    marker.setLabel({ text: String(labelText), color:'white', fontWeight:'700' });
  }
  markers.push(marker);
  return marker;
}

function updateRoute(){
  // limpa marcadores
  clearMarkers();

  // Filtra apenas os locais que não estão marcados como 'avoid'
  const routePlaces = (places || []).filter(p => !p.avoid);

  if (!routePlaces.length){
    directionsRenderer.setMap(null);
    document.getElementById('route-details').innerHTML = '<div class="text-gray-500">Sem rota</div>';
    lastRouteResult = null;
    updateStats();
    return;
  }

  // criar marcadores para todos os lugares (visuais)
  places.forEach((p, idx) => {
    const latlng = { lat: p.lat, lng: p.lng };
    const icon = p.avoid ? ICONS.avoid : ICONS.waypoint;
    const m = addMarker(latlng, icon, p.avoid ? '' : (idx+1), p.name);
    m.addListener('click', ()=> {
      infoWindow.setContent(`<div style="max-width:220px"><strong>${p.name}</strong><div style="color:${categoryStyles[p.category]?.color||'#6b7280'};font-weight:600">${categoryStyles[p.category]?.name||'Local'}</div><div style="font-size:12px">${p.address||''}</div></div>`);
      infoWindow.open(map,m);
    });
  });

  if (routePlaces.length === 1){
    // centraliza apenas no ponto
    map.setCenter({ lat: routePlaces[0].lat, lng: routePlaces[0].lng });
    map.setZoom(14);
    directionsRenderer.setMap(null);
    lastRouteResult = null;
    renderRouteDetails(null);
    updateStats();
    return;
  }

  // se 2+ pontos: calcular rota usando places (origin=current location if tracking started else first place)
  // se estamos trackeando (currentPositionMarker existe), considerar current position como origin (facilitar)
  let origin;
  if (currentPositionMarker) {
    origin = currentPositionMarker.getPosition();
  } else {
    origin = new google.maps.LatLng(routePlaces[0].lat, routePlaces[0].lng);
  }

  const destination = new google.maps.LatLng(routePlaces[routePlaces.length - 1].lat, routePlaces[routePlaces.length - 1].lng);
  const waypoints = routePlaces.slice(currentPositionMarker ? 0 : 1, routePlaces.length - 1).map(p => ({ location:{ lat:p.lat, lng:p.lng }, stopover:true }));

  const req = {
    origin,
    destination,
    waypoints,
    travelMode: google.maps.TravelMode.DRIVING,
    optimizeWaypoints: true,
    provideRouteAlternatives: false
  };

  directionsService.route(req, (res, status) => {
    if (status === 'OK') {
      directionsRenderer.setMap(map);
      directionsRenderer.setDirections(res);
      lastRouteResult = res;
      renderRouteDetails(res);
      updateStats();
      // ajustar bounds
      try {
        const bounds = new google.maps.LatLngBounds();
        res.routes[0].legs.forEach(leg => { bounds.extend(leg.start_location); bounds.extend(leg.end_location); });
        map.fitBounds(bounds);
      } catch(e){ console.warn(e); }
    } else {
      showToast('Erro ao calcular rota: ' + status, true);
      lastRouteResult = null;
      renderRouteDetails(null);
      updateStats();
    }
  });
}

// render detalhes
function renderRouteDetails(routeResult){
  const container = document.getElementById('route-details');
  container.innerHTML = '';
  if (!routeResult || !routeResult.routes || !routeResult.routes[0]) { container.innerHTML = '<div class="text-gray-500">Sem detalhes da rota</div>'; return; }
  routeResult.routes[0].legs.forEach((leg, i) => {
    const from = leg.start_address || `Ponto ${i+1}`;
    const to = leg.end_address || `Ponto ${i+2}`;
    const div = document.createElement('div');
    div.className = 'p-2 bg-gray-50 rounded';
    div.innerHTML = `<div class="flex justify-between"><div><strong>${from}</strong><div class="text-sm text-gray-500">${leg.distance.text} • ${leg.duration.text}</div></div><div class="text-sky-700 font-semibold">${leg.duration.text}</div></div>`;
    container.appendChild(div);
  });
}

// ========== Estatísticas ==========
function updateStats(){
  const placesCost = (places||[]).reduce((s,p)=>s+(parseFloat(p.value)||0),0);
  const expensesCost = (generalExpenses||[]).reduce((s,e)=>s+(parseFloat(e.amount)||0),0);
  document.getElementById('places-cost')?.remove?.(); // backward safe (not all UIs have this)
  document.getElementById('places-cost')?.textContent = formatCurrency(placesCost);

  let totalDistance=0, totalTime=0;
  if (lastRouteResult && lastRouteResult.routes && lastRouteResult.routes[0]) {
    lastRouteResult.routes[0].legs.forEach(l => { totalDistance += (l.distance?.value||0); totalTime += (l.duration?.value||0); });
  }
  document.getElementById('total-distance').textContent = `${(totalDistance/1000).toFixed(1)} km`;
  const hours = Math.floor(totalTime/3600), minutes = Math.round((totalTime%3600)/60);
  document.getElementById('total-time').textContent = (hours>0? hours + ' h ' : '') + minutes + ' min';

  const fuelEfficiency = parseFloat(document.getElementById('fuel-efficiency').value) || 10;
  const fuelPrice = parseFloat(document.getElementById('fuel-price').value) || 5.5;
  const fuelConsumption = (totalDistance/1000)/fuelEfficiency;
  const fuelCost = fuelConsumption * fuelPrice;
  document.getElementById('fuel-cost').textContent = formatCurrency(fuelCost || 0);

  // atualizar route-details (já feito em updateRoute)
}

// ========== UI: Locais e Despesas ==========
function renderPlaces(){
  const container = document.getElementById('places-list');
  container.innerHTML = '';
  if (!places || places.length===0){ container.innerHTML = '<div class="text-gray-500">Nenhum local salvo</div>'; return; }
  places.forEach((p, idx) => {
    const cat = categoryStyles[p.category]?.name || 'Local';
    const color = categoryStyles[p.category]?.color || '#6b7280';
    const div = document.createElement('div');
    div.className = 'p-2 border rounded flex justify-between items-center';
    div.innerHTML = `
      <div>
        <div class="font-semibold">${p.name} ${p.avoid ? '<span class="text-xs px-2 ml-2 bg-gray-200 rounded">Evitado</span>':''}</div>
        <div class="text-xs text-gray-500">${p.address||''}</div>
        <div class="text-xs" style="color:${color}">${cat} • ${p.value? formatCurrency(p.value):'R$ 0,00'}</div>
      </div>
      <div class="flex flex-col items-end gap-1">
        <div class="flex gap-1">
          <button data-index="${idx}" class="set-next px-2 py-1 text-xs bg-emerald-100 rounded">Próxima</button>
          <button data-index="${idx}" class="toggle-avoid px-2 py-1 text-xs bg-gray-100 rounded">${p.avoid ? 'Desmarcar evitar' : 'Evitar'}</button>
        </div>
        <div class="flex gap-1 mt-1">
          <button data-index="${idx}" class="delete-place text-xs px-2 py-1 bg-red-100 rounded">Remover</button>
        </div>
      </div>
    `;
    container.appendChild(div);
  });
}

function renderExpenses(){
  const container = document.getElementById('expenses-list');
  container.innerHTML = '';
  if (!generalExpenses || generalExpenses.length===0){ container.innerHTML = '<div class="text-gray-500">Nenhum gasto</div>'; return; }
  generalExpenses.forEach((e, idx) => {
    const div = document.createElement('div');
    div.className = 'flex justify-between items-center p-2 border rounded';
    div.innerHTML = `<div><div class="font-medium">${e.title}</div><div class="text-xs text-gray-500">${new Date(e.date).toLocaleDateString()}</div></div><div class="flex gap-2 items-center"><div>${formatCurrency(e.amount)}</div><button data-index="${idx}" class="delete-exp text-xs bg-red-100 px-2 py-1 rounded">Remover</button></div>`;
    container.appendChild(div);
  });
}

// ========== Eventos ==========
function setupEventListeners(){
  document.getElementById('add-place').addEventListener('click', () => {
    const name = document.getElementById('place-name').value.trim();
    const val = parseFloat(document.getElementById('place-value').value) || 0;
    const category = document.getElementById('place-category').value || 'other';
    const address = document.getElementById('search').value || '';
    if (!name){ showToast('Digite o nome do local', true); return; }
    const center = map.getCenter();
    const newPlace = { name, value: val, category, address, lat: center.lat(), lng: center.lng(), date: new Date().toISOString(), avoid:false };
    places.push(newPlace);
    saveData(); renderPlaces(); updateRoute(); showToast('Local adicionado');
    document.getElementById('place-name').value=''; document.getElementById('place-value').value=''; document.getElementById('search').value='';
  });

  document.getElementById('btn-search').addEventListener('click', () => {
    const q = document.getElementById('search').value.trim();
    if (!q){ showToast('Digite algo para pesquisar', true); return; }
    if (!google || !google.maps || !google.maps.places){ showToast('Places API indisponível', true); return; }
    const service = new google.maps.places.PlacesService(map);
    service.findPlaceFromQuery({ query: q, fields:['name','geometry','formatted_address','types'] }, (res,status) => {
      if (status === google.maps.places.PlacesServiceStatus.OK && res && res[0]) {
        const p = res[0];
        if (p.geometry && p.geometry.location) { map.setCenter(p.geometry.location); map.setZoom(15); }
        document.getElementById('place-name').value = p.name || '';
        document.getElementById('search').value = p.formatted_address || p.name || '';
        showToast('Local encontrado');
      } else showToast('Local não encontrado', true);
    });
  });

  // POI buttons
  document.querySelectorAll('.poi-button').forEach(btn => {
    btn.addEventListener('click', () => {
      const type = btn.dataset.poi;
      searchNearbyPOI(type);
    });
  });
  document.getElementById('clear-poi-results').addEventListener('click', () => { document.getElementById('poi-results').innerHTML=''; });

  // adicionar gasto
  document.getElementById('add-expense').addEventListener('click', () => {
    const title = document.getElementById('expense-title').value.trim();
    const amount = parseFloat(document.getElementById('expense-amount').value);
    if (!title || isNaN(amount)){ showToast('Preencha gasto corretamente', true); return; }
    generalExpenses.push({ title, amount, date: new Date().toISOString() });
    saveData(); renderExpenses(); showToast('Gasto adicionado'); document.getElementById('expense-title').value=''; document.getElementById('expense-amount').value='';
  });

  // delegação places list
  document.getElementById('places-list').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const idx = parseInt(btn.dataset.index);
    if (btn.classList.contains('delete-place')) {
      if (!confirm('Remover este local?')) return;
      // Se há snapshot original (iniciou viagem), oferece restaurar
      if (originalPlacesSnapshot) {
        if (confirm('Deseja restaurar a rota original (antes de iniciar a viagem)?')) {
          places = JSON.parse(originalPlacesSnapshot);
          originalPlacesSnapshot = null;
          saveData(); renderPlaces(); updateRoute(); showToast('Rota original restaurada');
          return;
        }
      }
      places.splice(idx,1); saveData(); renderPlaces(); updateRoute(); showToast('Local removido');
    } else if (btn.classList.contains('toggle-avoid')) {
      places[idx].avoid = !places[idx].avoid;
      saveData(); renderPlaces(); updateRoute();
      showToast(places[idx].avoid ? 'Local marcado como evitado' : 'Local desmarcado de evitar');
    } else if (btn.classList.contains('set-next')) {
      // torna este local como próxima parada (inserir logo após origem ou posição atual)
      const place = places[idx];
      // remove do array e insere depois do primeiro elemento (ou no índice 0 se tracking)
      places.splice(idx,1);
      if (currentPositionMarker) {
        // inserir como primeiro destino (origin = current location)
        places.unshift(place);
      } else {
        // inserir como segundo (após origin)
        places.splice(1,0,place);
      }
      saveData(); renderPlaces(); updateRoute(); showToast('Local definido como próxima parada');
    }
  });

  // delegação expenses
  document.getElementById('expenses-list').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const idx = parseInt(btn.dataset.index);
    if (btn.classList.contains('delete-exp')) {
      if (confirm('Remover gasto?')) { generalExpenses.splice(idx,1); saveData(); renderExpenses(); showToast('Gasto removido'); }
    }
  });

  // otimizar rota
  document.getElementById('optimize-route').addEventListener('click', () => {
    if ((places||[]).filter(p=>!p.avoid).length < 2) { showToast('Adicione pelo menos 2 locais não evitados', true); return; }
    updateRoute(); showToast('Rota otimizada');
  });

  // limpar tudo
  document.getElementById('clear-route').addEventListener('click', () => {
    if (!confirm('Limpar rota e gastos?')) return;
    places=[]; generalExpenses = []; originalPlacesSnapshot = null;
    saveData(); renderPlaces(); renderExpenses(); updateRoute(); stopGPSTracking(); showToast('Limpo');
  });

  // start/stop trip (usa geolocalização atual como origem e inicia tracking)
  document.getElementById('start-trip').addEventListener('click', () => {
    if (watchId) { stopGPSTracking(); showToast('Rastreamento parado'); return; }
    // snapshot original antes de iniciar (para restaurar caso remova locais adicionados)
    originalPlacesSnapshot = JSON.stringify(places);
    // obtain current position then start tracking
    if (!navigator.geolocation) { showToast('Geolocalização não suportada', true); return; }
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude, lng = pos.coords.longitude;
      // set current marker
      if (currentPositionMarker) currentPositionMarker.setMap(null);
      currentPositionMarker = new google.maps.Marker({ position:{lat,lng}, map, icon:{ url: ICONS.current, scaledSize: new google.maps.Size(36,36) }, title:'Posição atual' });
      map.setCenter({lat,lng}); map.setZoom(15);
      // insert synthetic origin to top of places if not already using currentPos
      // We don't modify saved places; updateRoute will prefer currentPositionMarker as origin when present.
      // Start watchPosition to track movement
      startGPSTracking();
      updateRoute();
      showToast('Viagem iniciada — rastreamento ativo');
      document.getElementById('start-trip').classList.add('bg-red-600'); document.getElementById('start-trip').textContent='Parar Rastreamento';
    }, err => {
      showToast('Erro ao obter localização: ' + (err.message||err.code), true);
    }, { enableHighAccuracy:true, timeout:10000 });
  });

  // permitir Enter no campo de busca
  document.getElementById('search').addEventListener('keydown', e => { if (e.key === 'Enter'){ e.preventDefault(); document.getElementById('btn-search').click(); } });

  // click listener para POI result actions (delegação)
  document.getElementById('poi-results').addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;
    const idx = parseInt(btn.dataset.idx);
    const action = btn.dataset.action;
    const item = window._lastPoiResults && window._lastPoiResults[idx];
    if (!item) return;
    if (action === 'add-next') {
      // adicionar como próxima parada (inserir depois de origem ou no começo)
      const newPlace = {
        name: item.name,
        value: 0,
        category: mapPoiTypeToCategory(item.types),
        address: item.vicinity || item.formatted_address || '',
        lat: item.geometry.location.lat(),
        lng: item.geometry.location.lng(),
        date: new Date().toISOString(),
        avoid: false
      };
      // inserir como próxima: se tracking -> inserir no início (pois origin=current pos); se nao -> inserir pos 1
      if (currentPositionMarker) places.unshift(newPlace); else places.splice(1,0,newPlace);
      saveData(); renderPlaces(); updateRoute(); showToast('POI adicionado como próxima parada');
    } else if (action === 'view') {
      map.setCenter(item.geometry.location); map.setZoom(16);
    }
  });

  // atualizar stats ao mudar combustíveis
  document.getElementById('fuel-efficiency').addEventListener('change', updateStats);
  document.getElementById('fuel-price').addEventListener('change', updateStats);
}

// ========== GPS tracking (watchPosition) ==========
function startGPSTracking(){
  if (!navigator.geolocation) { showToast('Geolocalização não suportada', true); return; }
  watchId = navigator.geolocation.watchPosition(p => {
    const lat = p.coords.latitude, lng = p.coords.longitude;
    const pos = { lat, lng };
    // atualizar current marker
    if (!currentPositionMarker) {
      currentPositionMarker = new google.maps.Marker({ position: pos, map, icon:{ url: ICONS.current, scaledSize: new google.maps.Size(36,36) } });
    } else {
      currentPositionMarker.setPosition(pos);
    }
    // adicionar ao path e desenhar polyline
    pathCoordinates.push(pos);
    if (pathPolyline) pathPolyline.setMap(null);
    if (pathCoordinates.length>1) {
      pathPolyline = new google.maps.Polyline({ path: pathCoordinates, map, geodesic:true, strokeColor:'#0ea5e9', strokeWeight:4 });
    }
    // recalcular rota (origin será a posição atual)
    updateRoute();
    // checar proximidade ao próximo waypoint (dist < 500m)
    if (places && places.length>0) {
      checkProximityToNext(pos);
    }
  }, err => {
    showToast('Erro no GPS: ' + (err.message||err.code), true);
  }, { enableHighAccuracy:true, maximumAge:5000, timeout:10000 });
}

function stopGPSTracking(){
  if (watchId){ navigator.geolocation.clearWatch(watchId); watchId = null; }
  if (currentPositionMarker){ currentPositionMarker.setMap(null); currentPositionMarker = null; }
  if (pathPolyline){ pathPolyline.setMap(null); pathPolyline = null; pathCoordinates = []; }
  document.getElementById('start-trip').classList.remove('bg-red-600');
  document.getElementById('start-trip').textContent = 'Iniciar Viagem';
}

function checkProximityToNext(currentPos){
  if (!google || !google.maps) return;
  // determine next non-avoid place in array order
  const next = (places || []).find(p => !p.avoid);
  if (!next) return;
  const dist = google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(currentPos.lat, currentPos.lng), new google.maps.LatLng(next.lat, next.lng));
  if (dist < 500) showToast(`Você está próximo de ${next.name} (${Math.round(dist)} m)`);
}

// ========== POI search (nearbySearch) ==========
function searchNearbyPOI(type){
  if (!google || !google.maps || !google.maps.places){ showToast('Places API indisponível', true); return; }
  // usar centro do mapa para busca
  const center = map.getCenter();
  const request = { location: center, radius: 3000, type: type }; // 3km
  const service = new google.maps.places.PlacesService(map);
  service.nearbySearch(request, (results, status) => {
    const container = document.getElementById('poi-results');
    container.innerHTML = '';
    if (status !== google.maps.places.PlacesServiceStatus.OK || !results || results.length===0){ container.innerHTML = '<div class="text-gray-500">Nenhum POI encontrado</div>'; return; }
    // armazenar localmente para ações
    window._lastPoiResults = results;
    results.slice(0,12).forEach((r, idx) => {
      const card = document.createElement('div');
      card.className = 'p-2 border rounded poi-result flex justify-between items-center';
      card.innerHTML = `<div><div class="font-medium">${r.name}</div><div class="text-xs text-gray-500">${r.vicinity||''}</div></div>
        <div class="flex flex-col items-end gap-1">
          <div class="text-sm">${r.rating ? '⭐ ' + r.rating : ''}</div>
          <div class="flex gap-1">
            <button data-action="view" data-idx="${idx}" class="px-2 py-1 bg-sky-50 rounded text-xs">Ver</button>
            <button data-action="add-next" data-idx="${idx}" class="px-2 py-1 bg-emerald-100 rounded text-xs">Adicionar próxima</button>
          </div>
        </div>`;
      container.appendChild(card);
    });
  });
}

function mapPoiTypeToCategory(types){
  if (!types) return 'other';
  if (types.includes('gas_station')) return 'shopping'; // you can map to a specific category like 'gas'
  if (types.includes('restaurant') || types.includes('food')) return 'restaurant';
  if (types.includes('lodging')) return 'hotel';
  if (types.includes('tourist_attraction') || types.includes('point_of_interest')) return 'attraction';
  return 'other';
}

// ========== Carregar Google Maps ==========
function loadGoogleMaps(){
  const key = 'YOUR_API_KEY_HERE'; // <<--- substitua aqui
  const s = document.createElement('script');
  s.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyAPkjcgFgdopkeZN0GnvhOc787jrajJnWc&libraries=places,directions,geometry&callback=initMap`;
  s.async = true; s.defer = true;
  s.onerror = ()=> showToast('Falha ao carregar Google Maps. Verifique a chave/API.', true);
  document.head.appendChild(s);
}

window.addEventListener('DOMContentLoaded', loadGoogleMaps);
</script>
</body>
</html>
