<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roteiro de Viagem — GPS & POIs (Suave)</title>

  <!-- Tailwind CDN (opcional — já estava no seu design) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Roboto', sans-serif; background: #f0f9ff; }
    .container { max-width: 1040px; margin: 20px auto; padding: 0 16px; }

    #map { height: 420px; width: 100%; border-radius: 12px; box-shadow: 0 6px 20px rgba(2,6,23,0.08); }

    .card { background: #fff; padding: 16px; border-radius: 12px; box-shadow: 0 4px 12px rgba(2,6,23,0.04); }

    .place-item { transition: all .18s ease; }
    .place-item:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(2,6,23,0.06); }

    .category-badge { display:inline-block; padding:.25rem .5rem; border-radius:9999px; font-size:.75rem; font-weight:500; }

    #start-trip.tracking { animation: pulse 2s infinite; }
    @keyframes pulse { 0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)} }

    .toast { position:fixed; bottom:20px; right:20px; padding:12px 20px; border-radius:8px; color:white; background-color:#0ea5e9; box-shadow:0 6px 26px rgba(2,6,23,0.12); z-index:10000; transition:opacity .35s ease; }
    .toast.error{ background-color:#dc2626; }

    /* legenda simples sobre o mapa */
    .map-legend {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      background: rgba(255,255,255,0.95);
      padding: 8px 12px;
      border-radius: 999px;
      box-shadow: 0 4px 20px rgba(2,6,23,0.08);
      z-index: 10;
      font-size: 13px;
      align-items: center;
    }
    .legend-item { display:flex; gap:8px; align-items:center; }
    .legend-dot { width:12px; height:12px; border-radius:50%; box-shadow: inset 0 -2px 4px rgba(0,0,0,0.08); }

    /* small responsive tweaks */
    @media (max-width: 768px) {
      #map { height: 360px; }
      .map-legend { left: 10px; transform: none; top: 10px; }
    }

    /* small style for info window buttons */
    .iw-btn { display:inline-block; margin-top:6px; background:#0ea5e9; color:#fff; padding:6px 10px; border-radius:6px; text-decoration:none; font-weight:600; }
    .iw-btn.desist { background:#ef4444; }
  </style>
</head>
<body>
  <header class="bg-white shadow-sm sticky top-0 z-20">
    <div class="container flex justify-between items-center py-3">
      <h1 class="text-2xl font-bold text-sky-800">Roteiro de Viagem</h1>
      <nav class="flex gap-4">
        <a href="#" class="text-sky-600 font-medium">Fotos</a>
        <a href="#" class="text-gray-500">Sair</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- left column: settings / places -->
      <div class="lg:col-span-1 space-y-6">
        <div class="card">
          <h2 class="font-semibold text-lg mb-3 text-sky-700">Configurações do Veículo</h2>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm text-gray-600">Consumo (km/l)</label>
              <input id="fuel-efficiency" type="number" min="1" value="10" class="w-full p-2 border rounded mt-1">
            </div>
            <div>
              <label class="block text-sm text-gray-600">Preço Combustível (R$/l)</label>
              <input id="fuel-price" type="number" min="0.1" step="0.01" value="5.50" class="w-full p-2 border rounded mt-1">
            </div>
          </div>
        </div>

        <div class="card">
          <h2 class="font-semibold text-lg mb-3 text-sky-700">Adicionar Local</h2>
          <div class="space-y-3">
            <div>
              <label class="block text-sm text-gray-600">Pesquisar (endereço ou nome)</label>
              <div class="relative">
                <input id="search" type="text" placeholder="Digite o nome do local" class="w-full p-2 border rounded mt-1">
                <button id="btn-search" class="absolute right-1 top-1 bg-sky-600 text-white p-2 rounded">OK</button>
              </div>
            </div>
            <div>
              <label class="block text-sm text-gray-600">Nome do Local</label>
              <input id="place-name" class="w-full p-2 border rounded mt-1">
            </div>
            <div>
              <label class="block text-sm text-gray-600">Custo (R$)</label>
              <input id="place-value" type="number" min="0" step="0.01" class="w-full p-2 border rounded mt-1">
            </div>
            <div>
              <label class="block text-sm text-gray-600">Categoria</label>
              <select id="place-category" class="w-full p-2 border rounded mt-1">
                <option value="attraction">Atração Turística</option>
                <option value="park">Parque</option>
                <option value="hotel">Hotel</option>
                <option value="restaurant">Restaurante</option>
                <option value="museum">Museu</option>
                <option value="shopping">Compras</option>
                <option value="gas_station">Posto (Combustível)</option>
                <option value="other">Outro</option>
              </select>
            </div>
            <button id="add-place" class="w-full bg-sky-600 text-white py-2 rounded mt-2">Adicionar Local</button>
          </div>
        </div>

        <div class="card">
          <h2 class="font-semibold text-lg mb-3 text-sky-700">Gastos Gerais</h2>
          <div id="expenses-list" class="space-y-2 mb-3"></div>
          <div class="grid grid-cols-1 gap-2">
            <input id="expense-title" placeholder="Descrição" class="w-full p-2 border rounded">
            <input id="expense-amount" placeholder="Valor (R$)" type="number" step="0.01" class="w-full p-2 border rounded">
            <button id="add-expense" class="w-full bg-sky-600 text-white py-2 rounded">Adicionar</button>
          </div>
        </div>
      </div>

      <!-- center: mapa -->
      <div class="lg:col-span-2 space-y-4 relative">
        <div class="card relative">
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-semibold text-lg text-sky-700">Mapa da Viagem</h2>
            <div class="flex gap-2">
              <button id="start-trip" class="bg-sky-600 text-white px-4 py-2 rounded">Iniciar Viagem</button>
              <button id="optimize-route" class="bg-sky-100 text-sky-700 px-4 py-2 rounded">Otimizar Rota</button>
              <button id="abort-temp" style="display:none;" class="bg-red-600 text-white px-4 py-2 rounded">Desistir</button>
              <button id="clear-route" class="text-red-500 px-4 py-2 rounded border border-red-200">Limpar Tudo</button>
            </div>
          </div>

          <!-- legenda com cores -->
          <div class="map-legend" id="map-legend">
            <div class="legend-item"><div class="legend-dot" style="background:#3b82f6"></div><div class="text-xs">Hotel</div></div>
            <div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div><div class="text-xs">Atração</div></div>
            <div class="legend-item"><div class="legend-dot" style="background:#16a34a"></div><div class="text-xs">Restaurante</div></div>
            <div class="legend-item"><div class="legend-dot" style="background:#f59e0b"></div><div class="text-xs">Posto</div></div>
            <div class="legend-item"><div class="legend-dot" style="background:#8b5cf6"></div><div class="text-xs">Compras</div></div>
          </div>

          <div id="map"></div>
        </div>

        <div class="card">
          <h3 class="font-semibold text-sky-700 mb-3">Resumo da Viagem</h3>
          <div class="grid grid-cols-3 gap-3 mb-3">
            <div class="p-3 bg-sky-50 rounded">
              <p class="text-sm text-gray-600">Distância Total</p>
              <p id="total-distance" class="text-lg font-bold text-sky-800">0 km</p>
            </div>
            <div class="p-3 bg-sky-50 rounded">
              <p class="text-sm text-gray-600">Tempo Total</p>
              <p id="total-time" class="text-lg font-bold text-sky-800">0 min</p>
            </div>
            <div class="p-3 bg-sky-50 rounded">
              <p class="text-sm text-gray-600">Custo Combustível</p>
              <p id="fuel-cost" class="text-lg font-bold text-sky-800">R$ 0,00</p>
            </div>
          </div>

          <div id="route-details" class="space-y-2 text-sm text-gray-700"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- ---------- SCRIPT PRINCIPAL (corrigido e completo) ---------- -->
  <script>
    // ---------- CONFIG ----------
    const GM_API_KEY = 'YOUR_API_KEY_HERE'; // <-- substituir pela sua chave

    const categoryStyles = {
      attraction: { color: '#ef4444', icon: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png', name: 'Atração' },
      park:       { color: '#10b981', icon: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png', name: 'Parque' },
      hotel:      { color: '#3b82f6', icon: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png', name: 'Hotel' },
      restaurant: { color: '#16a34a', icon: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png', name: 'Restaurante' },
      gas_station:{ color: '#f59e0b', icon: 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png', name: 'Posto' },
      supermarket:{ color: '#a3e635', icon: 'https://maps.google.com/mapfiles/ms/icons/lightgreen-dot.png', name: 'Mercado' },
      museum:     { color: '#f59e0b', icon: 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png', name: 'Museu' },
      shopping:   { color: '#8b5cf6', icon: 'https://maps.google.com/mapfiles/ms/icons/purple-dot.png', name: 'Compras' },
      other:      { color: '#6b7280', icon: 'https://maps.google.com/mapfiles/ms/icons/pink-dot.png', name: 'Outro' }
    };

    // ---------- UTILS ----------
    function showToast(message, isError = false, time = 3000) {
      const t = document.createElement('div');
      t.className = 'toast' + (isError ? ' error' : '');
      t.textContent = message;
      document.body.appendChild(t);
      setTimeout(() => { t.style.opacity = '0'; setTimeout(()=>t.remove(),350); }, time);
    }

    function formatCurrency(value) {
      try { return (Number(value)||0) === 0 ? 'R$ 0,00' : Number(value).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
      catch(e){ return 'R$ 0,00'; }
    }

    function hexToRgba(hex, alpha=1) {
      if(!hex) return `rgba(0,0,0,${alpha})`;
      const h = hex.replace('#','');
      const bigint = parseInt(h,16);
      const r=(bigint>>16)&255, g=(bigint>>8)&255, b=bigint&255;
      return `rgba(${r},${g},${b},${alpha})`;
    }

    function computeHeading(a, b) {
      const toRad = deg => deg * Math.PI / 180;
      const toDeg = rad => rad * 180 / Math.PI;
      const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
      const dLon = toRad(b.lng - a.lng);
      const y = Math.sin(dLon) * Math.cos(lat2);
      const x = Math.cos(lat1)*Math.sin(lat2) - Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
      return (toDeg(Math.atan2(y,x)) + 360) % 360;
    }

    // ---------- Estado global ----------
    let map, directionsService, directionsRendererMain, directionsRendererTemp, placesService, infoWindow;
    let markers = [], poiMarkers = [];
    let places = [], generalExpenses = [];
    let lastRouteResult = null;
    let lastRouteResultSaved = null;

    // GPS / movement smoothing
    let watchId = null;
    let currentPositionMarker = null;
    let currentPositionIcon = null;
    let pathCoordinates = [];
    let pathPolyline = null;

    // smoothing details: queue of positions to animate
    let positionQueue = [];
    let isAnimating = false;
    const MAX_ALLOWED_SPEED_MPS = 80; // 80 m/s ~ muito rápido (protege contra saltos absurdos) - reduz se necessário
    const SMOOTH_DURATION_MS = 900; // duração da animação entre pontos (ajuste fino)

    // POI debounce
    let poiDebounceTimer = null;
    let lastPOICenter = null;
    const POI_SEARCH_DISTANCE_THRESHOLD = 500; // metros

    // ---------- initMap (callback do Google) ----------
    function initMap() {
      const initialLocation = { lat: -15.795, lng: -47.891 }; // Brasília por padrão

      map = new google.maps.Map(document.getElementById('map'), {
        center: initialLocation,
        zoom: 13,
        mapTypeControl: true,
        streetViewControl: false,
        gestureHandling: 'greedy',
        styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
      });

      directionsService = new google.maps.DirectionsService();
      directionsRendererMain = new google.maps.DirectionsRenderer({
        map: map,
        suppressMarkers: true,
        polylineOptions: { strokeColor: '#0ea5e9', strokeOpacity: 0.95, strokeWeight: 6 }
      });
      directionsRendererTemp = new google.maps.DirectionsRenderer({
        map: map,
        suppressMarkers: true,
        polylineOptions: { strokeColor: '#16a34a', strokeOpacity: 0.95, strokeWeight: 6 }
      });

      infoWindow = new google.maps.InfoWindow();

      currentPositionIcon = {
        url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
        scaledSize: new google.maps.Size(36,36),
        anchor: new google.maps.Point(18,18)
      };

      placesService = new google.maps.places.PlacesService(map);

      pathPolyline = new google.maps.Polyline({
        path: pathCoordinates,
        geodesic: true,
        strokeColor: '#0b74de',
        strokeOpacity: 1.0,
        strokeWeight: 4,
        map
      });

      // listeners, dados e inicialização
      loadData();
      setupEventListeners();

      // buscar POIs quando mapa estiver idle
      map.addListener('idle', () => schedulePOISearch(map.getCenter()));

      console.log('Mapa inicializado.');
    }

    // ---------- GPS Tracking (com suavização) ----------
    function startGPSTracking() {
      if (!navigator.geolocation) { showToast('Geolocalização não suportada', true); return; }
      showToast('Iniciando rastreamento GPS...');
      // usamos watchPosition como fonte; a animação é feita pela queue
      watchId = navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        const accuracy = pos.coords.accuracy || 0;
        const heading = pos.coords.heading; // pode ser null
        const speed = pos.coords.speed; // m/s (pode ser null)

        enqueuePosition({ lat, lng, accuracy, heading, speed, ts: Date.now() });
      }, err => {
        let msg = 'Erro no GPS.';
        if (err && err.code !== undefined) {
          if (err.code === 1) msg = 'Permissão de localização negada.';
          else if (err.code === 2) msg = 'Informação de localização indisponível.';
          else if (err.code === 3) msg = 'Tempo de espera para localização expirado.';
        }
        showToast(msg, true);
        stopGPSTracking();
      }, { enableHighAccuracy: true, maximumAge: 3000, timeout: 30000 });

      const startBtn = document.getElementById('start-trip');
      startBtn.textContent = 'Parar Rastreamento';
      startBtn.classList.add('tracking', 'bg-red-600');
    }

    function stopGPSTracking() {
      if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
      const startBtn = document.getElementById('start-trip');
      startBtn.textContent = 'Iniciar Viagem';
      startBtn.classList.remove('tracking', 'bg-red-600');
    }

    function enqueuePosition(p) {
      // proteção contra saltos muito grandes: verifica distância/tempo desde último ponto real adicionado ao pathCoordinates
      if (pathCoordinates.length > 0) {
        const last = pathCoordinates[pathCoordinates.length-1];
        const d = google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(last.lat, last.lng), new google.maps.LatLng(p.lat, p.lng)); // metros
        const dt = Math.max(1, (p.ts - (last.ts || (p.ts-1000))));
        const speed = d / dt; // m/ms -> *1000 => m/s but we only compare approx
        // se salto é absurdamente grande (ex.: > 50 km em 1s), rejeita
        if (d > 5000 && dt < 2000) {
          console.warn('Ignorando salto GPS absurdo', d, dt);
          return;
        }
      }

      // push pra fila
      positionQueue.push(p);
      // processar fila: se não está animando, start
      if (!isAnimating) processPositionQueue();
    }

    async function processPositionQueue() {
      if (isAnimating) return;
      isAnimating = true;
      while (positionQueue.length > 0) {
        const next = positionQueue.shift();
        await animateToPosition(next);
      }
      isAnimating = false;
    }

    function animateToPosition(posData) {
      return new Promise(resolve => {
        const toLatLng = new google.maps.LatLng(posData.lat, posData.lng);
        pathCoordinates.push({ lat: posData.lat, lng: posData.lng, ts: posData.ts });
        pathPolyline.setPath(pathCoordinates.map(p => new google.maps.LatLng(p.lat, p.lng)));

        // cria marker se necessário
        if (!currentPositionMarker) {
          currentPositionMarker = new google.maps.Marker({
            position: toLatLng,
            map,
            icon: {
              url: 'https://maps.google.com/mapfiles/kml/shapes/cabs.png',
              scaledSize: new google.maps.Size(36,36),
              anchor: new google.maps.Point(18,18)
            },
            zIndex: 1000,
            title: 'Você'
          });
          map.setCenter(toLatLng);
          updateMainRouteFromCurrentPosition({ lat: posData.lat, lng: posData.lng });
          // short delay
          setTimeout(() => resolve(), 200);
          return;
        }

        // calcular distância entre ponto atual e novo
        const from = currentPositionMarker.getPosition();
        const dist = google.maps.geometry.spherical.computeDistanceBetween(from, toLatLng); // metros
        // limitar distâncias absurdas: se > 2000m, teleportar (provavelmente ponto inválido)
        const maxTeleport = 2000;
        if (dist > maxTeleport) {
          currentPositionMarker.setPosition(toLatLng);
          map.panTo(toLatLng);
          resolve();
          return;
        }

        // duração dinamicamente ajustada dependendo da distância e velocidade reportada
        let duration = SMOOTH_DURATION_MS;
        // se velocidade sensata disponível, ajustar duração
        if (posData.speed && posData.speed > 0) {
          // posData.speed está em m/s, queremos um tempo proporcional para percorrer dist (m)
          const desiredMs = Math.min(3000, Math.max(300, (dist / Math.max(0.5, posData.speed)) * 1000));
          duration = Math.max(300, Math.min(3000, desiredMs));
        } else {
          // ajustar por dist
          duration = Math.min(3000, Math.max(300, Math.round(dist * 2))); // heurística
        }

        const startTime = performance.now();
        const startPos = { lat: from.lat(), lng: from.lng() };
        const endPos = { lat: posData.lat, lng: posData.lng };

        // rotação (heading)
        let targetHeading = posData.heading;
        if (targetHeading === null || targetHeading === undefined) {
          // computar heading da movimentacao
          targetHeading = computeHeading(startPos, endPos);
        }

        function step(now) {
          const t = Math.min(1, (now - startTime) / duration);
          const ease = (t<0.5) ? (2*t*t) : (-1 + (4 - 2*t)*t); // easeInOutQuad-ish
          const lat = startPos.lat + (endPos.lat - startPos.lat) * ease;
          const lng = startPos.lng + (endPos.lng - startPos.lng) * ease;
          currentPositionMarker.setPosition(new google.maps.LatLng(lat, lng));

          // atualizar icone/rotacao se for um symbol (alguns browsers não giram imagens sem canvas; aqui mantemos simples)
          try {
            const icon = currentPositionMarker.getIcon() || {};
            if (typeof icon === 'object') {
              // se for symbol, pode usar rotation; se for url, ignoramos
              if (icon.path) {
                icon.rotation = targetHeading;
                currentPositionMarker.setIcon(icon);
              }
            }
          } catch (e) { /* ignore */ }

          // centralizar mapa suavemente
          map.panTo(new google.maps.LatLng(lat, lng));

          if (t < 1) requestAnimationFrame(step);
          else {
            // final
            // atualizar rota principal a partir da posicao atual
            updateMainRouteFromCurrentPosition({ lat: endPos.lat, lng: endPos.lng });
            resolve();
          }
        }
        requestAnimationFrame(step);
      });
    }

    // recalcula a rota principal usando a posição atual como origem (preserva waypoints/destino)
    function updateMainRouteFromCurrentPosition(currentPos) {
      if (!places || places.length < 2) return;
      const waypoints = places.slice(1, -1).map(p => ({ location: { lat: p.lat, lng: p.lng }, stopover: true }));
      const request = {
        origin: { lat: currentPos.lat, lng: currentPos.lng },
        destination: { lat: places[places.length -1].lat, lng: places[places.length -1].lng },
        waypoints,
        travelMode: google.maps.TravelMode.DRIVING,
        optimizeWaypoints: true
      };
      directionsService.route(request, (result, status) => {
        if (status === 'OK') {
          directionsRendererMain.setMap(map);
          directionsRendererMain.setDirections(result);
          lastRouteResult = result;
          renderRouteDetails(result);
          updateStats();
        } else {
          console.warn('updateMainRouteFromCurrentPosition status', status);
        }
      });
    }

    // ---------- Persistência ----------
    function loadData() {
      try {
        const savedPlaces = localStorage.getItem('travel_places');
        const savedExpenses = localStorage.getItem('travel_expenses');
        if (savedPlaces) places = JSON.parse(savedPlaces);
        if (savedExpenses) generalExpenses = JSON.parse(savedExpenses);
      } catch (err) { console.warn('Erro parse localStorage', err); places = []; generalExpenses = []; }
      renderPlaces();
      renderExpenses();
      updateRoute();
    }

    function saveData() {
      try {
        localStorage.setItem('travel_places', JSON.stringify(places));
        localStorage.setItem('travel_expenses', JSON.stringify(generalExpenses));
      } catch (err) { console.warn('Erro ao salvar localStorage', err); }
    }

    // ---------- Renderização listas ----------
    function renderPlaces() {
      const container = document.getElementById('places-list');
      if (!container) return;
      container.innerHTML = '';
      if (!places || places.length === 0) {
        container.innerHTML = '<div class="text-center py-4 text-gray-500">Nenhum local adicionado ainda</div>';
        updateStats(); return;
      }

      places.forEach((place, index) => {
        const category = categoryStyles[place.category] || categoryStyles.other;
        const badgeBg = hexToRgba(category.color, .12);
        const div = document.createElement('div');
        div.className = 'place-item bg-white p-3 rounded-lg border border-gray-100 mb-2 flex justify-between items-start';
        const left = document.createElement('div');
        left.innerHTML = `<div class="flex items-center gap-2"><h3 class="font-semibold text-sky-800">${place.name}</h3>
          <span class="category-badge" style="background:${badgeBg}; color:${category.color}; margin-left:8px">${category.name}</span>
        </div>
        ${place.value ? `<p class="text-sm text-sky-600 mt-1">${formatCurrency(place.value)}</p>` : ''}
        ${place.address ? `<p class="text-xs text-gray-500 mt-1">${place.address}</p>` : ''}
        `;
        const right = document.createElement('div');
        right.className = 'flex gap-2 items-center';
        right.innerHTML = `
          <button data-index="${index}" title="Subir" class="move-up text-sky-600 p-1">▲</button>
          <button data-index="${index}" title="Descer" class="move-down text-sky-600 p-1">▼</button>
          <button data-index="${index}" title="Remover" class="delete-place text-red-500 p-1">✖</button>
        `;
        div.appendChild(left); div.appendChild(right);
        container.appendChild(div);
      });
      updateStats();
    }

    function renderExpenses() {
      const container = document.getElementById('expenses-list'); container.innerHTML = '';
      if (!generalExpenses || generalExpenses.length === 0) {
        container.innerHTML = '<div class="text-center py-2 text-gray-500">Nenhum gasto geral adicionado</div>'; updateStats(); return;
      }
      generalExpenses.forEach((expense, index) => {
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
        div.innerHTML = `<div><p class="font-medium">${expense.title}</p><p class="text-xs text-gray-500">${new Date(expense.date).toLocaleDateString()}</p></div>
          <div class="flex items-center gap-2"><p class="font-medium">${formatCurrency(expense.amount)}</p>
            <button data-index="${index}" class="delete-expense text-red-500 p-1">✖</button>
          </div>`;
        container.appendChild(div);
      });
      updateStats();
    }

    // ---------- Rota (marcadores + directions) ----------
    function updateRoute() {
      // limpar markers de places
      markers.forEach(m => m.setMap(null)); markers = [];

      if (!places || places.length === 0) {
        directionsRendererMain.setMap(null);
        directionsRendererMain.setDirections({ routes: [] });
        lastRouteResult = null; lastRouteResultSaved = null;
        document.getElementById('route-details').innerHTML = '';
        updateStats();
        return;
      }

      // criar markers
      places.forEach((place, index) => {
        const category = categoryStyles[place.category] || categoryStyles.other;
        const icon = { url: category.icon, scaledSize: new google.maps.Size(40,40), labelOrigin: new google.maps.Point(20,12) };
        const marker = new google.maps.Marker({
          position: { lat: place.lat, lng: place.lng },
          map,
          label: { text: String(index+1), color: 'white', fontSize: '14px', fontWeight: 'bold' },
          icon
        });
        marker.addListener('click', () => {
          const content = document.createElement('div');
          content.style.maxWidth = '260px';
          content.innerHTML = `<h3 style="margin:0 0 6px 0;font-weight:700">${place.name}</h3>
            <div style="color:${category.color};font-weight:600;margin-bottom:6px">${category.name}</div>
            ${place.value ? `<div style="margin-bottom:6px">${formatCurrency(place.value)}</div>` : ''}
            ${place.address ? `<div style="font-size:12px;color:#6b7280">${place.address}</div>` : ''}`;
          infoWindow.setContent(content);
          infoWindow.open(map, marker);
        });
        markers.push(marker);
      });

      if (places.length === 1) {
        map.setCenter(markers[0].getPosition()); map.setZoom(14);
        directionsRendererMain.setMap(null);
        directionsRendererMain.setDirections({ routes: [] });
        lastRouteResult = null; lastRouteResultSaved = null;
        document.getElementById('route-details').innerHTML = '';
        updateStats();
        return;
      }

      // calcular rota
      if (places.length >= 2) {
        const waypoints = places.slice(1, -1).map(p => ({ location: { lat: p.lat, lng: p.lng }, stopover: true }));
        const request = {
          origin: { lat: places[0].lat, lng: places[0].lng },
          destination: { lat: places[places.length -1].lat, lng: places[places.length -1].lng },
          waypoints, travelMode: google.maps.TravelMode.DRIVING, optimizeWaypoints: true, provideRouteAlternatives: false
        };
        directionsService.route(request, (result, status) => {
          if (status === 'OK') {
            directionsRendererMain.setMap(map);
            directionsRendererMain.setDirections(result);
            lastRouteResult = result;
            lastRouteResultSaved = JSON.parse(JSON.stringify(result));
            try {
              const bounds = new google.maps.LatLngBounds();
              result.routes[0].legs.forEach(leg => { bounds.extend(leg.start_location); bounds.extend(leg.end_location); });
              map.fitBounds(bounds);
            } catch (err) { console.warn('bounds error', err); }
            renderRouteDetails(result);
            updateStats();
          } else {
            showToast('Erro ao calcular rota: ' + status, true);
            lastRouteResult = null;
            updateStats();
          }
        });
      }
    }

    function renderRouteDetails(routeResult) {
      const container = document.getElementById('route-details'); container.innerHTML = '<h3 class="font-semibold mb-2">Detalhes do Percurso:</h3>';
      if (!routeResult || !routeResult.routes || !routeResult.routes[0]) {
        container.innerHTML += '<div class="text-gray-500">Sem detalhes de rota.</div>'; return;
      }
      const legs = routeResult.routes[0].legs || [];
      legs.forEach((leg,index) => {
        const fromPlace = places[index] || { name: 'Ponto' }, toPlace = places[index+1] || { name: 'Destino' };
        const div = document.createElement('div');
        div.className = 'bg-gray-50 p-3 rounded-lg mb-2';
        div.innerHTML = `<div class="flex justify-between items-center">
            <div>
              <p class="font-medium">${fromPlace.name} → ${toPlace.name}</p>
              <p class="text-sm text-gray-600">${leg.distance.text} • ${leg.duration.text}</p>
            </div>
            <p class="text-sky-700 font-medium">${leg.duration.text}</p>
          </div>`;
        container.appendChild(div);
      });
    }

    // ---------- Estatísticas ----------
    function updateStats() {
      const placesCost = (places||[]).reduce((s,p)=>s+(parseFloat(p.value)||0),0);
      document.getElementById('places-cost') && (document.getElementById('places-cost').textContent = formatCurrency(placesCost));
      const expensesCost = (generalExpenses||[]).reduce((s,e)=>s+(parseFloat(e.amount)||0),0);
      document.getElementById('expenses-cost') && (document.getElementById('expenses-cost').textContent = formatCurrency(expensesCost));

      let totalDistance=0, totalTime=0, fuelCost=0;
      if (lastRouteResult && lastRouteResult.routes && lastRouteResult.routes[0]) {
        lastRouteResult.routes[0].legs.forEach(leg=>{ totalDistance += (leg.distance && leg.distance.value)?leg.distance.value:0; totalTime += (leg.duration && leg.duration.value)?leg.duration.value:0; });
        const fuelEfficiency = parseFloat(document.getElementById('fuel-efficiency').value) || 10;
        const fuelPrice = parseFloat(document.getElementById('fuel-price').value) || 5.50;
        const fuelConsumption = (totalDistance/1000)/fuelEfficiency;
        fuelCost = fuelConsumption * fuelPrice;
      }

      document.getElementById('total-distance').textContent = ((totalDistance/1000)||0).toFixed(1) + ' km';
      const hours = Math.floor(totalTime/3600); const minutes = Math.round((totalTime%3600)/60);
      let timeText = '';
      if(hours>0) timeText += hours + ' h ';
      timeText += minutes + ' min';
      document.getElementById('total-time').textContent = timeText;
      document.getElementById('fuel-cost').textContent = formatCurrency(parseFloat(fuelCost)||0);
      const totalCost = placesCost + expensesCost + (fuelCost||0);
      document.getElementById('total-cost') && (document.getElementById('total-cost').textContent = formatCurrency(totalCost));
    }

    // ---------- POIs (auto search) ----------
    function schedulePOISearch(centerLatLng) {
      if (poiDebounceTimer) clearTimeout(poiDebounceTimer);
      poiDebounceTimer = setTimeout(() => {
        if (lastPOICenter) {
          const last = lastPOICenter;
          const dist = google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(last.lat,last.lng), centerLatLng);
          if (dist < POI_SEARCH_DISTANCE_THRESHOLD) return;
        }
        searchNearbyPOIs(centerLatLng);
      }, 800);
    }

    function searchNearbyPOIs(center) {
      if (!map || !placesService) { return; }
      const centerLatLng = center instanceof google.maps.LatLng ? center : new google.maps.LatLng(center.lat, center.lng);
      lastPOICenter = { lat: centerLatLng.lat(), lng: centerLatLng.lng() };

      poiMarkers.forEach(m => m.setMap(null)); poiMarkers = [];

      const typesToSearch = ['gas_station','lodging','restaurant','supermarket','convenience_store','tourist_attraction'];
      const radius = 3000;

      typesToSearch.forEach(type => {
        const req = { location: centerLatLng, radius, type };
        placesService.nearbySearch(req, (results, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length) {
            results.slice(0, 10).forEach(r => addPOIMarker(r, type));
          }
        });
      });
    }

    function addPOIMarker(placeResult, forcedType) {
      if (!placeResult.geometry || !placeResult.geometry.location) return;
      let type = forcedType || (placeResult.types && placeResult.types[0]) || 'other';
      if (type.includes('lodging')) type = 'hotel';
      if (type.includes('gas')) type = 'gas_station';
      if (type.includes('restaurant')) type = 'restaurant';
      if (type.includes('tourist')) type = 'attraction';
      if (type.includes('supermarket') || type.includes('grocery')) type = 'supermarket';
      if (type.includes('convenience')) type = 'supermarket';

      const style = categoryStyles[type] || categoryStyles.other;
      const icon = { url: style.icon, scaledSize: new google.maps.Size(36,36) };

      const marker = new google.maps.Marker({
        position: placeResult.geometry.location,
        map,
        title: placeResult.name,
        icon,
        zIndex: 900
      });

      marker.addListener('click', () => {
        const content = document.createElement('div');
        content.style.maxWidth = '260px';
        content.innerHTML = `<h3 style="margin:0 0 6px 0;font-weight:700">${placeResult.name}</h3>
          <div style="color:${style.color};font-weight:600;margin-bottom:6px">${style.name}</div>
          ${placeResult.vicinity ? `<div style="font-size:12px;color:#6b7280">${placeResult.vicinity}</div>` : ''}
          <div style="margin-top:8px"><a href="#" data-place-id="${placeResult.place_id}" class="iw-btn go-btn">Ir até aqui</a></div>`;

        infoWindow.setContent(content);
        infoWindow.open(map, marker);

        google.maps.event.addListenerOnce(infoWindow, 'domready', () => {
          const goBtn = document.querySelector('.iw-btn.go-btn');
          if (goBtn) {
            goBtn.addEventListener('click', (ev) => {
              ev.preventDefault();
              const poi = {
                name: placeResult.name,
                lat: placeResult.geometry.location.lat(),
                lng: placeResult.geometry.location.lng(),
                address: placeResult.vicinity || '',
                place_id: placeResult.place_id,
                category: type
              };
              setTemporaryDestination(poi);
              infoWindow.close();
            });
          }
        });
      });

      poiMarkers.push(marker);
    }

    // ---------- Rota Temporária ----------
    let tempDestination = null;
    function setTemporaryDestination(poi) {
      tempDestination = poi;
      document.getElementById('abort-temp').style.display = 'inline-block';
      showToast(`Rota temporária definida para ${poi.name}`);
      const start = currentPositionMarker ? currentPositionMarker.getPosition() : map.getCenter();
      if (!start) { showToast('Posição inicial desconhecida para ir até aqui.', true); return; }
      const startLatLng = { lat: start.lat(), lng: start.lng() };
      computeTempRoute(startLatLng, poi);
    }

    function computeTempRoute(startLatLng, poi) {
      if (!poi) return;
      const request = {
        origin: startLatLng,
        destination: { lat: poi.lat, lng: poi.lng },
        travelMode: google.maps.TravelMode.DRIVING,
        provideRouteAlternatives: false
      };
      directionsService.route(request, (result, status) => {
        if (status === 'OK') {
          directionsRendererTemp.setMap(map);
          directionsRendererTemp.setDirections(result);
          try {
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(result.routes[0].legs[0].start_location);
            bounds.extend(result.routes[0].legs[0].end_location);
            map.fitBounds(bounds);
          } catch(e){}
          renderTempDetails(result, poi);
        } else {
          showToast('Erro ao calcular rota temporária: ' + status, true);
        }
      });
    }

    function renderTempDetails(routeResult, poi) {
      const container = document.getElementById('route-details');
      let html = '<h3 class="font-semibold mb-2">Detalhes do Percurso:</h3>';
      if (lastRouteResult && lastRouteResult.routes) {
        html += '<div class="text-sm text-gray-600 mb-2">Rota principal (salva)</div>';
      }
      try {
        const leg = routeResult.routes[0].legs[0];
        html += `<div class="bg-green-50 p-3 rounded-lg mb-2">
          <div class="flex justify-between items-center">
            <div>
              <p class="font-medium">Rota temporária → ${poi.name}</p>
              <p class="text-sm text-gray-600">${leg.distance.text} • ${leg.duration.text}</p>
            </div>
            <p class="text-sky-700 font-medium">${leg.duration.text}</p>
          </div>
          <div class="mt-2 text-xs text-gray-600">Se desejar, clique em <strong>Desistir</strong> para voltar à rota original.</div>
        </div>`;
      } catch (e) { console.warn(e); }
      container.innerHTML = html;
    }

    function abortTemporaryRoute() {
      tempDestination = null;
      directionsRendererTemp.setMap(null);
      document.getElementById('abort-temp').style.display = 'none';
      showToast('Voltando à rota original.');
      if (lastRouteResultSaved) {
        lastRouteResult = JSON.parse(JSON.stringify(lastRouteResultSaved));
        directionsRendererMain.setMap(map);
        directionsRendererMain.setDirections(lastRouteResult);
        renderRouteDetails(lastRouteResult);
        updateStats();
      } else {
        document.getElementById('route-details').innerHTML = '';
      }
    }

    // ---------- Event listeners ----------
    function setupEventListeners() {
      // add-place
      document.getElementById('add-place').addEventListener('click', () => {
        const name = document.getElementById('place-name').value.trim();
        const value = parseFloat(document.getElementById('place-value').value) || 0;
        const category = document.getElementById('place-category').value;
        if (!name) { showToast('Por favor, digite um nome para o local', true); return; }
        if (!map) { showToast('Mapa ainda não carregado. Aguarde.', true); return; }
        const center = map.getCenter();
        const newPlace = {
          name, value, category,
          lat: center ? center.lat() : -15.795,
          lng: center ? center.lng() : -47.891,
          address: document.getElementById('search').value || '',
          date: new Date().toISOString()
        };
        places.push(newPlace); saveData(); renderPlaces(); updateRoute(); showToast('Local adicionado com sucesso!');
        document.getElementById('place-name').value = ''; document.getElementById('place-value').value = ''; document.getElementById('search').value = '';
      });

      // search
      document.getElementById('btn-search').addEventListener('click', () => {
        const query = document.getElementById('search').value.trim();
        if (!query) { showToast('Digite algo para pesquisar.', true); return; }
        if (!map || !google || !google.maps || !google.maps.places) { showToast('Serviço de lugares não disponível no momento.', true); return; }
        const service = new google.maps.places.PlacesService(map);
        service.findPlaceFromQuery({ query, fields: ['name','geometry','formatted_address','types'] }, (results, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK && results && results[0]) {
            const p = results[0];
            if (p.geometry && p.geometry.location) { map.setCenter(p.geometry.location); map.setZoom(15); }
            document.getElementById('place-name').value = p.name || '';
            document.getElementById('search').value = p.formatted_address || p.name || '';
            let category = 'other';
            if (p.types && (p.types.includes('park') || p.types.includes('natural_feature'))) category = 'park';
            else if (p.types && (p.types.includes('tourist_attraction') || p.types.includes('point_of_interest'))) category = 'attraction';
            else if (p.types && (p.types.includes('lodging') || p.types.includes('hotel'))) category = 'hotel';
            else if (p.types && (p.types.includes('restaurant') || p.types.includes('food'))) category = 'restaurant';
            else if (p.types && (p.types.includes('museum') || p.types.includes('art_gallery'))) category = 'museum';
            else if (p.types && (p.types.includes('shopping_mall') || p.types.includes('store'))) category = 'shopping';
            document.getElementById('place-category').value = category;
            showToast('Local encontrado! Preencha os detalhes e adicione.');
          } else {
            showToast('Local não encontrado. Tente outro termo de busca.', true);
          }
        });
      });

      // add-expense
      document.getElementById('add-expense').addEventListener('click', () => {
        const title = document.getElementById('expense-title').value.trim();
        const amount = parseFloat(document.getElementById('expense-amount').value);
        if (!title || isNaN(amount)) { showToast('Por favor, preencha todos os campos do gasto', true); return; }
        generalExpenses.push({ title, amount, date: new Date().toISOString() });
        saveData(); renderExpenses(); showToast('Gasto adicionado com sucesso!');
        document.getElementById('expense-title').value = ''; document.getElementById('expense-amount').value = '';
      });

      // places list actions (delegate)
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('button'); if (!btn) return;
        if (btn.classList.contains('delete-place')) {
          const index = parseInt(btn.dataset.index);
          if (confirm('Remover este local?')) { places.splice(index,1); saveData(); renderPlaces(); updateRoute(); showToast('Local removido!'); }
        } else if (btn.classList.contains('move-up')) {
          const index = parseInt(btn.dataset.index);
          if (index>0) { [places[index-1], places[index]] = [places[index], places[index-1]]; saveData(); renderPlaces(); updateRoute(); }
        } else if (btn.classList.contains('move-down')) {
          const index = parseInt(btn.dataset.index);
          if (index < places.length-1) { [places[index+1], places[index]] = [places[index], places[index+1]]; saveData(); renderPlaces(); updateRoute(); }
        } else if (btn.classList.contains('delete-expense')) {
          const index = parseInt(btn.dataset.index);
          if (confirm('Remover este gasto?')) { generalExpenses.splice(index,1); saveData(); renderExpenses(); showToast('Gasto removido!'); }
        }
      });

      // optimize
      document.getElementById('optimize-route').addEventListener('click', () => {
        if (places.length < 2) { showToast('Adicione pelo menos 2 locais para otimizar a rota', true); return; }
        updateRoute(); showToast('Rota otimizada com sucesso!');
      });

      // clear
      document.getElementById('clear-route').addEventListener('click', () => {
        if (places.length > 0 && confirm('Tem certeza que deseja limpar toda a rota?')) {
          places = []; generalExpenses = []; saveData(); renderPlaces(); renderExpenses(); updateRoute();
          stopGPSTracking();
          if (currentPositionMarker) { currentPositionMarker.setMap(null); currentPositionMarker=null; }
          if (pathPolyline) { pathPolyline.setMap(null); pathPolyline=null; }
          pathCoordinates = [];
          poiMarkers.forEach(m=>m.setMap(null)); poiMarkers=[];
          directionsRendererTemp.setMap(null);
          tempDestination = null;
          document.getElementById('abort-temp').style.display = 'none';
          showToast('Roteiro limpo com sucesso!');
        }
      });

      // start trip
      document.getElementById('start-trip').addEventListener('click', () => {
        if (watchId) { stopGPSTracking(); showToast('Rastreamento parado'); }
        else { startGPSTracking(); }
      });

      // abort temp
      document.getElementById('abort-temp').addEventListener('click', () => { if (confirm('Deseja abandonar o destino temporário e voltar à rota original?')) abortTemporaryRoute(); });

      // update stats on change
      document.getElementById('fuel-efficiency').addEventListener('change', updateStats);
      document.getElementById('fuel-price').addEventListener('change', updateStats);

      // enter in search triggers search
      document.getElementById('search').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); document.getElementById('btn-search').click(); } });
    }

    // ---------- carregar Google Maps dinamicamente ----------
    function loadGoogleMaps() {
      if (!GM_API_KEY || GM_API_KEY === 'YOUR_API_KEY_HERE') {
        console.warn('Substitua YOUR_API_KEY_HERE pela sua chave do Google Maps.');
      }
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=$AIzaSyAPkjcgFgdopkeZN0GnvhOc787jrajJnWc&libraries=places,directions,geometry&callback=initMap`;
      script.async = true;
      script.defer = true;
      script.onerror = () => showToast('Falha ao carregar Google Maps. Verifique sua chave/API.', true);
      document.head.appendChild(script);
    }

    // iniciar
    window.addEventListener('DOMContentLoaded', loadGoogleMaps);
  </script>

  <!-- fim do documento -->
</body>
</html>
