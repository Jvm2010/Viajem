<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Roteiro — Viagem</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script type="module" src="app_mod.js" defer></script>
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="firebase.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <script>
    // /* auth-check */
    (function(){
      try{
        const auth = sessionStorage.getItem('viagem:auth');
        if(auth !== '1' && auth !== '0'){
          window.location.href = 'index.html';
        }
        // if auth === '0' it's guest: allow but can restrict later
      }catch(e){
        console.error(e);
      }
    })();
  </script>

  <header class="bg-white shadow p-4 sticky top-0 z-10">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <h1 class="text-lg font-semibold">Roteiro — Viagem</h1>
      <nav class="text-sm space-x-4">
        <a href="index.html" class="text-sky-600">Início</a>
        <a href="fotos.html" class="text-sky-600">Fotos & Vídeos</a>
      </nav>
    </div>
  </header>

  <main class="max-w-4xl mx-auto p-4 space-y-4">
    <section class="card">
      <h2 class="font-semibold">Adicionar local</h2>
      <p class="small">Toque no mapa para adicionar um ponto ou use o campo para pesquisar.</p>

      <div class="mt-3 grid grid-cols-1 gap-3">
        <div class="flex gap-2">
          <input id="search" class="flex-1 input card p-2" placeholder="Pesquisar endereço ou nome do local" />
          <button id="btn-search" class="badge">Procurar</button>
        </div>

        <div class="input-grid">
          <input id="place-name" placeholder="Nome do local (ex: Praia do X)" class="p-2 card" />
          <input id="place-value" placeholder="Valor (opcional)" class="p-2 card" type="number" min="0" />
          <button id="add-current" class="badge">Adicionar</button>
        </div>

        <div class="flex gap-2 items-center">
          <label class="small">Gastos gerais separados</label>
          <button id="add-general" class="text-sm text-sky-600">Adicionar gasto geral</button>
        </div>
      </div>
    </section>

    <section class="grid md:grid-cols-2 gap-4">
      <div class="card">
        <h3 class="font-semibold">Mapa</h3>
        <div id="map" class="mt-3"></div>
        <div class="small mt-2">Clique nos marcadores para editar/remover. A ordem de lista define a rota.</div>
      </div>

      <div class="card">
        <h3 class="font-semibold">Locais salvos</h3>
        <div id="places-list" class="mt-3"></div>

        <h4 class="mt-4 font-semibold">Gastos gerais</h4>
        <div id="general-list" class="mt-2"></div>

        <div class="footer-summary mt-4">
          <div>
            <div class="small">Distância total</div>
            <div id="total-distance" class="text-xl font-bold">0 km</div>
          </div>
          <div>
            <div class="small">Custo total</div>
            <div id="total-cost" class="text-xl font-bold">R$ 0,00</div>
          </div>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="export-json" class="badge">Exportar JSON</button>
          <button id="clear-all" class="text-sm text-red-600">Limpar tudo</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal backdrop -->
  <div id="modal-backdrop" class="modal-backdrop" aria-hidden="true" style="display:flex">
    <div class="modal">
      <div class="flex items-center justify-between">
        <h3 id="modal-title" class="font-semibold text-lg">Título</h3>
        <button id="modal-cancel" class="text-sm text-gray-500">✕</button>
      </div>
      <div id="modal-body" class="mt-3 small"></div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="modal-confirm" class="badge">Confirmar</button>
        <button id="modal-cancel-2" onclick="document.getElementById('modal-backdrop').classList.remove('show')" class="text-sm text-gray-500">Cancelar</button>
      </div>
    </div>
  </div>


  <footer class="max-w-4xl mx-auto p-4 text-center small">
    Desenvolvido — Melhorias rápidas para usar no celular.
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script type="module">
  import * as core from './app_mod.js';
  import app, { db, storage } from './firebase.js';
  import { ref, push, set, onValue, remove, update, get } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js';
  import { ref as sRef, uploadString, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js';

  const state = core.loadState();
  // We'll keep local state but sync with Firebase
  state.points = []; state.generalExpenses = [];

  const map = L.map('map').setView([-23.5489, -46.6388], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);

  let markers = [];

  // Listen to locais
  const locaisRef = ref(db, 'locais');
  onValue(locaisRef, (snap) => {
    state.points = [];
    const val = snap.val() || {};
    Object.keys(val).forEach(k => {
      const item = val[k];
      item.id = k;
      // ensure numeric types
      item.value = Number(item.value) || 0;
      state.points.push(item);
    });
    // sort by created if present
    state.points.sort((a,b)=> (a.created||0) - (b.created||0));
    renderLists();
  });

  // Listen to gastos
  const gastosRef = ref(db, 'gastos');
  onValue(gastosRef, (snap) => {
    state.generalExpenses = [];
    const val = snap.val() || {};
    Object.keys(val).forEach(k => {
      const item = val[k];
      item.id = k;
      item.amount = Number(item.amount) || 0;
      state.generalExpenses.push(item);
    });
    state.generalExpenses.sort((a,b)=> (a.created||0)-(b.created||0));
    renderLists();
  });

  function renderLists(){
    const places = document.getElementById('places-list');
    places.innerHTML='';
    state.points.forEach((p, idx)=>{
      const div = document.createElement('div'); div.className='list-item';
      const left = document.createElement('div');
      let photoHtml = '';
      if(p.fotos && p.fotos.length) {
        photoHtml = `<img src="${p.fotos[0]}" style="width:60px;height:48px;object-fit:cover;border-radius:6px;margin-right:8px" />`;
      }
      left.innerHTML = `<div style="display:flex;align-items:center">${photoHtml}<div><div class="font-semibold">${p.name}</div><div class="small">${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}</div></div></div>`;
      const right = document.createElement('div' );
      right.innerHTML = `<div class="text-right"><div class="small">${p.value?core.formatCurrency(p.value):''}</div><div class="mt-2"><button class="text-sm text-sky-600 btn-focus" data-id="${p.id}" data-action="zoom">Ir</button> <button class="text-sm text-red-600" data-id="${p.id}" data-action="del">Remover</button></div></div>`;
      div.appendChild(left); div.appendChild(right);
      places.appendChild(div);
    });

    const gen = document.getElementById('general-list');
    gen.innerHTML='';
    state.generalExpenses.forEach((g, i)=>{
      const d = document.createElement('div'); d.className='list-item';
      d.innerHTML = `<div><div class="font-semibold">${g.title}</div><div class="small">${new Date(g.created).toLocaleString()}</div></div><div class="text-right">${core.formatCurrency(g.amount)} <div class="mt-2"><button class="text-sm text-red-600" data-gi="${g.id}">Remover</button></div></div>`;
      gen.appendChild(d);
    });

    // markers
    markers.forEach(m=>map.removeLayer(m)); markers = [];
    state.points.forEach((p, idx)=>{
      const m = L.marker([p.lat,p.lng]).addTo(map).bindPopup(`<strong>${p.name}</strong><br>${p.value?core.formatCurrency(p.value):''}`);
      m.on('click', ()=>{
        // highlight in list (scroll)
        const el = document.querySelector('[data-id=\"'+p.id+'\"]');
        if(el) el.scrollIntoView({behavior:'smooth',block:'center'});
      });
      markers.push(m);
    });

    updateTotals();
  }

  function updateTotals(){
    // distance between ordered points
    let totalKm = 0;
    for(let i=1;i<state.points.length;i++){
      totalKm += core.haversine(state.points[i-1], state.points[i]);
    }
    document.getElementById('total-distance').textContent = totalKm.toFixed(2) + ' km';
    // total cost
    let totalCost = state.points.reduce((s,p)=>s + (Number(p.value)||0), 0) + state.generalExpenses.reduce((s,g)=>s + (Number(g.amount)||0),0);
    document.getElementById('total-cost').textContent = core.formatCurrency(totalCost);
    core.saveState(state); // keep local cache
  }

  map.on('click', function(e){
    const lat = e.latlng.lat, lng = e.latlng.lng;
    document.getElementById('place-name').value = '';
    document.getElementById('place-value').value = '';
    // store temp coords
    map._temp = {lat,lng};
    alert('Local selecionado no mapa. Insira nome e pressione \"Adicionar\".');
  });

  async function saveLocalToFirebase(obj){
    const newRef = push(ref(db,'locais'));
    obj.created = Date.now();
    await set(newRef, obj);
    obj.id = newRef.key;
    return obj;
  }

  document.getElementById('add-current').addEventListener('click', async ()=>{
    const name = document.getElementById('place-name').value.trim() || 'Ponto';
    const val = document.getElementById('place-value').value;
    const coords = map._temp || {lat: map.getCenter().lat, lng: map.getCenter().lng};
    const obj = { name, lat: coords.lat, lng: coords.lng, value: val?Number(val):0, fotos: [] };
    try{
      const saved = await saveLocalToFirebase(obj);
      // local state will be updated via onValue listener
      alert('Local salvo no Firebase.');
    }catch(e){
      console.error(e); alert('Erro ao salvar no Firebase.'); 
    }
  });

  document.getElementById('places-list').addEventListener('click', async (ev)=>{
    const a = ev.target.closest('button');
    if(!a) return;
    const action = a.dataset.action;
    const id = a.dataset.id;
    if(action === 'zoom'){
      const item = state.points.find(x=>x.id===id);
      if(item) map.setView([item.lat,item.lng],15);
    } else if(action === 'del'){
      if(!confirm('Remover este local?')) return;
      try{
        await remove(ref(db,'locais/'+id));
      }catch(e){ console.error(e); alert('Erro ao remover.'); }
    }
  });

  document.getElementById('add-general').addEventListener('click', async ()=>{
    const title = prompt('Título do gasto geral:');
    if(!title) return;
    const amt = prompt('Valor (R$):','0');
    const obj = { title, amount: Number(amt)||0, created: Date.now(), fotos: [] };
    try{
      const newRef = push(ref(db,'gastos'));
      await set(newRef, obj);
      alert('Gasto salvo.');
    }catch(e){ console.error(e); alert('Erro ao salvar gasto.'); }
  });

  document.getElementById('export-json').addEventListener('click', ()=>{
    const a = document.createElement('a');
    const blob = new Blob([JSON.stringify({points:state.points,gastos:state.generalExpenses}, null, 2)],{type:'application/json'});
    a.href = URL.createObjectURL(blob);
    a.download = 'roteiro.json';
    a.click();
  });

  document.getElementById('clear-all').addEventListener('click', async ()=>{
    if(!confirm('Confirma limpar todo o roteiro e gastos no Firebase? Isso apagará TODOS os dados.')) return;
    try{
      await set(ref(db,'locais'), null);
      await set(ref(db,'gastos'), null);
    }catch(e){ console.error(e); alert('Erro ao limpar.'); }
  });

  document.getElementById('btn-search').addEventListener('click', async ()=>{
    const q = document.getElementById('search').value.trim();
    if(!q) return alert('Digite algo para buscar');
    // use nominatim openstreetmap
    const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(q));
    const data = await res.json();
    if(!data || !data.length) return alert('Nenhum resultado');
    const top = data[0];
    const lat = parseFloat(top.lat), lon = parseFloat(top.lon);
    map.setView([lat,lon],15);
    map._temp = {lat, lng: lon};
    document.getElementById('place-name').value = top.display_name;
  });

  // init render (will be populated by onValue listeners)
  renderLists();
  </script>


</body>
</html>
