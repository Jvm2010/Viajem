<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Roteiro — Viagem</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json">
  <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPkjcgFgdopkeZN0GnvhOc787jrajJnWc&libraries=places"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <header class="bg-white shadow p-4">
    <div class="max-w-5xl mx-auto flex items-center justify-between">
      <h1 class="text-lg font-semibold">Roteiro & Gastos</h1>
      <a href="index.html" class="text-sm text-sky-600">← Voltar</a>
    </div>
  </header>

  <main class="max-w-5xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <section class="lg:col-span-2 bg-white rounded-2xl shadow p-4">
      <div id="map" class="w-full h-96 rounded-lg overflow-hidden shadow-sm"></div>
      <div class="mt-3 flex gap-2">
        <input id="place-input" class="flex-1 rounded-md border px-3 py-2" placeholder="Buscar lugar (ex: Praia do Rosa)">
        <button id="add-marker" class="px-4 py-2 rounded-md bg-sky-600 text-white">Adicionar</button>
      </div>
      <div class="mt-3 text-sm text-gray-500">Toque no mapa para marcar local. Selecione um marcador para remover.</div>
    </section>

    <aside class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-medium mb-2">Gastos</h2>
      <form id="gasto-form" class="space-y-2">
        <input id="g-desc" class="w-full rounded-md border px-3 py-2" placeholder="Descrição">
        <input id="g-valor" type="number" step="0.01" class="w-full rounded-md border px-3 py-2" placeholder="Valor (R$)">
        <div class="flex gap-2">
          <button type="submit" class="flex-1 px-3 py-2 rounded-md bg-emerald-600 text-white">Adicionar</button>
          <button id="export-gastos" type="button" class="px-3 py-2 rounded-md border">Exportar CSV</button>
        </div>
      </form>

      <ul id="lista-gastos" class="mt-4 space-y-2 text-sm"></ul>
      <div class="text-xs text-gray-400 mt-4">Total: <span id="total">R$ 0,00</span></div>
    </aside>
  </main>

  <script>
// Simple map + markers + localStorage handling
let map, markers = [], markerData = [];
function initMap() {
  const br = { lat: -14.235004, lng: -51.92528 };
  map = new google.maps.Map(document.getElementById('map'), { zoom: 5, center: br });

  map.addListener('click', (e) => {
    addMarker(e.latLng, prompt('Nome para esse local:', 'Ponto de interesse') || 'Ponto');
  });

  loadMarkers();
}

function addMarker(latlng, title) {
  const marker = new google.maps.Marker({ position: latlng, map, title });
  marker.addListener('click', () => {
    if (confirm('Remover este marcador?')) {
      marker.setMap(null);
      markers = markers.filter(m=>m!==marker);
      markerData = markerData.filter(d => !(d.lat===latlng.lat() && d.lng===latlng.lng()));
      saveMarkers();
    }
  });
  markers.push(marker);
  markerData.push({lat: latlng.lat(), lng: latlng.lng(), title});
  saveMarkers();
}

function saveMarkers() {
  localStorage.setItem('markers', JSON.stringify(markerData));
}
function loadMarkers() {
  try {
    const raw = localStorage.getItem('markers');
    if (!raw) return;
    markerData = JSON.parse(raw);
    markerData.forEach(d => {
      const m = new google.maps.Marker({position:{lat:d.lat,lng:d.lng}, map, title:d.title});
      m.addListener('click', ()=>{ if(confirm('Remover este marcador?')){ m.setMap(null); markers = markers.filter(x=>x!==m); markerData = markerData.filter(z=>z!==d); saveMarkers(); } });
      markers.push(m);
    });
  } catch(e){ console.error(e) }
}

// Place search
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('place-input');
  const addBtn = document.getElementById('add-marker');
  const service = new google.maps.places.Autocomplete(input);
  addBtn.addEventListener('click', () => {
    const place = service.getPlace();
    if (place && place.geometry) {
      map.panTo(place.geometry.location);
      addMarker(place.geometry.location, place.name || input.value || 'Lugar');
    } else {
      alert('Escolha um resultado da lista ou toque no mapa.');
    }
  });

  // gastos handling
  const form = document.getElementById('gasto-form');
  const lista = document.getElementById('lista-gastos');
  const totalEl = document.getElementById('total');
  function updateLista() {
    lista.innerHTML = '';
    const gastos = JSON.parse(localStorage.getItem('gastos')||'[]');
    let total = 0;
    gastos.forEach((g,i)=>{
      total += parseFloat(g.valor||0);
      const li = document.createElement('li');
      li.className = 'flex justify-between items-center p-2 border rounded-md';
      li.innerHTML = `<div><strong>${g.desc}</strong><div class="text-xs text-gray-500">${g.date}</div></div><div class="flex gap-2 items-center"><span>R$ ${parseFloat(g.valor).toFixed(2)}</span><button data-i="${i}" class="remove text-red-600 text-sm">Remover</button></div>`;
      lista.appendChild(li);
    });
    totalEl.textContent = 'R$ ' + total.toFixed(2);
    document.querySelectorAll('.remove').forEach(btn=>btn.onclick = (e)=>{
      const i = e.target.dataset.i;
      const g = JSON.parse(localStorage.getItem('gastos')||'[]');
      g.splice(i,1);
      localStorage.setItem('gastos', JSON.stringify(g));
      updateLista();
    });
  }
  updateLista();

  form.addEventListener('submit', (ev)=>{
    ev.preventDefault();
    const desc = document.getElementById('g-desc').value.trim();
    const valor = parseFloat(document.getElementById('g-valor').value);
    if(!desc || !valor) return alert('Preencha descrição e valor.');
    const gastos = JSON.parse(localStorage.getItem('gastos')||'[]');
    gastos.push({desc, valor, date: new Date().toLocaleString()});
    localStorage.setItem('gastos', JSON.stringify(gastos));
    form.reset();
    updateLista();
  });

  document.getElementById('export-gastos').addEventListener('click', ()=>{
    const gastos = JSON.parse(localStorage.getItem('gastos')||'[]');
    if(gastos.length===0) return alert('Nenhum gasto para exportar.');
    const csv = ['Descrição,Valor,Data', ...gastos.map(g=>`"${g.desc.replace(/"/g,'""')}","${g.valor}","${g.date}"`)].join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'gastos.csv'; a.click();
    URL.revokeObjectURL(url);
  });
});
// Wait for maps lib then init
window.initMap = initMap;
  </script>
</body>
</html>
