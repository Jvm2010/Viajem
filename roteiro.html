<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Roteiro — Viagem Planner Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="firebase.js"></script>
  <script type="module" src="db_api.js"></script>
  <script type="module" src="app_mod.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- Verificação de autenticação -->
  <script>
    (function(){
      try {
        const auth = sessionStorage.getItem('viagem:auth');
        if(auth !== '1' && auth !== '0') window.location.href = 'index.html';
      } catch(e) { console.error(e); }
    })();
  </script>

  <header class="bg-white shadow p-4 sticky top-0 z-10">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <h1 class="text-lg font-semibold">Roteiro de Viagem</h1>
      <nav class="text-sm space-x-4">
        <a href="index.html" class="text-sky-600">Sair</a>
        <a href="fotos.html" class="text-sky-600">Galeria</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 space-y-6">
    <section class="card">
      <h2 class="font-semibold text-lg">Planejamento da Rota</h2>
      
      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="small">Modo de Transporte</label>
          <select id="transport-mode" class="p-2 card w-full mt-1">
            <option value="car">Carro</option>
            <option value="walk">A pé</option>
            <option value="bike">Bicicleta</option>
          </select>
        </div>
        
        <div>
          <label class="small">Consumo (km/l) - apenas carro</label>
          <input id="fuel-efficiency" type="number" min="1" value="10" class="p-2 card w-full mt-1">
        </div>
        
        <div>
          <label class="small">Velocidade Média (km/h)</label>
          <input id="avg-speed" type="number" min="1" value="60" class="p-2 card w-full mt-1">
        </div>
      </div>
    </section>

    <section class="grid md:grid-cols-3 gap-6">
      <div class="md:col-span-2 card">
        <h3 class="font-semibold">Mapa da Viagem</h3>
        <div id="map" class="mt-3"></div>
        <div class="flex gap-2 mt-3">
          <button id="optimize-route" class="badge">Otimizar Rota</button>
          <button id="clear-route" class="text-sm text-red-600">Limpar Rota</button>
        </div>
      </div>
      
      <div class="card">
        <h3 class="font-semibold">Resumo da Viagem</h3>
        <div class="mt-3 space-y-4">
          <div class="flex justify-between items-center">
            <span class="small">Locais visitados:</span>
            <span id="places-count" class="font-medium">0</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="small">Distância total:</span>
            <span id="total-distance" class="font-medium">0 km</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="small">Tempo estimado:</span>
            <span id="total-time" class="font-medium">0 horas</span>
          </div>
          <div class="flex justify-between items-center" id="fuel-section">
            <span class="small">Combustível necessário:</span>
            <span id="fuel-estimate" class="font-medium">0 litros</span>
          </div>
          <div class="flex justify-between items-center border-t pt-3">
            <span class="small font-semibold">Custo total estimado:</span>
            <span id="total-cost" class="text-lg font-bold">R$ 0,00</span>
          </div>
        </div>
        
        <div class="mt-6">
          <h4 class="font-semibold">Ações</h4>
          <div class="mt-2 flex flex-wrap gap-2">
            <button id="export-json" class="badge">Exportar Roteiro</button>
            <button id="share-trip" class="badge">Compartilhar</button>
            <button id="save-trip" class="badge">Salvar</button>
          </div>
        </div>
      </div>
    </section>

    <section class="grid md:grid-cols-2 gap-6">
      <div class="card">
        <h3 class="font-semibold">Locais da Viagem</h3>
        <div id="places-list" class="mt-3 space-y-2"></div>
        
        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
          <h4 class="font-medium text-sm">Adicionar novo local</h4>
          <div class="mt-2 grid grid-cols-1 gap-2">
            <input id="search" placeholder="Pesquisar local..." class="p-2 card w-full">
            <div class="grid grid-cols-3 gap-2">
              <input id="place-name" placeholder="Nome" class="p-2 card">
              <input id="place-value" placeholder="Custo R$" type="number" class="p-2 card">
              <button id="add-place" class="badge">Adicionar</button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3 class="font-semibold">Gastos Adicionais</h3>
        <div id="expenses-list" class="mt-3 space-y-2"></div>
        
        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
          <h4 class="font-medium text-sm">Adicionar gasto</h4>
          <div class="mt-2 grid grid-cols-1 gap-2">
            <div class="grid grid-cols-3 gap-2">
              <input id="expense-title" placeholder="Descrição" class="p-2 card">
              <input id="expense-amount" placeholder="Valor R$" type="number" class="p-2 card">
              <button id="add-expense" class="badge">Adicionar</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { subscribePlaces, savePlace, removePlace, subscribeExpenses, saveExpense } from './db_api.js';
    import { haversine, formatCurrency, calculateRoute } from './app_mod.js';
    
    // Inicialização do mapa
    const map = L.map('map').setView([-23.5505, -46.6333], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);
    
    let places = [];
    let expenses = [];
    let markers = [];
    let routePolyline = null;
    
    // Atualizar interface
    function updateUI() {
      // Lista de locais
      const placesList = document.getElementById('places-list');
      placesList.innerHTML = places.map(place => `
        <div class="list-item" data-id="${place.id}">
          <div>
            <div class="font-medium">${place.name}</div>
            <div class="small">${place.lat.toFixed(5)}, ${place.lng.toFixed(5)}</div>
          </div>
          <div class="flex gap-2">
            <button class="text-sm text-sky-600" data-action="view">Ver</button>
            <button class="text-sm text-red-600" data-action="remove">Remover</button>
          </div>
        </div>
      `).join('');
      
      // Lista de gastos
      const expensesList = document.getElementById('expenses-list');
      expensesList.innerHTML = expenses.map(expense => `
        <div class="list-item" data-id="${expense.id}">
          <div class="font-medium">${expense.title}</div>
          <div class="flex items-center gap-2">
            <span>${formatCurrency(expense.amount)}</span>
            <button class="text-sm text-red-600" data-action="remove">Remover</button>
          </div>
        </div>
      `).join('');
      
      // Atualizar marcadores no mapa
      markers.forEach(m => map.removeLayer(m));
      markers = places.map(place => 
        L.marker([place.lat, place.lng])
          .addTo(map)
          .bindPopup(`<b>${place.name}</b><br>${place.value ? formatCurrency(place.value) : 'Sem custo'}`)
      );
      
      // Calcular e mostrar estatísticas
      calculateStatistics();
    }
    
    // Calcular estatísticas da viagem
    function calculateStatistics() {
      const transportMode = document.getElementById('transport-mode').value;
      const fuelEfficiency = transportMode === 'car' ? 
        parseFloat(document.getElementById('fuel-efficiency').value) : 0;
      const avgSpeed = parseFloat(document.getElementById('avg-speed').value);
      
      const stats = calculateRoute(places, transportMode, fuelEfficiency, avgSpeed);
      
      document.getElementById('places-count').textContent = places.length;
      document.getElementById('total-distance').textContent = `${stats.totalDistance.toFixed(2)} km`;
      document.getElementById('total-time').textContent = stats.totalTime;
      
      if (transportMode === 'car') {
        document.getElementById('fuel-section').style.display = 'flex';
        document.getElementById('fuel-estimate').textContent = `${stats.fuelRequired.toFixed(1)} litros`;
      } else {
        document.getElementById('fuel-section').style.display = 'none';
      }
      
      const totalCost = places.reduce((sum, p) => sum + (p.value || 0), 0) +
                       expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
      document.getElementById('total-cost').textContent = formatCurrency(totalCost);
      
      // Desenhar rota no mapa
      if (routePolyline) map.removeLayer(routePolyline);
      if (stats.routeCoords.length > 1) {
        routePolyline = L.polyline(stats.routeCoords, {
          color: '#3b82f6',
          weight: 4,
          opacity: 0.7
        }).addTo(map);
      }
    }
    
    // Event Listeners
    document.getElementById('add-place').addEventListener('click', async () => {
      const name = document.getElementById('place-name').value.trim();
      const value = parseFloat(document.getElementById('place-value').value) || 0;
      
      if (!name) return alert('Digite um nome para o local');
      
      const coords = map.getCenter();
      const place = { 
        name, 
        value,
        lat: coords.lat,
        lng: coords.lng,
        created: Date.now()
      };
      
      await savePlace(place);
      document.getElementById('place-name').value = '';
      document.getElementById('place-value').value = '';
    });
    
    document.getElementById('add-expense').addEventListener('click', async () => {
      const title = document.getElementById('expense-title').value.trim();
      const amount = parseFloat(document.getElementById('expense-amount').value) || 0;
      
      if (!title) return alert('Digite uma descrição para o gasto');
      
      const expense = { title, amount, created: Date.now() };
      await saveExpense(expense);
      
      document.getElementById('expense-title').value = '';
      document.getElementById('expense-amount').value = '';
    });
    
    document.getElementById('places-list').addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      
      const item = btn.closest('.list-item');
      const id = item.dataset.id;
      const action = btn.dataset.action;
      
      if (action === 'view') {
        const place = places.find(p => p.id === id);
        if (place) map.setView([place.lat, place.lng], 15);
      } else if (action === 'remove') {
        if (confirm('Remover este item?')) removePlace(id);
      }
    });
    
    document.getElementById('expenses-list').addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn || btn.dataset.action !== 'remove') return;
      
      const id = btn.closest('.list-item').dataset.id;
      if (confirm('Remover este gasto?')) {
        // Implementar removeExpense se necessário
      }
    });
    
    document.getElementById('optimize-route').addEventListener('click', () => {
      if (places.length < 3) return alert('Adicione pelo menos 3 locais para otimizar');
      alert('Funcionalidade de otimização será implementada na próxima versão!');
    });
    
    document.getElementById('clear-route').addEventListener('click', () => {
      if (confirm('Limpar toda a rota?')) {
        places.forEach(p => removePlace(p.id));
        expenses.forEach(e => { /* remover gastos */ });
      }
    });
    
    // Atualizar quando mudar modo de transporte
    document.getElementById('transport-mode').addEventListener('change', () => {
      calculateStatistics();
    });
    
    // Subscrever dados do Firebase
    subscribePlaces(ps => {
      places = ps;
      updateUI();
    });
    
    subscribeExpenses(es => {
      expenses = es;
      updateUI();
    });
  </script>
</body>
</html>