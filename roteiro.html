<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Roteiro — Viagem</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script type="module" src="app_mod.js" defer></script>
  <script type="module" src="db_api.js" defer></script>
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="firebase.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <script>
    // /* auth-check */
    (function(){
      try{
        const auth = sessionStorage.getItem('viagem:auth');
        if(auth !== '1' && auth !== '0'){
          window.location.href = 'index.html';
        }
        // if auth === '0' it's guest: allow but can restrict later
      }catch(e){
        console.error(e);
      }
    })();
  </script>

  <header class="bg-white shadow p-4 sticky top-0 z-10">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <h1 class="text-lg font-semibold">Roteiro — Viagem</h1>
      <nav class="text-sm space-x-4">
        <a href="index.html" class="text-sky-600">Início</a>
        <a href="fotos.html" class="text-sky-600">Fotos & Vídeos</a>
      </nav>
    </div>
  </header>

  <main class="max-w-4xl mx-auto p-4 space-y-4">
    <section class="card">
      <h2 class="font-semibold">Adicionar local</h2>
      <p class="small">Toque no mapa para adicionar um ponto ou use o campo para pesquisar.</p>

      <div class="mt-3 grid grid-cols-1 gap-3">
        <div class="flex gap-2">
          <input id="search" class="flex-1 input card p-2" placeholder="Pesquisar endereço ou nome do local" />
          <button id="btn-search" class="badge">Procurar</button>
        </div>

        <div class="input-grid">
          <input id="place-name" placeholder="Nome do local (ex: Praia do X)" class="p-2 card" />
          <input id="place-value" placeholder="Valor (opcional)" class="p-2 card" type="number" min="0" />
          <button id="add-current" class="badge">Adicionar</button>
        </div>

        <div class="flex gap-2 items-center">
          <label class="small">Gastos gerais separados</label>
          <button id="add-general" class="text-sm text-sky-600">Adicionar gasto geral</button>
        </div>
      </div>
    </section>

    <section class="grid md:grid-cols-2 gap-4">
      <div class="card">
        <h3 class="font-semibold">Mapa</h3>
        <div id="route-controls" class="mt-3 flex gap-2 items-center">
          <label class="small">Modo:</label>
          <select id="route-mode" class="p-2 card">
            <option value="driving">Carro</option>
            <option value="foot">A Pé</option>
          </select>
          <label class="small">Consumo (km/L):</label>
          <input id="car-consumo" class="p-2 card w-24" value="12" />
          <label class="small">Preço (R$/L):</label>
          <input id="car-preco" class="p-2 card w-24" value="5.50" />
          <button id="calc-route" class="badge">Calcular rota</button>
          <div id="route-info" class="small ml-4"></div>
        </div>
        <div id="map" class="mt-3"></div>
        <div class="small mt-2">Clique nos marcadores para editar/remover. A ordem de lista define a rota.</div>
      </div>

      <div class="card">
        <h3 class="font-semibold">Locais salvos</h3>
        <div id="places-list" class="mt-3"></div>

        <h4 class="mt-4 font-semibold">Meus favoritos</h4>
        <div id="favorites-list" class="mt-2"></div>

        <h4 class="mt-4 font-semibold">Gastos gerais</h4>
        <div id="general-list" class="mt-2"></div>

        <div class="footer-summary mt-4">
          <div>
            <div class="small">Distância total</div>
            <div id="total-distance" class="text-xl font-bold">0 km</div>
          </div>
          <div>
            <div class="small">Custo total</div>
            <div id="total-cost" class="text-xl font-bold">R$ 0,00</div>
          </div>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="export-json" class="badge">Exportar JSON</button>
          <button id="clear-all" class="text-sm text-red-600">Limpar tudo</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal backdrop -->
  <div id="modal-backdrop" class="modal-backdrop" aria-hidden="true" style="display:flex">
    <div class="modal">
      <div class="flex items-center justify-between">
        <h3 id="modal-title" class="font-semibold text-lg">Detalhes do local</h3>
        <button id="modal-cancel" class="text-sm text-gray-500">✕</button>
      </div>
      <div id="modal-body" class="mt-3 small"></div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="modal-confirm" class="badge">Confirmar</button>
        <button id="modal-cancel-2" onclick="document.getElementById('modal-backdrop').classList.remove('show')" class="text-sm text-gray-500">Cancelar</button>
      </div>
    </div>
  </div>


  <footer class="max-w-4xl mx-auto p-4 text-center small">
    Desenvolvido — Melhorias rápidas para usar no celular.
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script type="module">
  import * as core from './app_mod.js';
  import { subscribePlaces, savePlace, removePlace, subscribeGeneral, saveGeneral } from './db_api.js';

  const map = L.map('map').setView([-23.5489, -46.6388], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);

  let places = [];
  let general = [];
  let markers = [];

  
function renderLists(){
    const placesDiv = document.getElementById('places-list');
    placesDiv.innerHTML='';
    places.forEach((p, idx)=>{
      const div = document.createElement('div'); div.className='list-item';
      const favs = JSON.parse(localStorage.getItem('viagem:favorites')||'{}');
      const isFav = !!favs[p.id];
      const visitedMap = JSON.parse(localStorage.getItem('viagem:visited')||'{}');
      const isVisited = !!visitedMap[p.id];
      div.innerHTML = `<div class="flex items-center justify-between">
          <div>
            <div class="font-semibold">${p.name||p.title||'Local sem nome'}</div>
            <div class="small">${p.address||''} ${p.note?'- '+p.note:''}</div>
            <div class="small"><label><input type="checkbox" class="visit-toggle" data-id="${p.id}" ${isVisited?'checked':''}/> Visitado</label></div>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn-fav" data-id="${p.id}" title="Favorito">${isFav? '★' : '☆'}</button>
            <button class="text-sm text-red-600 btn-remove" data-id="${p.id}">Remover</button>
          </div>
        </div>`;
      placesDiv.appendChild(div);
    });

    // render favorites list
    renderFavorites();

    const gen = document.getElementById('general-list');
    gen.innerHTML='';
    general.forEach((g, i)=>{
      const d = document.createElement('div'); d.className='list-item';
      d.innerHTML = `<div><div class="font-semibold">${g.title}<span class="small"> — ${core.formatCurrency(g.amount||0)}</span></div><div class="small">${g.note||''}</div><div class="mt-2"><button class="text-sm text-red-600" data-gi="${g.id}">Remover</button></div></div>`;
      gen.appendChild(d);
    });

    // markers
    markers.forEach(m=>map.removeLayer(m)); markers = [];
    places.forEach((p, idx)=>{
      const visited = JSON.parse(localStorage.getItem('viagem:visited')||'{}')[p.id];
      const color = visited ? 'green' : 'blue';
      const icon = L.divIcon({className:'custom-marker', html:`<div style="background:${color};width:14px;height:14px;border-radius:50%;border:2px solid white"></div>`, iconSize:[18,18]});
      const m = L.marker([p.lat,p.lng], {icon}).addTo(map).bindPopup(`<strong>${p.name||p.title||'Local'}</strong><div class="small">${p.address||''}</div><div class='mt-2'><button onclick="toggleVisited('${'${p.id}'}')">Marcar visitado</button></div>`);
      markers.push(m);
    });

    // attach favorite / remove handlers
    document.querySelectorAll('.btn-fav').forEach(b=>{
      b.addEventListener('click', (ev)=>{
        const id = ev.currentTarget.dataset.id;
        toggleFavorite(id);
      });
    });
    document.querySelectorAll('.btn-remove').forEach(b=>{
      b.addEventListener('click', async (ev)=>{
        const id = ev.currentTarget.dataset.id;
        if(confirm('Remover este local?')) {
          try{
            await removePlace(id);
          }catch(e){
            // if offline save pending
            const pending = JSON.parse(localStorage.getItem('viagem:pending')||'[]');
            pending.push({type:'remove', id});
    // bind visit toggles
    document.querySelectorAll('.visit-toggle').forEach(cb=> cb.addEventListener('change', (ev)=>{ toggleVisited(ev.currentTarget.dataset.id); }));

            localStorage.setItem('viagem:pending', JSON.stringify(pending));
          }
        }
      });
    });
}


// --- Routing & fuel estimation using public OSRM demo server (no API key required for small usage) ---
window.currentRouteLayer = null;
async function calculateAndDrawRoute(){
  if(!places || places.length < 2){ alert('Adicione ao menos 2 locais para calcular rota.'); return; }
  // build coordinates string: waypoints in order
  const coords = places.map(p => `${p.lng},${p.lat}`).join(';');
  const mode = document.getElementById('route-mode').value || 'driving';
  // OSRM demo endpoint (public, use lightly)
  const url = `https://router.project-osrm.org/route/v1/${mode}/${coords}?overview=full&geometries=geojson`;
  try{
    const res = await fetch(url);
    const data = await res.json();
    if(!data.routes || !data.routes.length){ alert('Rota não encontrada.'); return; }
    const route = data.routes[0];
    // remove previous
    if(window.currentRouteLayer) map.removeLayer(window.currentRouteLayer);
    // create polyline
    const geo = route.geometry;
    window.currentRouteLayer = L.geoJSON(geo, {
      style: function(feature){
        return { color: '#0077cc', weight: 5, opacity: 0.8 };
      }
    }).addTo(map);
    // zoom to route
    map.fitBounds(window.currentRouteLayer.getBounds(), {padding:[40,40]});
    // compute distance (meters) and convert to km
    const dist_km = (route.distance||0)/1000;
    // estimate fuel
    const consumo = Number(document.getElementById('car-consumo').value) || 12;
    const preco = Number(document.getElementById('car-preco').value) || 5.5;
    const litros = dist_km / consumo;
    const custo_comb = litros * preco;
    document.getElementById('route-info').innerHTML = `Distância: ${dist_km.toFixed(2)} km — Est. combustível: ${litros.toFixed(2)} L — Custo: R$ ${custo_comb.toFixed(2)}`;
  }catch(e){
    console.error(e);
    alert('Erro ao calcular rota. Verifique sua conexão.');
  }
}

document.getElementById('calc-route').addEventListener('click', calculateAndDrawRoute);

// support marking places as visited: update UI and marker color
function toggleVisited(placeId){
  const s = JSON.parse(localStorage.getItem('viagem:visited')||'{}');
  s[placeId] = !s[placeId];
  localStorage.setItem('viagem:visited', JSON.stringify(s));
  renderLists(); // re-render to update colors
}

// modify renderLists markers to color by visited state (we'll patch where markers are created)

function toggleFavorite(id){
  const favs = JSON.parse(localStorage.getItem('viagem:favorites')||'{}');
  if(favs[id]) delete favs[id];
  else favs[id]=true;
  localStorage.setItem('viagem:favorites', JSON.stringify(favs));
  renderFavorites();
  renderLists();
}

function renderFavorites(){
  const favs = JSON.parse(localStorage.getItem('viagem:favorites')||'{}');
  const favDiv = document.getElementById('favorites-list');
  favDiv.innerHTML='';
  Object.keys(favs).forEach(fid=>{
    const place = places.find(p=>p.id===fid);
    if(place){
      const d = document.createElement('div'); d.className='list-item';
      d.innerHTML = `<div class="flex items-center justify-between"><div><div class="font-semibold">${place.name||place.title}</div><div class="small">${place.address||''}</div></div><div><button class="text-sm" data-id="${fid}" onclick="window.focusPlace && window.focusPlace('${fid}')">Ir para</button></div></div>`;
      favDiv.appendChild(d);
    }
  });
}


</script>


</body>
</html>
