<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Roteiro de Viagem</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            travel: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            }
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
    }
    #map {
      height: 300px;
      width: 100%;
      border-radius: 16px;
    }
    @media (min-width: 768px) {
      #map {
        height: 400px;
      }
    }
    .place-item {
      transition: all 0.3s ease;
    }
    .place-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPkjcgFgdopkeZN0GnvhOc787jrajJnWc&libraries=places,directions&callback=initMap" async defer></script>
</head>
<body class="bg-travel-50">
  <!-- Cabeçalho -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-travel-700">Roteiro de Viagem</h1>
      <nav class="flex gap-4">
        <a href="fotos.html" class="text-travel-600 font-medium">Fotos</a>
        <a href="index.html" class="text-gray-500">Sair</a>
      </nav>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6 max-w-3xl">
    <!-- Mapa Google -->
    <div class="card bg-white p-4 mb-6 shadow-md rounded-xl">
      <h2 class="text-lg font-semibold text-travel-800 mb-3">Mapa da Viagem</h2>
      <div id="map"></div>
      <div class="flex justify-between mt-3">
        <button id="optimize-route" class="bg-travel-100 text-travel-700 px-4 py-2 rounded-lg font-medium hover:bg-travel-200 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
          </svg>
          Otimizar Rota
        </button>
        <button id="clear-route" class="text-red-500 px-4 py-2 rounded-lg border border-red-200 hover:bg-red-50 transition">
          Limpar Tudo
        </button>
      </div>
    </div>

    <!-- Adicionar Local -->
    <div class="card bg-white p-5 mb-6 shadow-md rounded-xl">
      <h2 class="text-lg font-semibold text-travel-800 mb-4">Adicionar Local</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Pesquisar local...</label>
          <div class="relative">
            <input id="search" type="text" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-travel-300 focus:border-travel-300">
            <button id="btn-search" class="absolute right-2 top-2 bg-travel-500 text-white p-2 rounded-lg">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
              </svg>
            </button>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Local</label>
            <input id="place-name" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-travel-300">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Custo (R$)</label>
            <input id="place-value" type="number" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-travel-300">
          </div>
        </div>
        
        <button id="add-place" class="w-full bg-travel-600 text-white py-3 rounded-lg font-medium hover:bg-travel-700 transition flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
          </svg>
          Adicionar Local
        </button>
      </div>
    </div>

    <!-- Locais Salvos -->
    <div class="card bg-white p-5 mb-6 shadow-md rounded-xl">
      <h2 class="text-lg font-semibold text-travel-800 mb-4">Locais Salvos</h2>
      <div id="places-list" class="space-y-3"></div>
    </div>

    <!-- Resumo -->
    <div class="card bg-white p-5 shadow-md rounded-xl">
      <h2 class="text-lg font-semibold text-travel-800 mb-4">Resumo da Viagem</h2>
      <div class="grid grid-cols-3 gap-4 mb-4">
        <div class="bg-travel-50 p-3 rounded-lg text-center">
          <p class="text-sm text-gray-600">Distância</p>
          <p id="total-distance" class="text-xl font-bold text-travel-700">0 km</p>
        </div>
        <div class="bg-travel-50 p-3 rounded-lg text-center">
          <p class="text-sm text-gray-600">Tempo</p>
          <p id="total-time" class="text-xl font-bold text-travel-700">0 min</p>
        </div>
        <div class="bg-travel-50 p-3 rounded-lg text-center">
          <p class="text-sm text-gray-600">Custo</p>
          <p id="total-cost" class="text-xl font-bold text-travel-700">R$ 0</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Variáveis globais
    let map;
    let directionsService;
    let directionsRenderer;
    let markers = [];
    let places = [];
    let infoWindow;

    // Inicialização do mapa
    function initMap() {
      console.log("Inicializando mapa...");
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: -15.795, lng: -47.891 }, // Centro no Brasil
        zoom: 4,
        styles: [
          {
            featureType: "poi",
            elementType: "labels",
            stylers: [{ visibility: "off" }]
          },
          {
            featureType: "transit",
            elementType: "labels.icon",
            stylers: [{ visibility: "off" }]
          },
          {
            featureType: "water",
            elementType: "geometry",
            stylers: [{ color: "#7dd3fc" }]
          },
          {
            featureType: "landscape",
            elementType: "geometry",
            stylers: [{ color: "#f0f9ff" }]
          },
          {
            featureType: "road",
            elementType: "geometry",
            stylers: [{ color: "#ffffff" }]
          },
          {
            featureType: "road",
            elementType: "labels.text.fill",
            stylers: [{ color: "#64748b" }]
          }
        ]
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map: map,
        suppressMarkers: true,
        polylineOptions: {
          strokeColor: '#0ea5e9',
          strokeOpacity: 0.8,
          strokeWeight: 5
        }
      });

      infoWindow = new google.maps.InfoWindow();

      // Adicionar listener para clique no mapa
      map.addListener('click', (e) => {
        document.getElementById('place-name').focus();
      });

      // Carregar locais salvos
      loadPlaces();
    }

    // Carregar locais do localStorage
    function loadPlaces() {
      const saved = localStorage.getItem('travel_places');
      if (saved) {
        places = JSON.parse(saved);
        renderPlaces();
        updateRoute();
      }
    }

    // Salvar locais no localStorage
    function savePlaces() {
      localStorage.setItem('travel_places', JSON.stringify(places));
    }

    // Renderizar lista de locais
    function renderPlaces() {
      const container = document.getElementById('places-list');
      container.innerHTML = '';

      if (places.length === 0) {
        container.innerHTML = `
          <div class="text-center py-4 text-gray-500">
            Nenhum local adicionado ainda
          </div>
        `;
        return;
      }

      places.forEach((place, index) => {
        const div = document.createElement('div');
        div.className = 'place-item bg-travel-50 p-4 rounded-lg border border-travel-100';
        div.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <h3 class="font-semibold text-travel-800">${place.name}</h3>
              ${place.value ? `<p class="text-sm text-travel-600">R$ ${place.value.toFixed(2)}</p>` : ''}
              ${place.address ? `<p class="text-xs text-gray-500 mt-1">${place.address}</p>` : ''}
            </div>
            <div class="flex gap-2">
              <button data-index="${index}" class="move-up text-travel-600 hover:text-travel-800 p-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
              </button>
              <button data-index="${index}" class="move-down text-travel-600 hover:text-travel-800 p-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </button>
              <button data-index="${index}" class="delete-place text-red-500 hover:text-red-700 p-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
              </button>
            </div>
          </div>
        `;
        container.appendChild(div);
      });

      updateStats();
    }

    // Atualizar rota no mapa
    function updateRoute() {
      console.log("Atualizando rota...");
      
      // Limpar marcadores antigos
      markers.forEach(marker => marker.setMap(null));
      markers = [];

      if (places.length === 0) {
        directionsRenderer.setMap(null);
        return;
      }

      // Adicionar marcadores personalizados
      places.forEach((place, index) => {
        const marker = new google.maps.Marker({
          position: { lat: place.lat, lng: place.lng },
          map: map,
          label: {
            text: (index + 1).toString(),
            color: 'white',
            fontSize: '14px',
            fontWeight: 'bold'
          },
          icon: {
            url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
            scaledSize: new google.maps.Size(40, 40),
            labelOrigin: new google.maps.Point(20, 13)
          }
        });

        // InfoWindow ao clicar no marcador
        marker.addListener('click', () => {
          infoWindow.setContent(`
            <div class="p-2">
              <h3 class="font-bold text-lg">${place.name}</h3>
              ${place.value ? `<p class="text-travel-600">Custo: R$ ${place.value.toFixed(2)}</p>` : ''}
              ${place.address ? `<p class="text-sm text-gray-600 mt-1">${place.address}</p>` : ''}
            </div>
          `);
          infoWindow.open(map, marker);
        });

        markers.push(marker);
      });

      // Se apenas um local, centralizar nele
      if (places.length === 1) {
        map.setCenter(markers[0].getPosition());
        map.setZoom(14);
        directionsRenderer.setMap(null);
        return;
      }

      // Para múltiplos locais, calcular rota
      if (places.length >= 2) {
        const waypoints = places.slice(1, -1).map(place => ({
          location: { lat: place.lat, lng: place.lng },
          stopover: true
        }));

        const request = {
          origin: { lat: places[0].lat, lng: places[0].lng },
          destination: { lat: places[places.length - 1].lat, lng: places[places.length - 1].lng },
          waypoints: waypoints,
          travelMode: 'DRIVING',
          optimizeWaypoints: true,
          provideRouteAlternatives: false
        };

        directionsService.route(request, (result, status) => {
          if (status === 'OK') {
            directionsRenderer.setDirections(result);
            
            // Ajustar o zoom para mostrar toda a rota
            const bounds = new google.maps.LatLngBounds();
            result.routes[0].legs.forEach(leg => {
              bounds.extend(leg.start_location);
              bounds.extend(leg.end_location);
            });
            map.fitBounds(bounds);
            
            updateStats(result);
          } else {
            console.error("Erro ao calcular rota:", status);
          }
        });
      }
    }

    // Atualizar estatísticas
    function updateStats(routeResult) {
      if (routeResult) {
        const route = routeResult.routes[0];
        let totalDistance = 0;
        let totalTime = 0;

        route.legs.forEach(leg => {
          totalDistance += leg.distance.value;
          totalTime += leg.duration.value;
        });

        document.getElementById('total-distance').textContent = 
          (totalDistance / 1000).toFixed(1) + ' km';
        document.getElementById('total-time').textContent = 
          Math.round(totalTime / 60) + ' min';
      }

      const totalCost = places.reduce((sum, place) => sum + (place.value || 0), 0);
      document.getElementById('total-cost').textContent = 'R$ ' + totalCost.toFixed(2);
    }

    // Event Listeners
    document.getElementById('add-place').addEventListener('click', () => {
      const name = document.getElementById('place-name').value.trim();
      const value = parseFloat(document.getElementById('place-value').value) || 0;

      if (!name) {
        alert('Por favor, digite um nome para o local');
        return;
      }

      const center = map.getCenter();
      const newPlace = {
        name,
        value,
        lat: center.lat(),
        lng: center.lng(),
        address: document.getElementById('search').value || ''
      };

      places.push(newPlace);
      savePlaces();
      renderPlaces();
      updateRoute();

      // Limpar campos
      document.getElementById('place-name').value = '';
      document.getElementById('place-value').value = '';
      document.getElementById('search').value = '';
    });

    document.getElementById('btn-search').addEventListener('click', () => {
      const query = document.getElementById('search').value.trim();
      if (!query) return;

      const request = {
        query,
        fields: ['name', 'geometry', 'formatted_address']
      };

      const service = new google.maps.places.PlacesService(map);
      service.findPlaceFromQuery(request, (results, status) => {
        if (status === 'OK' && results[0]) {
          const place = results[0];
          map.setCenter(place.geometry.location);
          
          // Preencher automaticamente o nome do local
          document.getElementById('place-name').value = place.name;
          
          // Mostrar o endereço completo no campo de pesquisa
          if (place.formatted_address) {
            document.getElementById('search').value = place.formatted_address;
          }
        } else {
          console.error("Erro na pesquisa:", status);
        }
      });
    });

    document.getElementById('places-list').addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;

      const index = parseInt(btn.dataset.index);
      if (isNaN(index)) return;

      if (btn.classList.contains('delete-place')) {
        if (confirm('Remover este local?')) {
          places.splice(index, 1);
        }
      } 
      else if (btn.classList.contains('move-up') && index > 0) {
        [places[index], places[index - 1]] = [places[index - 1], places[index]];
      }
      else if (btn.classList.contains('move-down') && index < places.length - 1) {
        [places[index], places[index + 1]] = [places[index + 1], places[index]];
      }

      savePlaces();
      renderPlaces();
      updateRoute();
    });

    document.getElementById('optimize-route').addEventListener('click', () => {
      if (places.length < 2) {
        alert('Adicione pelo menos 2 locais para otimizar a rota');
        return;
      }
      updateRoute();
    });

    document.getElementById('clear-route').addEventListener('click', () => {
      if (places.length > 0 && confirm('Tem certeza que deseja limpar toda a rota?')) {
        places = [];
        savePlaces();
        renderPlaces();
        updateRoute();
      }
    });

    // Permitir pesquisa ao pressionar Enter
    document.getElementById('search').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('btn-search').click();
      }
    });

    // Verificar se o mapa foi carregado
    window.addEventListener('load', () => {
      if (typeof google === 'undefined') {
        console.error("Google Maps API não carregou corretamente");
        alert("Erro ao carregar o mapa. Verifique sua conexão com a internet.");
      }
    });
  </script>
</body>
</html>